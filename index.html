<!doctype html>
<html lang="en" class="min-h-full bg-gray-100 dark:bg-gray-900">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WealthTrack</title>
    <meta name="theme-color" content="#111827" />
    <link rel="manifest" href="manifest.webmanifest" />
    <link rel="icon" href="assets/icons/app-logo.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" href="assets/icons/app-logo.svg" />

    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Font Awesome for icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Tailwind + Chart libs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
      tailwind.config = { darkMode: "class" };
    </script>

    <!-- Component classes -->
    <style type="text/tailwindcss">
      @layer base {
        body {
          font-family: "Inter", sans-serif;
        }
      }

      @layer components {
        /* cards, labels, inputs */
        .card {
          @apply bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 mb-6 transition-colors duration-200;
        }
        .card.is-collapsible.collapsed {
          @apply bg-gray-50 dark:bg-gray-700 pb-0;
        }
        .card.is-collapsible.collapsed:hover {
          @apply bg-gray-100 dark:bg-gray-600;
        }
        .card.is-collapsible h3,
        .card.is-collapsible h4 {
          @apply -mx-6 -mt-6 px-6 pt-6 pb-6 rounded-t-2xl;
          cursor: pointer;
          display: flex;
          align-items: center;
        }
        .card.is-collapsible .chev {
          margin-left: auto;
          transition: transform 0.2s ease;
        }
        .card.is-collapsible.collapsed .chev {
          transform: rotate(-90deg);
        }
        .card.is-collapsible .card-body {
          overflow: visible;
          transition:
            height 0.25s ease,
            opacity 0.2s ease;
        }
        .card.is-collapsible.collapsed .card-body {
          overflow: hidden;
        }
        .card.is-collapsible.collapsed h3,
        .card.is-collapsible.collapsed h4 {
          margin-bottom: 0 !important;
        }
        /* Tighter spacing between title and content when expanded */
        .card.is-collapsible:not(.collapsed) > h3,
        .card.is-collapsible:not(.collapsed) > h4 {
          margin-bottom: 0.5rem;
          padding-bottom: 0.75rem;
        }
        .form-label,
        .label {
          @apply block text-gray-700 dark:text-gray-300 text-sm font-medium mb-1;
        }
        .input-field {
          @apply w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500;
        }

        /* date inputs: keep native picker; subtle tweaks */
        input[type="date"].input-field {
          @apply pr-3;
        }
        input[type="date"].input-field::-webkit-calendar-picker-indicator {
          cursor: pointer;
          filter: invert(35%);
          opacity: 0.85;
        }
        .dark
          input[type="date"].input-field::-webkit-calendar-picker-indicator {
          filter: invert(80%);
          opacity: 0.9;
        }

        /* tables */
        .table-header {
          @apply px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider;
        }
        .sort-arrow {
          @apply inline-block w-3 text-[10px] text-gray-400 dark:text-gray-400;
        }

        /* buttons */
        .btn {
          @apply px-4 py-2 font-semibold rounded-lg shadow-md transition-colors duration-300;
        }
        .btn:disabled {
          @apply opacity-50 cursor-not-allowed;
        }
        .btn-block {
          @apply w-full;
        }
        .btn-green {
          @apply bg-green-500 hover:bg-green-600 text-white;
        }
        .btn-blue {
          @apply bg-blue-500 hover:bg-blue-600 text-white;
        }
        .btn-purple {
          @apply bg-purple-600 hover:bg-purple-700 text-white;
        }
        .btn-gray {
          @apply bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 hover:bg-gray-400 dark:hover:bg-gray-500;
        }
        .btn-red {
          @apply bg-red-500 hover:bg-red-600 text-white;
        }
        .btn-icon {
          @apply text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200;
        }

        /* simple fade-in animation for newly revealed UI */
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(4px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .fade-in {
          animation: fadeIn 0.3s ease-out;
        }

        /* fade between light and dark themes */
        .theme-transition,
        .theme-transition * {
          transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* nav buttons */
        .nav-btn {
          @apply w-full text-left px-4 py-3 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 font-medium transition duration-300 mb-2;
        }

        /* tabs */
        .tab-btn {
          @apply px-4 py-2 font-medium text-gray-500 dark:text-gray-400 border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600;
        }
        .tab-btn-active {
          @apply border-blue-500 text-blue-500 dark:text-blue-400 dark:border-blue-400;
        }

        /* modals */
        .modal-overlay {
          position: fixed;
          inset: 0;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: flex-start;
          justify-content: center;
          padding-top: 1rem;
          padding-bottom: 1rem;
          z-index: 1000;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch;
        }
        .modal-panel {
          position: relative;
          margin-top: auto;
          margin-bottom: auto;
          max-width: 42rem;
          width: 100%;
          background: #ffffff;
          border-radius: 1rem;
          padding: 1.5rem;
          box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
        }
        .dark .modal-panel {
          background: #1f2937;
        }
        .modal-panel .input-field {
          width: calc(100% - 0.5rem);
        }
        .modal-hidden {
          @apply hidden;
        }
      }

      /* small utilities */
      .chart-container {
        width: 100%;
        height: 400px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .content-section {
        display: none;
      }
      .content-section.active {
        display: block;
      }

      /* required asterisk */
      .required-label:after {
        content: "*";
        color: #ef4444;
        margin-left: 0.25rem;
      }

      /* Theming variables (light/dark defaults) */
      :root {
        --accent: #10b981;
        --accent-hover: #059669;
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
        --card-filter: none;
      }
      .dark {
        --card-bg: #1f2937;
        --card-border: #374151;
      }

      /* Theme: Inverted (based on pastel)
       Light mode: dark canvas + light cards + light sidebar
       Dark mode: light canvas + light cards + light sidebar */
      .theme-inverted:not(.dark) body {
        background: linear-gradient(180deg, #1f2937, #111827) !important;
      }
      .theme-inverted.dark body {
        background: linear-gradient(180deg, #f8fafc, #eef2ff) !important;
      }
      .theme-inverted #sidebar {
        background: #ffffff !important;
        color: #1f2937 !important;
        border-color: #e5e7eb !important;
      }
      .theme-inverted #sidebar .nav-btn {
        color: #4b5563 !important;
      }
      .theme-inverted #sidebar .nav-btn:hover {
        background-color: #e5e7eb !important;
      }
      /* In dark mode, invert the nav to dark with white text/icons */
      .theme-inverted.dark #sidebar {
        background: #1f2937 !important;
        color: #f9fafb !important;
        border-color: #374151 !important;
      }
      .theme-inverted.dark #sidebar .nav-btn {
        color: #e5e7eb !important;
      }
      .theme-inverted.dark #sidebar .nav-btn:hover {
        background-color: #374151 !important;
      }
      .theme-inverted.dark #sidebar svg,
      .theme-inverted.dark #sidebar i {
        color: #ffffff !important;
      }
      /* Page headings should be light on dark canvas */
      .theme-inverted:not(.dark) h2 {
        color: #e2e8f0 !important;
      }
      /* Card titles should remain dark on light cards */
      .theme-inverted:not(.dark) .card h3,
      .theme-inverted:not(.dark) .card h4 {
        color: #111827 !important;
      }
      .theme-inverted.dark h2,
      .theme-inverted.dark h3 {
        color: #111827 !important;
      }
      /* Card titles on dark cards need light text in dark mode */
      .theme-inverted.dark .card h3,
      .theme-inverted.dark .card h4 {
        color: #f3f4f6 !important;
      }
      /* Modal titles should be light on dark modal background in inverted dark mode */
      .theme-inverted.dark .modal-panel h2,
      .theme-inverted.dark .modal-panel h3,
      .theme-inverted.dark .modal-panel h4,
      .theme-inverted.dark .modal-panel h5 {
        color: #f3f4f6 !important;
      }

      /* Theme: Glass - frosted glass cards and sidebar */
      .theme-glass:not(.dark) {
        --card-bg: rgba(255, 255, 255, 0.25);
        --card-border: rgba(255, 255, 255, 0.4);
        --card-filter: blur(20px) saturate(180%);
        --card-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      }
      .theme-glass.dark {
        --card-bg: rgba(17, 24, 39, 0.4);
        --card-border: rgba(255, 255, 255, 0.15);
        --card-filter: blur(20px) saturate(180%);
        --card-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
      }
      .theme-glass:not(.dark) body {
        background: linear-gradient(135deg, #e6e9ec, #7777938d) !important;
      }
      .theme-glass.dark body {
        background: linear-gradient(10deg, #808889, #2b343a) !important;
      }
      .theme-glass #sidebar {
        background-color: var(--card-bg) !important;
        border-color: var(--card-border) !important;
        backdrop-filter: var(--card-filter);
        -webkit-backdrop-filter: var(--card-filter);
        box-shadow: var(--card-shadow);
      }
      @media (max-width: 767px) {
        /* Match desktop styling on mobile for glass theme */
        .theme-glass #sidebar {
          background-color: var(--card-bg) !important;
          border-color: var(--card-border) !important;
          backdrop-filter: var(--card-filter);
          -webkit-backdrop-filter: var(--card-filter);
          box-shadow: var(--card-shadow);
        }
      }

      /* Glass theme: ensure light mobile overlay matches desktop */
      .theme-glass:not(.dark) #overlay {
        background-color: rgba(255, 255, 255, 0.5) !important;
      }
      .theme-glass.dark #overlay {
        background-color: rgba(0, 0, 0, 0.5) !important;
      }

      /* Glass theme: force white inputs in dark mode */
      .theme-glass.dark .input-field {
        background-color: #ffffff !important;
        color: #111827 !important;
      }
      .theme-glass.dark .input-field::placeholder {
        color: #6b7280 !important;
      }
      /* Date picker icon should not be inverted on white inputs */
      .theme-glass.dark
        input[type="date"].input-field::-webkit-calendar-picker-indicator {
        filter: none;
        opacity: 0.85;
      }

      /* Glass theme: make small stat boxes dark in dark mode */
      .theme-glass.dark .stat-box {
        background-color: rgba(31, 41, 55, 0.85) !important;
        color: #f3f4f6 !important;
        border: 1px solid rgba(255, 255, 255, 0.1);
        -webkit-backdrop-filter: var(--card-filter);
        backdrop-filter: var(--card-filter);
      }
      /* Preserve Tailwind text-* utilities (e.g., text-green-500/red-600) */
      .theme-glass.dark .stat-box p:not([class*="text-"]),
      .theme-glass.dark .stat-box li:not([class*="text-"]) {
        color: #f3f4f6 !important;
      }
      .theme-glass.dark .stat-box h4,
      .theme-glass.dark .stat-box h5,
      .theme-glass.dark .stat-box label {
        color: #f3f4f6 !important;
      }

      /* Glass theme: stronger sidebar nav hover contrast */
      /* Dark mode: light hover bg with dark text/icons */
      .theme-glass.dark #sidebar .nav-btn:hover {
        background-color: #f3f4f6 !important;
        color: #111827 !important;
      }
      .theme-glass.dark #sidebar .nav-btn:hover svg,
      .theme-glass.dark #sidebar .nav-btn:hover i {
        color: #111827 !important;
      }
      /* Light mode: dark hover bg with light text/icons */
      .theme-glass:not(.dark) #sidebar .nav-btn:hover {
        background-color: #374151 !important;
        color: #f9fafb !important;
      }
      .theme-glass:not(.dark) #sidebar .nav-btn:hover svg,
      .theme-glass:not(.dark) #sidebar .nav-btn:hover i {
        color: #f9fafb !important;
      }

      /* Apply variables to core components */
      .card {
        background-color: var(--card-bg) !important;
        border-color: var(--card-border) !important;
        backdrop-filter: var(--card-filter);
        -webkit-backdrop-filter: var(--card-filter);
        box-shadow: var(--card-shadow);
      }
      /* Themed tip: match current card styling */
      .themed-tip {
        background-color: var(--card-bg) !important;
        border-color: var(--card-border) !important;
        backdrop-filter: var(--card-filter);
        -webkit-backdrop-filter: var(--card-filter);
      }
      .btn-green {
        background-color: var(--accent) !important;
      }
      .btn-green:hover {
        background-color: var(--accent-hover) !important;
      }
      /* Keep toggles default; no theme-driven colour here */

      /* dark mode toggle */
      .dark-mode-toggle {
        display: flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
      }
      .dark-mode-toggle input[type="checkbox"] {
        display: none;
      }
      .dark-mode-toggle .toggle-track {
        width: 56px;
        height: 28px;
        background-color: #d1d5db;
        border-radius: 9999px;
        position: relative;
        transition: background-color 0.3s;
      }
      .dark .dark-mode-toggle .toggle-track {
        background-color: #4b5563;
      }
      .dark-mode-toggle input[type="checkbox"]:checked + .toggle-track {
        background-color: #10b981;
      }
      .dark-mode-toggle .toggle-thumb {
        width: 24px;
        height: 24px;
        background-color: #fff;
        border-radius: 9999px;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }
      .dark-mode-toggle
        input[type="checkbox"]:checked
        + .toggle-track
        .toggle-thumb {
        transform: translateX(28px);
      }

      /* brand sizing helper (JS sets width to title width on desktop) */
      #brandTitle {
        display: inline-block;
      }
      @media (min-width: 768px) {
        #brandLogo {
          max-width: 100%;
          display: block;
        }
      }
    </style>
  </head>

  <body
    class="min-h-screen flex flex-col md:flex-row bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200"
  >
    <!-- SVG sprite: app logo + small icons -->
    <svg aria-hidden="true" width="0" height="0" style="position: absolute">
      <defs>
        <symbol id="app-logo" viewBox="200 100 600 600">
          <!-- original complex logo paths, defined once -->
          <g transform="translate(0,-48)">
            <path
              d="M587.900757,611.713379 C582.531250,617.927246 576.260925,620.500854 568.486694,618.308960 C561.069336,616.217651 557.079529,611.054565 556.165894,603.598694 C555.788025,600.515076 554.164429,599.443726 551.471436,598.752075 C520.039001,590.679199 488.618103,582.560791 457.215668,574.371948 C454.213562,573.589111 452.225494,573.766846 449.922821,576.451599 C445.991608,581.034973 440.422089,582.590454 434.495728,581.379456 C431.218231,580.709717 429.376495,581.611633 427.431824,584.246216 C408.432831,609.985718 389.319183,635.640808 370.175354,661.273071 C368.530060,663.476013 368.064545,665.370178 369.049316,668.119873 C371.345184,674.530640 369.260193,681.311523 364.455841,684.679382 C359.644836,688.051819 352.723969,687.924805 348.059021,684.378723 C343.302795,680.763184 341.368561,673.930054 343.471436,668.172119 C345.687988,662.102905 351.039673,658.641541 358.035614,659.301758 C360.487213,659.533142 361.704163,658.631592 362.977112,656.907349 C382.276489,630.765259 401.589783,604.633423 420.963409,578.546387 C422.461304,576.529358 422.586121,574.962585 421.337860,572.708862 C417.547241,565.864746 418.226562,559.069580 423.169403,553.156799 C427.658356,547.786987 433.687012,545.669617 440.688843,547.350647 C448.283905,549.174072 452.817108,554.066040 454.171478,561.700195 C454.565674,563.922119 455.126160,565.228271 457.548645,565.852844 C488.006470,573.705811 518.436096,581.668030 548.877258,589.585876 C549.312073,589.698914 549.802002,589.599976 551.272644,589.599976 C534.485657,577.505920 518.423523,565.961670 502.406586,554.354980 C500.673767,553.099243 499.434418,553.882263 497.861359,554.606323 C485.694794,560.206604 473.420807,551.944885 474.209869,538.547485 C474.362335,535.958984 473.597321,534.490906 471.700073,533.127991 C464.798126,528.169922 457.906921,523.196228 451.062256,518.159668 C449.133301,516.740295 447.370148,516.209656 445.154816,517.624939 C443.323059,518.795288 441.153259,519.710144 438.990509,519.315491 C433.354706,518.287048 430.712341,521.429321 428.091583,525.769592 C420.514099,538.318665 412.604736,550.668823 404.712921,563.025146 C403.251373,565.313477 402.831055,567.166321 403.907898,569.903442 C406.752350,577.133728 403.054718,584.201843 395.969086,585.948914 C389.718170,587.490112 383.287354,583.043579 381.999146,576.289612 C380.688232,569.416260 385.629333,563.214111 393.155914,562.804871 C395.931152,562.653992 397.302277,561.400879 398.618042,559.280762 C406.964783,545.831238 415.351990,532.406433 423.832001,519.040710 C425.168823,516.933716 425.391144,515.585022 423.616669,513.416382 C417.723969,506.214691 417.610321,497.785248 422.867310,490.898010 C427.359436,485.012878 436.639282,482.692169 443.724701,485.682007 C451.370544,488.908386 455.705566,496.411438 454.207886,505.203217 C453.597412,508.786926 454.502533,510.655762 457.321777,512.567139 C463.525665,516.773315 469.562439,521.230408 475.591492,525.687744 C477.957611,527.437012 479.885376,527.820557 482.777893,526.235596 C493.760925,520.217468 506.508636,527.859619 506.199371,540.453857 C506.080170,545.309631 507.797516,548.001221 511.538452,550.628601 C527.354797,561.736816 543.007080,573.079163 558.680786,584.389404 C561.284729,586.268433 563.637939,587.298340 566.863098,585.437988 C569.285400,584.040649 572.293152,583.317078 575.084473,584.223816 C579.031250,585.505920 581.171143,583.857788 583.320862,580.738342 C604.028259,550.689758 624.810669,520.692627 645.656372,490.739746 C657.743225,473.372528 669.941284,456.082092 682.211731,438.844208 C683.759644,436.669556 684.112549,435.137573 682.762390,432.638580 C679.447266,426.502563 680.630310,420.311523 685.452637,415.817535 C690.146057,411.443695 697.269775,410.832245 703.059387,414.306183 C707.978210,417.257660 710.484497,423.613617 709.071411,429.552765 C707.584167,435.803406 702.455322,440.225830 695.684998,440.201935 C692.145569,440.189453 690.291687,441.643402 688.446838,444.310608 C660.867310,484.185944 633.214783,524.010864 605.574097,563.843933 C600.159607,571.646729 594.753845,579.456055 589.273010,587.212158 C587.949585,589.084900 587.101929,590.580750 588.561340,593.001038 C592.252197,599.121826 591.871216,605.359314 587.900757,611.713379 z"
            />
            <path
              d="M645.847168,406.794556 C623.373108,446.181458 601.090149,485.254822 578.769653,524.306824 C577.237671,526.987183 576.201904,529.162659 578.139648,532.468567 C582.468933,539.854553 581.307434,547.820923 575.833069,553.714417 C570.880127,559.046631 561.875061,560.710632 555.058655,557.553223 C548.149902,554.353027 544.321228,547.064697 545.381897,538.509155 C545.677185,536.127625 544.923218,534.767151 543.098389,533.511353 C510.156647,510.840851 477.222290,488.159454 444.328888,465.418915 C441.928741,463.759552 439.966888,463.682220 437.557190,465.360962 C434.249786,467.665100 430.331207,468.304565 426.548584,467.238678 C423.155609,466.282623 421.468079,467.516235 419.583557,470.087219 C397.816528,499.783447 375.950378,529.407043 354.103485,559.044678 C352.225830,561.591919 350.354614,564.147217 348.381348,566.619690 C344.879486,571.007568 342.251343,574.836487 344.106537,581.562317 C346.434143,590.000793 339.057587,597.661011 330.316010,598.050476 C322.826385,598.384216 315.930481,591.628052 315.807556,583.836060 C315.678009,575.627808 322.432068,569.004700 331.071838,569.522095 C334.432587,569.723389 336.276154,568.595215 338.109589,566.109802 C362.640991,532.855530 387.233917,499.646698 411.812103,466.426971 C413.705780,463.867493 415.306000,461.782440 413.102203,458.039551 C409.033722,451.129639 410.303253,444.032440 415.479858,438.117188 C420.205231,432.717529 426.422333,430.528168 433.549927,432.709381 C441.410980,435.115051 445.866272,440.910248 446.304718,449.292755 C446.440460,451.888184 447.421356,453.128387 449.803528,453.970123 C473.193451,462.235199 496.557129,470.574738 519.911133,478.940826 C521.975525,479.680328 523.649902,479.796600 525.343933,478.053131 C529.278381,474.003845 534.277344,472.812927 539.597412,473.984741 C542.463379,474.616058 543.927917,473.548492 545.472534,471.582458 C563.897095,448.130676 582.338684,424.692261 600.818176,401.283875 C602.316406,399.386047 602.560913,397.716705 601.698547,395.355835 C599.885498,390.392548 601.822327,384.864807 605.874329,382.085693 C610.139954,379.160034 615.172546,379.371216 619.326416,382.650177 C623.316223,385.799591 624.809204,391.331512 622.975342,396.170654 C621.137268,401.021179 617.018005,403.876862 611.589966,403.152374 C608.536499,402.744843 607.115479,403.894714 605.450745,406.050049 C587.425659,429.387238 569.333923,452.673218 551.176819,475.907867 C549.480835,478.078156 548.881104,479.765778 550.019714,482.588531 C553.597595,491.459076 549.752686,500.274445 541.526550,503.027283 C532.428162,506.071991 524.094971,501.528046 521.647766,491.898987 C520.903320,488.969696 519.521179,487.382050 516.668091,486.407959 C499.674011,480.605957 482.732361,474.650421 464.835754,468.420135 C468.558899,472.246429 472.328583,474.456207 475.885620,476.917603 C499.451324,493.224640 523.069214,509.456726 546.567871,525.859619 C549.430542,527.857849 551.560974,528.218567 554.518921,526.144348 C557.267029,524.217163 560.736328,523.213989 564.051758,523.911133 C568.026978,524.747009 569.751526,522.877075 571.483765,519.819519 C587.826355,490.972778 604.200989,462.143707 620.698486,433.385315 C635.289673,407.949860 650.009155,382.587555 664.791687,357.262787 C666.391785,354.521576 666.691040,352.458984 665.042664,349.534271 C661.516357,343.277527 662.631226,336.811554 667.413086,332.184540 C671.860840,327.880859 678.510620,327.084869 684.022705,330.196289 C689.662415,333.379761 692.553467,339.996887 691.125732,346.454163 C689.748840,352.681793 684.533875,356.883179 677.143188,356.943787 C674.199890,356.967926 673.484985,358.735931 672.438904,360.551178 C663.621460,375.851257 654.829163,391.165802 645.847168,406.794556 z"
            />
            <path
              d="M351.283569,612.216187 C361.176727,615.257935 366.089233,623.527161 363.727631,632.613647 C361.539124,641.033997 353.371582,646.354858 345.235413,644.660583 C335.763916,642.688232 330.335876,634.810303 331.786469,625.141541 C333.129120,616.192200 340.613281,611.078552 351.283569,612.216187 z"
            />
            <path
              d="M580.933899,463.609802 C580.774170,458.784332 582.511047,455.803009 587.319641,455.690369 C591.036011,455.603271 593.212463,457.809631 593.712524,461.304993 C594.257202,465.112823 592.344238,467.735870 588.635315,468.609711 C584.773865,469.519501 582.376587,467.493103 580.933899,463.609802 z"
            />
            <path
              d="M624.820068,486.184692 C620.538818,486.240936 618.184265,484.247253 617.514038,480.526031 C616.955505,477.425018 618.387939,475.074402 621.105774,473.571075 C623.810120,472.075226 626.284546,472.894257 628.366577,474.782501 C632.091858,478.160950 630.615784,483.317688 624.820068,486.184692 z"
            />
            <path
              d="M391.873718,527.048096 C390.763000,523.225403 391.684784,520.437134 394.838593,518.588684 C397.055603,517.289307 399.327179,517.486511 401.432251,518.902344 C403.928925,520.581665 404.667267,523.046143 404.150177,525.890869 C403.688965,528.427917 402.036316,530.017212 399.609741,530.686279 C396.250580,531.612366 393.812439,530.197021 391.873718,527.048096 z"
            />
            <path
              d="M376.900909,547.086853 C377.782318,542.789551 379.997437,540.384094 384.199707,540.901733 C387.570831,541.316895 389.516357,543.626709 389.778229,546.937622 C390.044281,550.300964 388.250214,552.625793 385.082672,553.702576 C381.271088,554.998474 378.415314,552.776794 376.900909,547.086853 z"
            />
            <path
              d="M602.566406,534.441406 C599.350708,538.046082 596.109924,537.610718 593.234192,534.897156 C590.414062,532.236206 590.554688,528.900452 592.847473,525.955811 C594.970642,523.229004 598.030029,522.828308 600.818420,524.668274 C604.375671,527.015564 605.023621,530.370178 602.566406,534.441406 z"
            />
            <path
              d="M608.817993,496.823425 C612.989502,497.971619 614.722839,500.513824 614.136597,504.368530 C613.728210,507.053802 612.175964,508.960663 609.283020,509.295197 C605.448608,509.738586 602.707031,508.274719 601.860535,504.350220 C601.046753,500.577240 603.557007,497.804993 608.817993,496.823425 z"
            />
            <path
              d="M534.781982,435.590393 C537.792664,430.259430 540.605591,428.946350 543.762695,431.355835 C546.098206,433.138245 547.823364,435.435760 546.535767,438.637238 C545.336548,441.619019 542.936157,443.089111 539.812378,442.551880 C536.287476,441.945679 534.220398,439.814392 534.781982,435.590393 z"
            />
          </g>
        </symbol>

        <symbol id="i-edit" viewBox="0 0 24 24">
          <path
            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15.13 4.12l3.75 3.75 1.83-1.83z"
          />
        </symbol>
        <symbol id="i-bin" viewBox="0 0 24 24">
          <path
            d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"
          />
        </symbol>
      </defs>
    </svg>

    <!-- Mobile Header -->
    <div
      class="md:hidden flex items-center justify-start gap-4 p-4 bg-white dark:bg-gray-800 shadow-md"
    >
      <button id="menu-toggle" class="text-gray-900 dark:text-gray-100">
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h16m-7 6h7"
          />
        </svg>
      </button>
      <div class="flex items-center">
        <svg
          class="h-10 w-10 mr-2 text-gray-800 dark:text-white -mt-2"
          fill="currentColor"
        >
          <use href="#app-logo" />
        </svg>
        <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">
          WealthTrack
        </h1>
      </div>
    </div>

    <!-- Sidebar -->
    <div
      id="sidebar"
      class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-gray-800 p-6 flex flex-col items-center shadow-lg border-r border-gray-200 dark:border-gray-700 overflow-y-auto md:overflow-visible transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-40 md:min-h-screen"
    >
      <div class="mb-8 w-full">
        <button
          id="brandHome"
          class="flex flex-col items-center w-full cursor-pointer"
        >
          <svg
            id="brandLogo"
            class="text-gray-800 dark:text-white mb-1 -mt-8"
            fill="currentColor"
            style="height: auto"
          >
            <use href="#app-logo" />
          </svg>
          <h1
            id="brandTitle"
            class="text-2xl leading-none font-bold text-center text-gray-900 dark:text-gray-100"
          >
            WealthTrack
          </h1>
        </button>
      </div>

      <div class="mb-8">
        <label class="dark-mode-toggle">
          <span class="mr-3 font-semibold text-gray-500 dark:text-gray-400"
            >Dark Mode</span
          >
          <input type="checkbox" id="themeToggle" class="peer" />
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
        </label>
      </div>

      <nav class="w-full">
        <button class="nav-btn" data-target="welcome">
          <span class="flex items-center">
            <i class="fa-solid fa-circle-info h-5 w-5 mr-3"></i>
            Welcome
          </span>
        </button>
        <button class="nav-btn active-nav-button" data-target="data-entry">
          <span class="flex items-center">
            <i class="fa-solid fa-clipboard-list h-5 w-5 mr-3"></i>
            Assets & Goals
          </span>
        </button>
        <button class="nav-btn hidden" data-target="forecasts">
          <span class="flex items-center">
            <i class="fa-solid fa-chart-line h-5 w-5 mr-3"></i>
            Forecasts
          </span>
        </button>
        <button class="nav-btn hidden" data-target="portfolio-analysis">
          <span class="flex items-center">
            <i class="fa-solid fa-chart-pie h-5 w-5 mr-3"></i>
            Portfolio Insights
          </span>
        </button>
        <button class="nav-btn hidden" data-target="snapshots">
          <span class="flex items-center">
            <i class="fa-solid fa-camera h-5 w-5 mr-3"></i>
            Snapshots
          </span>
        </button>
        <button class="nav-btn" data-target="calculators">
          <span class="flex items-center">
            <i class="fa-solid fa-calculator h-5 w-5 mr-3"></i>
            Calculators
          </span>
        </button>
        <button class="nav-btn" data-target="settings">
          <span class="flex items-center">
            <i class="fa-solid fa-sliders-h h-5 w-5 mr-3"></i>
            Settings & Data
          </span>
        </button>
      </nav>
    </div>

    <div
      id="overlay"
      class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"
    ></div>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
      <div id="welcome" class="content-section">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Welcome to WealthTrack
        </h2>
        <div class="card">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">Welcome</h3>
          <p class="text-gray-700 dark:text-gray-300 mb-4">
            WealthTrack helps you project and protect your financial future by
            combining the value of your current assets, recurring contributions,
            and growth assumptions. You can run "what-if" events, estimate
            future asset values, and save snapshots to track progress on the
            path to your financial goals.
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-700 stat-box">
              <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Quick start</h4>
              <ul class="list-disc pl-5 text-gray-700 dark:text-gray-300">
                <li>Create multiple profiles to keep scenarios separate (e.g., Personal, Partner, Joint, Experiments).</li>
                <li>Add your assets and set a wealth goal and target year on the Assets & Goals page. The Forecasts tab unlocks once both are in place, and Portfolio Insights shows up after you add your first asset.</li>
                <li>Set expected growth rates to power projections.</li>
                <li>Estimate future asset values from the Portfolio Insights page.</li>
                <li>Add future one-off events to simulate gains/losses.</li>
                <li>Run stress tests from Portfolio Insights to see how random market events could impact your projections.</li>
                <li>Save snapshots and review your history on the Snapshots page.</li>
              </ul>
            </div>

            <div class="p-4 rounded-lg bg-gray-100 dark:bg-gray-700 stat-box">
              <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Where to find things</h4>
              <ul class="list-disc pl-5 text-gray-700 dark:text-gray-300">
                <li><b>Profiles</b>: manage and switch profiles from the <b>Settings & Data</b> page.</li>
                <li><b>Assets & Goals</b>: capture assets, liabilities, and goals.</li>
                <li><b>Forecasts</b>: run projections, simulate one-off events, and use the Progress Check card to compare against snapshots.</li>
                <li><b>Portfolio Insights</b>: see allocation, passive income, future asset values, stress testing, and inflation impact.</li>
                <li><b>Snapshots</b>: save your totals and review how your wealth has changed over time.</li>
                <li><b>Calculators</b>: run one-off financial calculations.</li>
                <li><b>Settings & Data</b>: update theme, manage profiles, and export/import your data (optional password protection).</li>
              </ul>
            </div>
          </div>

          <div class="mt-4 p-4 rounded-lg bg-gray-100 dark:bg-gray-700 stat-box">
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Try a demo</h4>
            <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">Load sample data to explore forecasts and insights in seconds.</p>
            <button class="btn btn-purple" data-action="load-demo" aria-label="Load demo data">Load Demo Data</button>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Demo data creates a sample profile you can delete anytime.</p>
          </div>

          <div class="mt-4 p-4 rounded-lg bg-gray-100 dark:bg-gray-700 stat-box">
            <h4 class="font-semibold text-gray-900 dark:text-gray-100 mb-2">Use Profiles</h4>
            <p>
              Create unique profiles (for example, Personal vs. Joint or different strategies) and switch them from the
              <b>Settings & Data</b> page. Your assets, events, and goals stay separate per profile.
            </p>
            <div class="mt-3">
              <button class="btn btn-blue" data-action="create-profile" aria-label="Create a profile">Create a Profile</button>
            </div>
          </div>

          <div class="mt-6 flex gap-2">
            <button id="startNowBtn" data-action="start-now" class="btn btn-green" aria-label="Start now">Start Now</button>
          </div>
        </div>
      </div>

      <div id="data-entry" class="content-section active">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Assets & Goals
        </h2>
        <div class="mb-6 p-4 rounded-lg bg-gray-100 dark:bg-gray-700 stat-box text-gray-700 dark:text-gray-300">
          <p class="text-sm">
            The data you enter here powers your projections and analysis. Add
            assets, liabilities, and a wealth goal with a target year to drive your Forecasts and
            Portfolio Insights.
          </p>
        </div>

        <div class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            Goals
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Set a wealth goal and target year to work toward.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <label
                for="goalValue"
                class="text-md font-medium text-gray-700 dark:text-gray-300"
                >Wealth Goal (£)</label
              >
              <input
                type="number"
                step="any"
                id="goalValue"
                placeholder="e.g. 1000000"
                class="text-center text-3xl font-bold mt-2 bg-transparent border-b-2 border-gray-400 dark:border-gray-500 focus:outline-none focus:border-blue-500 w-full"
              />
            </div>
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <label
                for="goalYear"
                class="text-md font-medium text-gray-700 dark:text-gray-300"
                >Target Year</label
              >
              <input
                type="number"
                id="goalYear"
                placeholder="e.g. 2050"
                class="text-center text-3xl font-bold mt-2 bg-transparent border-b-2 border-gray-400 dark:border-gray-500 focus:outline-none focus:border-blue-500 w-full"
              />
            </div>
            <div class="md:col-span-2">
              <button id="goalBtn" class="btn btn-green btn-block">Set</button>
            </div>
          </div>
        </div>

        <div class="card transition hover:shadow-xl">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Assets & Contributions
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Add assets and recurring deposits, then set growth assumptions to
            project your future wealth.
          </p>

          <form id="assetForm" class="grid grid-cols-1 md:gap-4 gap-2">
            <div class="md:col-span-full">
              <label for="assetName" class="form-label required-label"
                >Asset Name</label
              >
              <input
                type="text"
                id="assetName"
                placeholder="e.g. Stocks"
                class="input-field"
                required
              />
            </div>
            <div class="md:col-span-full">
              <label for="assetValue" class="form-label required-label"
                >Value (£)</label
              >
              <input
                type="number"
                step="any"
                id="assetValue"
                placeholder="e.g. 50000"
                class="input-field"
                required
              />
            </div>
            <div class="md:col-span-full">
              <label for="depositAmount" class="form-label"
                >Deposit Amount (£)</label
              >
              <input
                type="number"
                step="any"
                id="depositAmount"
                value="0"
                class="input-field"
              />
            </div>
            <div class="md:col-span-full">
              <label for="depositFrequency" class="form-label"
                >Deposit Frequency</label
              >
              <select id="depositFrequency" class="input-field">
                <option value="none">None</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>

            <div class="md:col-span-full">
              <label for="assetStartDate" class="form-label"
                >Start Date</label
              >
              <input type="date" id="assetStartDate" class="input-field" />
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Leave blank to start immediately. Forecasts and contributions
                begin on the selected date.
              </p>
            </div>

            <!-- Include in Passive Income toggle (moved below deposit frequency) -->
            <div class="md:col-span-full">
              <label class="form-label"
                >Include in Passive Income estimates</label
              >
              <label class="dark-mode-toggle">
                <input type="checkbox" id="includePassive" checked />
                <span class="toggle-track"
                  ><span class="toggle-thumb"></span
                ></span>
              </label>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                If off, this asset will be excluded from Estimated Passive
                Income on the Portfolio Insights page.
              </p>
            </div>

            <div
              class="grid grid-cols-1 md:grid-cols-3 gap-2 md:gap-4 md:col-span-full"
            >
              <div>
                <label for="lowGrowth" class="form-label">
                  Low Growth Annual Return (%)
                  <span
                    class="relative group inline-block align-middle ml-1 cursor-help"
                  >
                    <span class="text-gray-400">?</span>
                    <span
                      class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm"
                    >
                      Optional. Used for conservative future forecasts (lower
                      expected returns).
                    </span>
                  </span>
                </label>
                <input
                  type="number"
                  step="any"
                  id="lowGrowth"
                  placeholder="e.g. 1"
                  class="input-field"
                />
              </div>

              <div>
                <label for="assetReturn" class="form-label">
                  Expected Annual Return (%)
                  <span
                    class="relative group inline-block align-middle ml-1 cursor-help"
                  >
                    <span class="text-gray-400">?</span>
                    <span
                      class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm"
                    >
                      Optional. Used for future forecasts and estimated passive
                      income. Leave blank for no growth.
                    </span>
                  </span>
                </label>
                <input
                  type="number"
                  step="any"
                  id="assetReturn"
                  placeholder="e.g. 4"
                  class="input-field"
                />
              </div>

              <div>
                <label for="highGrowth" class="form-label">
                  High Growth Annual Return (%)
                  <span
                    class="relative group inline-block align-middle ml-1 cursor-help"
                  >
                    <span class="text-gray-400">?</span>
                    <span
                      class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm"
                    >
                      Optional. Used for optimistic future forecasts (higher
                      expected returns).
                    </span>
                  </span>
                </label>
                <input
                  type="number"
                  step="any"
                  id="highGrowth"
                  placeholder="e.g. 10"
                  class="input-field"
                />
              </div>
            </div>

            <div class="flex items-end md:col-span-full">
              <button type="submit" class="btn btn-block btn-green">
                Add Asset
              </button>
            </div>
          </form>

          <div class="mt-4 overflow-x-auto">
            <table
              class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"
            >
              <thead
                id="assetTableHeader"
                class="bg-gray-200 dark:bg-gray-700"
              ></thead>
              <tbody
                id="assetTableBody"
                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
              ></tbody>
            </table>
          </div>
        </div>

        <div class="card transition hover:shadow-xl">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Liabilities & Payments
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Track debts or recurring expenses that reduce your wealth.
          </p>
          <form id="liabilityForm" class="grid grid-cols-1 md:gap-4 gap-2">
            <div class="md:col-span-full">
              <label for="liabilityName" class="form-label required-label"
                >Liability Name</label
              >
              <input
                type="text"
                id="liabilityName"
                class="input-field"
                required
              />
            </div>
            <div class="md:col-span-full">
              <label for="liabilityValue" class="form-label required-label"
                >Amount Owed (£)</label
              >
              <input
                type="number"
                step="any"
                id="liabilityValue"
                value="0"
                class="input-field"
                required
              />
            </div>
            <div class="md:col-span-full">
              <label for="liabilityInterest" class="form-label"
                >Annual Interest Rate (%)</label
              >
              <input
                type="number"
                step="any"
                id="liabilityInterest"
                value="0"
                class="input-field"
              />
            </div>
            <div class="md:col-span-full">
              <label for="liabilityPaymentAmount" class="form-label"
                >Recurring Payment (£)</label
              >
              <input
                type="number"
                step="any"
                id="liabilityPaymentAmount"
                value="0"
                class="input-field"
              />
            </div>
            <div class="md:col-span-full">
              <label for="liabilityPaymentFrequency" class="form-label"
                >Payment Frequency</label
              >
              <select id="liabilityPaymentFrequency" class="input-field">
                <option value="none">None</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Quarterly</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div class="md:col-span-full">
              <label for="liabilityStartDate" class="form-label"
                >Start Date</label
              >
              <input type="date" id="liabilityStartDate" class="input-field" />
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                Leave blank to treat this liability as active immediately.
                Balances and payments begin on the selected date.
              </p>
            </div>
            <div class="flex items-end md:col-span-full">
              <button type="submit" class="btn btn-block btn-red">
                Add Liability
              </button>
            </div>
          </form>
          <div class="mt-4 overflow-x-auto">
            <table
              class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"
            >
              <thead class="bg-gray-200 dark:bg-gray-700">
                <tr>
                  <th class="table-header">Name</th>
                  <th class="table-header">Start Date</th>
                  <th class="table-header">Current (£)</th>
                  <th class="table-header">Payment</th>
                  <th class="table-header">
                    <span class="sr-only">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody
                id="liabilityTableBody"
                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
              ></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="forecasts" class="content-section">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Forecasts
        </h2>
        <div id="forecastGoalsCard" class="card">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Goal Achievement
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Current totals and projected goal achievement dates based on your inputs.
          </p>
          <div class="grid grid-cols-1 gap-4">
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                Total Current Wealth
              </h4>
              <span id="totalWealthForecast" class="text-3xl font-bold -mt-4">£0</span>
            </div>
            <div id="forecastGoalsDates" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
          </div>
        </div>
        
        <div id="ForecastCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Wealth
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm">
            Click legend items to show or hide lines on the chart.
          </p>
          <div class="chart-container">
            <canvas id="wealthChart"></canvas>
            <div
              id="wealthChartMessage"
              class="text-center text-gray-500 hidden"
            >
              <p class="text-lg font-medium">Your forecast will appear here.</p>
              <p>
                Add at least one asset and set a wealth goal and target year to see your
                financial future projected.
              </p>
            </div>
          </div>
          
        </div>

        <div class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            One-off Events
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm">
            Model one-off future gains or losses to see their impact on your
            forecasts.
          </p>
          <p class="text-gray-700 dark:text-gray-300 text-xs mb-2">
            If no asset is linked, the event adjusts your overall portfolio
            balance.
          </p>
          <p
            id="eventsHint"
            class="text-xs text-gray-500 dark:text-gray-400 mt-1 hidden"
          >
            Events affect forecasts once you have at least one asset.
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-4">
            Enter negative amounts or percentages (e.g., -5000 or -5) to
            simulate an unexpected loss.
          </p>
          <form
            id="eventForm"
            class="grid grid-cols-1 md:grid-cols-4 gap-2 md:gap-4"
          >
            <div>
              <label for="eventName" class="form-label">Event Name</label>
              <input type="text" id="eventName" class="input-field" required />
            </div>
            <div>
              <label for="eventAmount" class="form-label">Amount</label>
              <div class="flex gap-2">
                <input
                  type="number"
                  step="any"
                  id="eventAmount"
                  class="input-field"
                  required
                />
                <select id="eventType" class="input-field w-20">
                  <option value="absolute">£</option>
                  <option value="percent">%</option>
                </select>
              </div>
            </div>
            <div>
              <label for="eventDate" class="form-label">Date</label>
              <input type="date" id="eventDate" class="input-field" required />
            </div>
            <div>
              <label for="eventAsset" class="form-label"
                >Linked Asset (optional)</label
              >
              <select id="eventAsset" class="input-field">
                <option value="">None</option>
              </select>
            </div>
            <div class="flex items-end md:col-span-full">
              <button
                type="submit"
                id="eventSubmitBtn"
                class="btn btn-block btn-green"
              >
                Add Event
              </button>
            </div>
          </form>
          <div class="mt-4 overflow-x-auto">
            <table
              class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"
            >
              <thead class="bg-gray-200 dark:bg-gray-700">
                <tr>
                  <th class="table-header">Event</th>
                  <th class="table-header">Date</th>
                  <th class="table-header">Asset</th>
                  <th class="table-header">Amount</th>
                  <th class="table-header">Actions</th>
                </tr>
              </thead>
              <tbody
                id="eventTableBody"
                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"
              ></tbody>
            </table>
          </div>
        </div>

        <div id="progressCheckCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Progress Check
          </h3>
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Compare your current position with the forecast that was saved when
            you took a snapshot.
          </p>
          <div
            id="progressCheckEmpty"
            class="mt-4 text-sm text-gray-500 dark:text-gray-400"
          >
            Take a snapshot to unlock progress comparisons.
          </div>
          <div
            id="progressCheckControls"
            class="mt-4 space-y-4 hidden"
          >
            <div>
              <label for="progressCheckSelect" class="form-label"
                >Compare against snapshot</label
              >
              <select
                id="progressCheckSelect"
                class="input-field"
              ></select>
            </div>
            <div
              id="progressCheckResult"
              class="rounded-xl border border-gray-200 bg-gray-50 p-4 text-sm text-gray-700 dark:border-gray-700 dark:bg-gray-700/50 dark:text-gray-200"
            >
              Select a snapshot to see how you're tracking against its saved
              forecast.
            </div>
          </div>
        </div>
        <div id="StressTestCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Stress Testing (Monte Carlo Simulations)
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm">
            Run Monte Carlo simulations with random market events (±15%) to see
            how they affect your goal timeline.
          </p>
          <form
            id="stressTestForm"
            class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mt-2"
          >
            <div>
              <label for="stressRuns" class="form-label">Simulations</label>
              <input
                type="number"
                id="stressRuns"
                class="input-field"
                value="100"
                min="1"
                max="1000"
                />
            </div>
            <div>
              <label for="stressScenario" class="form-label"
                >Scenario Baseline</label
              >
              <select id="stressScenario" class="input-field">
                <option value="low">Low Growth</option>
                <option value="base" selected>Expected Growth</option>
                <option value="high">High Growth</option>
              </select>
            </div>
            <div>
              <label for="stressAssetsToggle" class="form-label">Assets</label>
              <div class="relative">
                <button
                  type="button"
                  id="stressAssetsToggle"
                  class="input-field text-left"
                >
                  All Assets
                </button>
                <div
                  id="stressAssetsMenu"
                  class="hidden absolute z-10 w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg mt-1 max-h-40 overflow-y-auto"
                ></div>
              </div>
            </div>
            <div class="flex md:col-span-full">
              <button type="submit" class="btn btn-block btn-green md:mb-1">
                Run Stress Test
              </button>
            </div>
          </form>
          <div id="stressTestResult" class="mt-4 text-sm"></div>
        </div>
      </div>

      <div id="portfolio-analysis" class="content-section">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Portfolio Insights
        </h2>

        <div class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Portfolio Allocation
          </h3>
          <div class="chart-container">
            <canvas id="assetBreakdownChart"></canvas>
            <div id="noAssetMessage" class="text-center text-gray-500">
              <p>
                No assets added. Add an asset on the Assets & Goals page to see
                your breakdown.
              </p>
            </div>
          </div>
        </div>

        <div id="futureValueCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Future Asset Value
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Project an asset's potential value on a future date using your
            growth projections.
          </p>
          <form
            id="futureValueForm"
            class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"
          >
            <div>
              <label for="fvAsset" class="form-label required-label"
                >Asset</label
              >
              <select id="fvAsset" class="input-field" required></select>
            </div>
            <div>
              <label for="fvDate" class="form-label required-label"
                >Future Date</label
              >
              <input type="date" id="fvDate" class="input-field" required />
            </div>
            <div class="flex md:col-span-full">
              <button type="submit" class="btn btn-block btn-green md:mb-1">
                Check Future Value
              </button>
            </div>
          </form>
          <div
            id="fvResult"
            class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4 hidden"
          >
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                Low
              </h4>
              <span id="fvLow" class="text-3xl font-bold -mt-4">£0</span>
            </div>
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                Expected
              </h4>
              <span id="fvExpected" class="text-3xl font-bold -mt-4">£0</span>
            </div>
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                High
              </h4>
              <span id="fvHigh" class="text-3xl font-bold -mt-4">£0</span>
            </div>
          </div>
        </div>

        <div class="card" id="passiveIncomeCard">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            Estimated Passive Income
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Based on expected annual returns and current values.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                Daily
              </h4>
              <span id="passiveDaily" class="text-3xl font-bold -mt-4">£0</span>
            </div>
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                Weekly
              </h4>
              <span id="passiveWeekly" class="text-3xl font-bold -mt-4"
                >£0</span
              >
            </div>
            <div
              class="flex flex-col items-center justify-center p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 stat-box"
            >
              <h4 class="text-md font-medium text-gray-700 dark:text-gray-300">
                Monthly
              </h4>
              <span id="passiveMonthly" class="text-3xl font-bold -mt-4"
                >£0</span
              >
            </div>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-3">
            Excludes new contributions; shows growth from appreciation only.
          </p>
        </div>

        <div class="card" id="fireForecastCard">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            FIRE Readiness (Passive Income Forecast)
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Project when the assets you have marked as providing passive income
            could cover your living costs under each growth scenario. The
            projection compounds each asset using its low, expected, and high
            returns, estimates the annual passive income, and compares it to
            your costs with and without inflation.
          </p>
          <div class="bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 text-blue-900 dark:text-blue-100 text-xs rounded-lg p-3 mb-4">
            Mark at least one asset as “Passive Income” for this card to use its
            forecasts. Living costs should be entered in today’s money. We adjust
            them for inflation and optionally begin checking from your intended
            retirement date.
          </div>
          <form id="fireForecastForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
            <div>
              <label for="fireForecastLivingCosts" class="form-label required-label"
                >Living Costs (£)</label
              >
              <input
                type="number"
                step="any"
                id="fireForecastLivingCosts"
                class="input-field"
                required
              />
            </div>
            <div>
              <label for="fireForecastFrequency" class="form-label"
                >Frequency</label
              >
              <select id="fireForecastFrequency" class="input-field">
                <option value="annual">Annual</option>
                <option value="monthly">Monthly</option>
              </select>
            </div>
            <div>
              <label for="fireForecastInflation" class="form-label"
                >Expected Inflation (% per year)</label
              >
              <input
                type="number"
                step="any"
                id="fireForecastInflation"
                class="input-field"
              />
            </div>
            <div>
              <label for="fireForecastRetireDate" class="form-label"
                >Retirement Start Date (optional)</label
              >
              <input
                type="date"
                id="fireForecastRetireDate"
                class="input-field"
              />
            </div>
            <div class="md:col-span-2">
              <button type="submit" class="btn btn-green btn-block">
                Update FIRE Forecast
              </button>
            </div>
          </form>
          <div
            id="fireForecastSummary"
            class="text-sm text-gray-700 dark:text-gray-300 mt-4"
          ></div>
          <div
            id="fireForecastResults"
            class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mt-4"
          ></div>
        </div>

        <div id="inflationImpactCard" class="card is-collapsible" style="display:none;">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
            Inflation Impact
          </h3>
          <div class="card-body">
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Enter an annual inflation rate to see the value of your goal in today's money at the point it's reached for each scenario.
          </p>
            <form id="inflationForm" class="grid grid-cols-1 md:grid-cols-4 gap-2 md:gap-4 items-end relative z-0">
            <div>
              <label for="inflationRate" class="form-label">Annual Inflation (%)</label>
              <input type="number" step="any" id="inflationRate" class="input-field" value="2.5" />
            </div>
            <div class="flex md:col-span-full">
              <button type="submit" class="btn btn-green btn-block w-full">Update</button>
            </div>
          </form>
            <div id="inflationResult" class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mt-4 relative z-10">
              <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box relative z-0 hover:z-50">
                <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-center gap-1">
                  Low Growth
                  <span class="relative group inline-block align-middle cursor-help">
                    <span class="text-gray-400">?</span>
                    <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">Present value of your goal at the low-growth goal date, using the inflation rate above.</span>
                  </span>
              </h5>
                <p id="inflLow" class="mt-1"></p>
                <p id="inflLowYear" class="text-xs text-gray-500 dark:text-gray-400"></p>
                <p id="inflLowEq" class="text-xs text-gray-500 dark:text-gray-400"></p>
              </div>
              <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box relative z-0 hover:z-50">
                <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-center gap-1">
                  Expected Growth
                  <span class="relative group inline-block align-middle cursor-help">
                    <span class="text-gray-400">?</span>
                    <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">Present value of your goal at the expected-growth goal date, using the inflation rate above.</span>
                  </span>
              </h5>
                <p id="inflExpected" class="mt-1"></p>
                <p id="inflExpectedYear" class="text-xs text-gray-500 dark:text-gray-400"></p>
                <p id="inflExpectedEq" class="text-xs text-gray-500 dark:text-gray-400"></p>
              </div>
              <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box relative z-0 hover:z-50">
                <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-center gap-1">
                  High Growth
                  <span class="relative group inline-block align-middle cursor-help">
                    <span class="text-gray-400">?</span>
                    <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">Present value of your goal at the high-growth goal date, using the inflation rate above.</span>
                  </span>
              </h5>
                <p id="inflHigh" class="mt-1"></p>
                <p id="inflHighYear" class="text-xs text-gray-500 dark:text-gray-400"></p>
                <p id="inflHighEq" class="text-xs text-gray-500 dark:text-gray-400"></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="snapshots" class="content-section">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Snapshots
        </h2>
        <div id="saveSnapshotCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Save Snapshot
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-1">
            Save your current totals to track progress over time.
          </p>
          <p
            id="snapshotEmptyHint"
            class="text-xs text-gray-500 dark:text-gray-400 mb-4 hidden"
          >
            Add at least one asset before saving a snapshot.
          </p>
          <div class="flex flex-col gap-4">
            <div>
              <label for="snapshotName" class="form-label required-label"
                >Snapshot Name</label
              >
              <input
                type="text"
                id="snapshotName"
                placeholder="e.g. End of Q2"
                class="input-field"
                required
              />
            </div>
            <button
              id="snapshotBtn"
              data-action="take-snapshot"
              class="btn btn-block btn-green"
            >
              Take Snapshot
            </button>
          </div>
          <div id="snapshotList" class="mt-4">
            <h4
              id="snapshotsHeader"
              class="text-md font-medium text-gray-700 dark:text-gray-300 mb-2"
            >
              Saved Snapshots:
            </h4>
            <ul
              id="snapshotUl"
              class="divide-y divide-gray-200 dark:divide-gray-700"
            ></ul>
          </div>
        </div>
        <div id="snapshotHistoryCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
          >
            Snapshot History
          </h3>
          <div class="chart-container">
            <canvas id="snapshotChart"></canvas>
            <div
              id="noSnapshotMessage"
              class="text-center text-gray-500 hidden"
            >
              <p>
                No snapshots taken yet. Take a snapshot to track your wealth
                over time.
              </p>
            </div>
          </div>
        </div>
      </div>

      <div id="calculators" class="content-section">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Calculators
        </h2>
        <div class="card">
          <div
            class="tab-buttons flex flex-col sm:flex-row border-b border-gray-200 dark:border-gray-700 mb-6"
          >
            <button
              class="tab-btn tab-btn-active"
              data-tab-target="stock-profit"
            >
              Share Target Profit (%)
            </button>
            <button class="tab-btn" data-tab-target="stock-profit-amount">
              Share Target Profit (£)
            </button>
            <button class="tab-btn" data-tab-target="compound-interest">
              Compound Interest
            </button>
            <button class="tab-btn" data-tab-target="simple-interest">
              Simple Interest
            </button>
            <button class="tab-btn" data-tab-target="fire-calculator">
              FIRE (Simple)
            </button>
          </div>

          <div id="stock-profit" class="tab-content">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              Share Target Profit (%)
            </h3>
            <form
              id="stockProfitForm"
              class="grid grid-cols-1 md:grid-cols-2 gap-4"
            >
              <div>
                <label for="stock-price" class="form-label required-label"
                  >Price (pence)</label
                >
                <input
                  type="number"
                  step="any"
                  id="stock-price"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="sdrt-tax" class="form-label">
                  Tax on purchase (%)
                  <span
                    class="relative group inline-block align-middle ml-1 cursor-help"
                  >
                    <span class="text-gray-400">?</span>
                    <span
                      class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm"
                    >
                      Default 0.5%, the standard UK SDRT rate.
                    </span>
                  </span>
                </label>
                <input
                  type="number"
                  step="any"
                  id="sdrt-tax"
                  value="0.5"
                  class="input-field"
                />
              </div>
              <div>
                <label for="target-return" class="form-label required-label"
                  >Target % Return</label
                >
                <input
                  type="number"
                  step="any"
                  id="target-return"
                  class="input-field"
                  required
                />
              </div>
              <div class="md:col-span-2 flex items-end">
                <button type="submit" class="btn btn-block btn-green">
                  Calculate
                </button>
              </div>
            </form>
            <div id="stockProfitResult" class="mt-4 text-center"></div>
          </div>

          <div id="stock-profit-amount" class="tab-content hidden">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              Share Target Profit (£)
            </h3>
            <form
              id="stockProfitAmountForm"
              class="grid grid-cols-1 md:grid-cols-2 gap-4"
            >
              <div>
                <label
                  for="stock-price-profit"
                  class="form-label required-label"
                  >Price (pence)</label
                >
                <input
                  type="number"
                  step="any"
                  id="stock-price-profit"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="sdrt-tax-profit" class="form-label">
                  Tax on purchase (%)
                  <span
                    class="relative group inline-block align-middle ml-1 cursor-help"
                  >
                    <span class="text-gray-400">?</span>
                    <span
                      class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-sm"
                    >
                      Default 0.5%, the standard UK SDRT rate.
                    </span>
                  </span>
                </label>
                <input
                  type="number"
                  step="any"
                  id="sdrt-tax-profit"
                  value="0.5"
                  class="input-field"
                />
              </div>
              <div>
                <label
                  for="stock-shares-profit"
                  class="form-label required-label"
                  >Number of Shares</label
                >
                <input
                  type="number"
                  step="any"
                  id="stock-shares-profit"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="target-profit" class="form-label required-label"
                  >Target Profit (£)</label
                >
                <input
                  type="number"
                  step="any"
                  id="target-profit"
                  class="input-field"
                  required
                />
              </div>
              <div class="md:col-span-2 flex items-end">
                <button type="submit" class="btn btn-block btn-green">
                  Calculate
                </button>
              </div>
            </form>
            <div id="stockProfitAmountResult" class="mt-4 text-center"></div>
          </div>

          <div id="compound-interest" class="tab-content hidden">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              Compound Interest Calculator
            </h3>
            <form
              id="compoundForm"
              class="grid grid-cols-1 md:grid-cols-2 gap-4"
            >
              <div>
                <label for="ci-principal" class="form-label required-label"
                  >Principal (£)</label
                >
                <input
                  type="number"
                  step="any"
                  id="ci-principal"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="ci-rate" class="form-label required-label"
                  >Annual Rate (%)</label
                >
                <input
                  type="number"
                  step="any"
                  id="ci-rate"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="ci-years" class="form-label required-label"
                  >Years</label
                >
                <input
                  type="number"
                  step="any"
                  id="ci-years"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="ci-frequency" class="form-label"
                  >Compounding Interval</label
                >
                <select id="ci-frequency" class="input-field">
                  <option value="monthly" selected>Monthly</option>
                  <option value="yearly">Yearly</option>
                  <option value="weekly">Weekly</option>
                  <option value="daily">Daily</option>
                </select>
              </div>
              <div>
                <label for="ci-contribution" class="form-label"
                  >Monthly Contribution (£)</label
                >
                <input
                  type="number"
                  step="any"
                  id="ci-contribution"
                  value="0"
                  class="input-field"
                />
              </div>
              <div class="md:col-span-2 flex items-end">
                <button type="submit" class="btn btn-block btn-green">
                  Calculate
                </button>
              </div>
            </form>
            <div id="compoundResult" class="mt-4"></div>
          </div>

          <div id="simple-interest" class="tab-content hidden">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              Simple Interest Calculator
            </h3>
            <form
              id="simpleInterestForm"
              class="grid grid-cols-1 md:grid-cols-2 gap-4"
            >
              <div>
                <label for="si-principal" class="form-label required-label"
                  >Principal (£)</label
                >
                <input
                  type="number"
                  step="any"
                  id="si-principal"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="si-rate" class="form-label required-label"
                  >Annual Rate (%)</label
                >
                <input
                  type="number"
                  step="any"
                  id="si-rate"
                  class="input-field"
                  required
                />
              </div>
              <div>
                <label for="si-years" class="form-label required-label"
                  >Years</label
                >
                <input
                  type="number"
                  step="any"
                  id="si-years"
                  class="input-field"
                  required
                />
              </div>
              <div class="md:col-span-2 flex items-end">
                <button type="submit" class="btn btn-block btn-green">
                  Calculate
                </button>
              </div>
            </form>
            <div id="simpleInterestResult" class="mt-4"></div>
          </div>

          <div id="fire-calculator" class="tab-content hidden">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              FIRE (Simple)
            </h3>
            <div class="mb-4 p-4 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 stat-box">
              <h4 class="font-semibold mb-2">How this works</h4>
              <p class="text-sm mb-2">
                Your FIRE (Financial Independence, Retire Early) number is the lump sum you need so your investments can pay for your living costs throughout retirement.
              </p>
              <p class="text-sm mb-2">This simple version uses:</p>
              <ul class="list-disc ml-5 text-sm">
                <li><strong>Your yearly living costs</strong> - what you expect to spend each year.</li>
                <li><strong>Safe Withdrawal Rate (SWR)</strong> - the % you feel comfortable taking from your pot each year (4% is a common rule-of-thumb).</li>
              </ul>
              <p class="text-sm mt-2">
                Your FIRE number is just your yearly costs divided by your SWR. Example: £25,000 a year and a 4% SWR would be calculated as £25,000 / 0.04 = £625,000.
                The progress bar compares this target with your current net worth.
              </p>
            </div>
            <form id="fireForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="md:col-span-2">
                <label for="fireLivingExpenses" class="form-label required-label"
                  >Living Costs (£)</label
                >
                <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
                  <input
                    type="number"
                    step="any"
                    min="0"
                    id="fireLivingExpenses"
                    class="input-field sm:flex-1"
                    required
                  />
                  <select
                    id="fireExpensesFrequency"
                    class="input-field sm:w-48"
                  >
                    <option value="annual">Per year</option>
                    <option value="monthly">Per month</option>
                  </select>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  We'll convert monthly spending into an annual figure for the
                  calculation.
                </p>
              </div>
              <div>
                <label for="fireWithdrawalRate" class="form-label required-label"
                  >Safe Withdrawal Rate (%)</label
                >
                <input
                  type="number"
                  step="0.1"
                  min="0.1"
                  id="fireWithdrawalRate"
                  class="input-field"
                  required
                />
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  Classic rule-of-thumb is 4%. Adjust to your preference.
                </p>
              </div>
              
              <div class="md:col-span-2 flex items-end">
                <button type="submit" class="btn btn-block btn-green">
                  Calculate
                </button>
              </div>
            </form>
            <div
              id="fireResult"
              class="mt-4 text-sm text-gray-700 dark:text-gray-300"
            >
              Enter your living costs to see your FIRE target.
            </div>
          </div>
        </div>
      </div>

      <div id="data-management" class="content-section hidden">
        <h2 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
          Data & Backup
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div id="exportCard" class="card flex flex-col">
            <div class="flex-grow">
              <h3
                class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
              >
                Export Your Data
              </h3>
              <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
                Export your data with an optional password for backup or use on
                another device.
              </p>
              <div>
                <label for="exportPassword" class="form-label"
                  >Password (Optional)</label
                >
                <input
                  type="password"
                  id="exportPassword"
                  placeholder="Enter a password to encrypt"
                  class="input-field"
                />
              </div>
            </div>
            <div class="mt-4">
              <button
                id="exportBtn"
                data-action="export-data"
                class="btn btn-block btn-purple flex items-center justify-center"
              >
                <svg
                  class="h-5 w-5 mr-2"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                </svg>
                Export Data
              </button>
              <p
                id="exportEmptyHint"
                class="text-xs text-gray-500 dark:text-gray-400 mt-2 hidden"
              >
                No data to export yet. Add assets, liabilities, events, or
                snapshots first.
              </p>
            </div>
          </div>

          <div class="card flex flex-col">
            <div class="flex-grow">
              <h3
                class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
              >
                Import Your Data
              </h3>
              <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
                Import previously saved data to restore your information.
              </p>
              <div>
                <label for="importFile" class="form-label">Select File</label>
                <label
                  for="importFile"
                  class="flex items-center justify-center w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600"
                >
                  <svg
                    class="h-5 w-5 mr-2 text-gray-500"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM6 20V4h7v5h5v11H6z"
                    />
                  </svg>
                  <span
                    class="text-gray-900 dark:text-gray-100"
                    data-import-filename
                    >No file chosen</span
                  >
                  <input
                    type="file"
                    id="importFile"
                    accept=".json"
                    class="hidden"
                  />
                </label>
              </div>
              <div class="mt-4">
                <label for="importPassword" class="form-label"
                  >Password (Optional)</label
                >
                <input
                  type="password"
                  id="importPassword"
                  placeholder="Enter password for file"
                  class="input-field"
                />
              </div>
            </div>
            <div class="mt-4">
              <button
                data-action="import-data"
                class="btn btn-block btn-blue flex items-center justify-center"
              >
                <svg
                  class="h-5 w-5 mr-2"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M19 15h-4v4h-2v-4h-4v-2h4v-4h2v4h4v2zM5 19V5h14v8h2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h8v-2H5z"
                  />
                </svg>
                Import Data
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- One modal shell + templates -->
        <div id="modal" class="modal modal-hidden modal-overlay">
          <div
            class="modal-panel max-w-xl sm:max-w-2xl w-full relative"
          >
            <button
              class="modal-close absolute top-3 right-3 btn-icon"
              data-action="close-modal"
            >
              ×
            </button>
            <div id="modal-body" class="overflow-y-auto max-h-[80vh]"></div>
          </div>
        </div>

      <div id="settings" class="content-section">
        <h2
          class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6 text-left"
        >
          Settings & Data
        </h2>
        <div class="card mb-6">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            Profiles
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Create and switch between profiles to keep scenarios separate.
            Assets, events, snapshots, and goals are saved per profile.
          </p>
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-2 sm:gap-4 items-end">
            <div class="sm:col-span-3">
              <label for="profileSelect" class="form-label">Profile</label>
              <div class="flex items-center gap-2">
                <select id="profileSelect" class="input-field flex-1"></select>
                <div class="hidden sm:flex gap-2">
                  <button
                    id="addProfileBtn"
                    class="btn-icon"
                    title="Add Profile"
                  >
                    <i class="fa-solid fa-plus"></i>
                  </button>
                  <button
                    id="renameProfileBtn"
                    class="btn-icon"
                    title="Rename Profile"
                  >
                    <i class="fa-solid fa-pen"></i>
                  </button>
                  <button
                    id="deleteProfileBtn"
                    class="btn-icon"
                    title="Delete Profile"
                  >
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="mt-2 flex flex-col gap-2 sm:hidden">
                <button id="addProfileBtnMobile" class="btn btn-green w-full">
                  <i class="fa-solid fa-plus mr-2"></i>Add Profile
                </button>
                <button id="renameProfileBtnMobile" class="btn btn-gray w-full">
                  <i class="fa-solid fa-pen mr-2"></i>Rename Profile
                </button>
                <button id="deleteProfileBtnMobile" class="btn btn-red w-full">
                  <i class="fa-solid fa-trash mr-2"></i>Delete Profile
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="exportCard" class="card flex flex-col">
          <div class="flex-grow">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              Export Your Data
            </h3>
            <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
              Export your data with an optional password for backup or use on
              another device.
            </p>
            <div>
              <label for="exportPassword" class="form-label"
                >Password (Optional)</label
              >
              <input
                type="password"
                id="exportPassword"
                placeholder="Enter a password to encrypt"
                class="input-field"
              />
            </div>
          </div>
          <div class="mt-4">
            <button
              id="exportBtn"
              data-action="export-data"
              class="btn btn-block btn-purple flex items-center justify-center"
            >
              <svg
                class="h-5 w-5 mr-2"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
              </svg>
              Export Data
            </button>
            <p
              id="exportEmptyHint"
              class="text-xs text-gray-500 dark:text-gray-400 mt-2 hidden"
            >
              No data to export yet. Add assets, liabilities, events, or
              snapshots first.
            </p>
          </div>
        </div>

        <div class="card flex flex-col">
          <div class="flex-grow">
            <h3
              class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4"
            >
              Import Your Data
            </h3>
            <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
              Import previously saved data to restore your information.
            </p>
            <div>
              <label for="importFile" class="form-label">Select File</label>
              <label
                for="importFile"
                class="flex items-center justify-center w-full px-3 py-2 bg-gray-100 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600"
              >
                <svg
                  class="h-5 w-5 mr-2 text-gray-500"
                  viewBox="0 0 24 24"
                  fill="currentColor"
                >
                  <path
                    d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM6 20V4h7v5h5v11H6z"
                  />
                </svg>
                <span
                  class="text-gray-900 dark:text-gray-100"
                  data-import-filename
                  >No file chosen</span
                >
              </label>
            </div>
            <div class="mt-4">
              <label for="importPassword" class="form-label"
                >Password (Optional)</label
              >
              <input
                type="password"
                id="importPassword"
                placeholder="Enter password for file"
                class="input-field"
              />
            </div>
          </div>
          <div class="mt-4">
            <button
              data-action="import-data"
              class="btn btn-block btn-blue flex items-center justify-center"
            >
              <svg
                class="h-5 w-5 mr-2"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M19 15h-4v4h-2v-4h-4v-2h4v-4h2v4h4v2zM5 19V5h14v8h2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2h8v-2H5z"
                />
              </svg>
              Import Data
            </button>
          </div>
        </div>

        <div class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            Theme
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Choose a look and feel. Your choice is saved for next time.
          </p>
          <div class="max-w-xs">
            <label for="themeSelect" class="form-label">Theme</label>
            <select id="themeSelect" class="input-field">
              <option value="default">Default</option>
              <option value="inverted">Inverted</option>
              <option value="glass">Glass</option>
            </select>
          </div>
        </div>
        <div id="welcomeCard" class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            Welcome Page
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Show or hide the welcome page in the navigation.
          </p>
          <label class="dark-mode-toggle">
            <span class="mr-3 font-semibold text-gray-500 dark:text-gray-400"
              >Show Welcome Page</span
            >
            <input type="checkbox" id="welcomeToggle" class="peer" />
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
          </label>
        </div>
        
        <div class="card">
          <h3
            class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-2"
          >
            Reset App
          </h3>
          <p class="text-gray-700 dark:text-gray-300 text-sm mb-4">
            Clear all locally stored data and restart the app.
          </p>
          <button class="btn btn-red flex items-center" data-action="clear-data">
            <i class="fa-solid fa-trash mr-2"></i>
            Clear Data
          </button>
        </div>
      </div>
    </main>

    <template id="tpl-alert">
      <div class="text-center">
        <div class="mb-6" data-text></div>
        <div class="flex justify-center">
          <button class="btn btn-green" data-ok>OK</button>
        </div>
      </div>
    </template>

    <template id="tpl-confirm">
      <div class="text-center">
        <div class="mb-6" data-text></div>
        <div class="flex justify-center gap-4">
          <button class="btn btn-red" data-confirm>Confirm</button>
          <button class="btn btn-gray" data-cancel>Cancel</button>
        </div>
      </div>
    </template>

    <template id="tpl-prompt">
      <div class="text-center">
        <div class="mb-4" data-text></div>
        <input type="text" class="input-field mb-6" data-input />
        <div class="flex justify-center gap-4">
          <button class="btn btn-green" data-ok>OK</button>
          <button class="btn btn-gray" data-cancel>Cancel</button>
        </div>
      </div>
    </template>

    <template id="tpl-snapshot-details">
      <div>
        <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-2">
          Snapshot Details
        </h4>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4" data-date></p>
        <div class="overflow-y-auto max-h-96" data-list></div>
        <div class="mt-4 text-center">
          <button class="btn btn-blue" data-close>Close</button>
        </div>
      </div>
    </template>

    <template id="tpl-edit-asset">
      <div>
        <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          Edit Asset
        </h4>
        <form
          id="editAssetFormModal"
          class="grid grid-cols-1 sm:grid-cols-2 gap-4"
        >
          <input type="hidden" id="editAssetIndex" />
          <div class="sm:col-span-2">
            <label for="editAssetName" class="form-label required-label"
              >Asset Name</label
            >
            <input
              type="text"
              id="editAssetName"
              class="input-field"
              required
            />
          </div>
          <div>
            <label for="editAssetValue" class="form-label required-label"
              >Initial Value (£)</label
            >
            <input
              type="number"
              step="any"
              id="editAssetValue"
              class="input-field"
              required
            />
          </div>
          <div>
            <label for="editDepositAmount" class="form-label"
              >Deposit Amount (£)</label
            >
            <input
              type="number"
              step="any"
              id="editDepositAmount"
              class="input-field"
            />
          </div>
          <div class="sm:col-span-2">
            <label for="editDepositFrequency" class="form-label"
              >Deposit Frequency</label
            >
            <select id="editDepositFrequency" class="input-field">
              <option value="none">None</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
          <div class="sm:col-span-2">
            <label for="editAssetStartDate" class="form-label">Start Date</label>
            <input type="date" id="editAssetStartDate" class="input-field" />
          </div>
          <div class="sm:col-span-2">
            <label class="form-label"
              >Include in estimated Passive Income values</label
            >
            <label class="dark-mode-toggle">
              <input type="checkbox" id="editIncludePassive" />
              <span class="toggle-track"
                ><span class="toggle-thumb"></span
              ></span>
            </label>
          </div>
          <div>
            <label for="editLowGrowth" class="form-label">Low Growth (%)</label>
            <input
              type="number"
              step="any"
              id="editLowGrowth"
              class="input-field"
            />
          </div>
          <div>
            <label for="editAssetReturn" class="form-label"
              >Expected Return (%)</label
            >
            <input
              type="number"
              step="any"
              id="editAssetReturn"
              class="input-field"
            />
          </div>
          <div>
            <label for="editHighGrowth" class="form-label"
              >High Growth (%)</label
            >
            <input
              type="number"
              step="any"
              id="editHighGrowth"
              class="input-field"
            />
          </div>

          <div class="sm:col-span-2 mt-4 flex justify-end gap-3">
            <button type="button" class="btn btn-gray" data-close>
              Cancel
            </button>
            <button type="submit" class="btn btn-green">Save Changes</button>
          </div>
        </form>
      </div>
    </template>

    <template id="tpl-edit-liability">
      <div>
        <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          Edit Liability
        </h4>
        <form
          id="editLiabilityFormModal"
          class="grid grid-cols-1 md:gap-4 gap-2"
        >
          <input type="hidden" id="editLiabilityIndex" />
          <div class="md:col-span-full">
            <label for="editLiabilityName" class="form-label required-label"
              >Liability Name</label
            >
            <input
              type="text"
              id="editLiabilityName"
              class="input-field"
              required
            />
          </div>
          <div class="md:col-span-full">
            <label for="editLiabilityValue" class="form-label required-label"
              >Amount Owed (£)</label
            >
            <input
              type="number"
              step="any"
              id="editLiabilityValue"
              class="input-field"
              required
            />
          </div>
          <div class="md:col-span-full">
            <label for="editLiabilityInterest" class="form-label"
              >Annual Interest Rate (%)</label
            >
            <input
              type="number"
              step="any"
              id="editLiabilityInterest"
              class="input-field"
            />
          </div>
          <div class="md:col-span-full">
            <label for="editLiabilityPaymentAmount" class="form-label"
              >Recurring Payment (£)</label
            >
            <input
              type="number"
              step="any"
              id="editLiabilityPaymentAmount"
              class="input-field"
            />
          </div>
          <div class="md:col-span-full">
            <label for="editLiabilityPaymentFrequency" class="form-label"
              >Payment Frequency</label
            >
            <select id="editLiabilityPaymentFrequency" class="input-field">
              <option value="none">None</option>
              <option value="monthly">Monthly</option>
              <option value="quarterly">Quarterly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
          <div class="md:col-span-full">
            <label for="editLiabilityStartDate" class="form-label"
              >Start Date</label
            >
            <input type="date" id="editLiabilityStartDate" class="input-field" />
          </div>
          <div class="md:col-span-full mt-4 flex justify-end gap-3">
            <button type="button" class="btn btn-gray" data-close>
              Cancel
            </button>
            <button type="submit" class="btn btn-green">Save Changes</button>
          </div>
        </form>
      </div>
    </template>

    <template id="tpl-edit-event">
      <div>
        <h4 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">
          Edit Event
        </h4>
        <form
          id="editEventForm"
          class="grid grid-cols-1 md:grid-cols-4 gap-2 md:gap-4"
        >
          <input type="hidden" id="editEventIndex" />
          <div>
            <label for="editEventName" class="form-label required-label"
              >Event Name</label
            >
            <input
              type="text"
              id="editEventName"
              class="input-field"
              required
            />
          </div>
          <div>
            <label for="editEventAmount" class="form-label required-label"
              >Amount</label
            >
            <div class="flex gap-2">
              <input
                type="number"
                step="any"
                id="editEventAmount"
                class="input-field"
                required
              />
              <select id="editEventType" class="input-field w-20">
                <option value="absolute">£</option>
                <option value="percent">%</option>
              </select>
            </div>
          </div>
          <div>
            <label for="editEventDate" class="form-label required-label"
              >Date</label
            >
            <input
              type="date"
              id="editEventDate"
              class="input-field"
              required
            />
          </div>
          <div>
            <label for="editEventAsset" class="form-label"
              >Linked Asset (optional)</label
            >
            <select id="editEventAsset" class="input-field"></select>
          </div>
          <div class="md:col-span-4 mt-4 flex justify-end gap-3">
            <button type="button" class="btn btn-gray" data-close>
              Cancel
            </button>
            <button type="submit" class="btn btn-green">Save Changes</button>
          </div>
        </form>
      </div>
    </template>

    <!-- One-off onboarding for Assets & Goals after "Start Now" -->
    <template id="tpl-onboard-data">
      <div class="p-4 sm:p-6 max-w-full break-words">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">
          Get started: Add your assets
        </h3>
        <p class="text-gray-700 dark:text-gray-300 mb-4">
          To build your forecast, add your assets and set a target on the
          Assets & Goals page.
        </p>
        <ul
          class="list-disc pl-5 space-y-2 text-gray-700 dark:text-gray-300 mb-4"
        >
          <li>
            Add each asset with an initial value and optional recurring
            deposits.
          </li>
          <li>
            Set expected growth rates (low / expected / high) for better
            scenarios.
          </li>
          <li>
            Set a wealth goal and target year to unlock Forecasts and track progress.
          </li>
          <li>
            Choose whether each asset counts toward
            <b>Estimated Passive Income</b> calculations.
          </li>
          <li>
            Use <b>one-off events (What-If)</b> on the Forecasts page to model
            bonuses, purchases, or unexpected losses (use negative amounts).
          </li>
          <li>
            Run stress tests from the Portfolio Insights page to simulate
            market volatility and see how it affects your goal timeline.
          </li>
        </ul>
        <div class="mt-4 flex gap-2 justify-end">
          <button class="btn btn-gray" data-action="close-modal">Close</button>
          <button class="btn btn-gray" data-action="focus-goal">Set Goal</button>
          <button class="btn btn-green" data-action="focus-asset-form">
            Add First Asset
          </button>
        </div>
      </div>
    </template>

    <!-- One-off onboarding for Forecasts when unlocked -->
    <template id="tpl-onboard-forecast">
      <div class="p-4 sm:p-6 max-w-full break-words">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">
          Explore your forecast
        </h3>
        <p class="text-gray-700 dark:text-gray-300 mb-4">
          The Forecasts page projects your wealth over time using your assets, goal, and target year.
        </p>
        <ul class="list-disc pl-5 space-y-2 text-gray-700 dark:text-gray-300 mb-4">
          <li>Use the chart to see low, expected, and high scenarios.</li>
          <li>Add one-off events to model future gains or expenses.</li>
          <li>Check saved snapshots against today's forecast with Progress Check.</li>
        </ul>
        <div class="mt-4 flex justify-end">
          <button class="btn btn-green" data-action="close-modal">Got it</button>
        </div>
      </div>
    </template>

    <!-- Quick tour modal -->
    <template id="tpl-quick-tour">
      <div class="p-4 sm:p-6 max-w-full break-words">
        <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-3">
          Quick tour (30 seconds)
        </h3>
        <ul class="list-disc pl-5 space-y-2 text-gray-700 dark:text-gray-300 mb-4">
          <li><b>Assets & Goals</b>: add assets, set growth, and choose a target.</li>
          <li><b>Forecasts</b>: project your wealth, add one-off events.</li>
          <li><b>Portfolio Insights</b>: see allocation, passive income, and stress tests.</li>
          <li><b>Snapshots</b>: save totals to compare progress over time.</li>
          <li><b>Settings & Data</b>: profiles, theme, and export/import.</li>
        </ul>
        <div class="flex flex-wrap gap-2 justify-end">
          <button class="btn btn-gray" data-action="go-assets">Open Assets & Goals</button>
          <button class="btn btn-blue" data-action="go-forecasts">Open Forecasts</button>
          <button class="btn btn-gray" data-action="go-insights">Portfolio Insights</button>
          <button class="btn btn-gray" data-action="go-settings">Settings & Data</button>
          <button class="btn btn-green" data-action="close-modal">Close</button>
        </div>
      </div>
    </template>

    <!-- One-off tip: Profiles onboarding -->
    <script>
      // --- State ---
      let profiles = [];
      let activeProfile = null;
      let assets = [];
      let liabilities = [];
      let snapshots = [];
      let simEvents = [];
      let stressAssetIds = new Set();
      let goalValue = 0;
      let goalTargetDate = null;
      let inflationRate = 2.5;
      let wealthChart, snapshotChart, assetBreakdownChart;
      let assetForecasts = new Map();
      let liabilityForecasts = new Map();
      let lastForecastScenarios = null;
      let progressCheckSelection = null;
      let fireExpenses = 0;
      let fireExpensesFrequency = "annual";
      let fireWithdrawalRate = 4;
      let fireProjectionYears = 30;
      let fireLastInputs = null;
      let fireForecastCosts = 0;
      let fireForecastFrequency = "annual";
      let fireForecastInflation = 2.5;
      let fireForecastRetireDate = null;

      // --- DOM helpers ---
      const $ = (id) => document.getElementById(id);
      const on = (el, ev, fn) => el.addEventListener(ev, fn);
      const LS = {
        assets: "assets",
        liabs: "liabilities",
        snaps: "snapshots",
        events: "simEvents",
        goal: "goalValue",
        goalDate: "goalDate",
        welcome: "welcomeSeen",
        welcomeDisabled: "welcomeDisabled",
        onboardPending: "onboardDataPending",
        onboardSeen: "onboardDataSeen",
        theme: "themeDark",
        themeChoice: "themeChoice",
        profiles: "profiles",
        activeProfile: "activeProfile",
        forecastTip: "forecastTipSeen",
      };
      const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
      const load = (k, d) => JSON.parse(localStorage.getItem(k)) || d;

      const fmtGBP = (n) =>
        n.toLocaleString("en-GB", { style: "currency", currency: "GBP" });
      const fmtDate = new Intl.DateTimeFormat("en-GB", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      }).format;

      function saveCurrentProfile() {
        if (!activeProfile) return;
        activeProfile.assets = assets;
        activeProfile.liabilities = liabilities;
        activeProfile.snapshots = snapshots;
        activeProfile.simEvents = simEvents;
        activeProfile.goalValue = goalValue;
        activeProfile.goalTargetDate = goalTargetDate;
        activeProfile.inflationRate = inflationRate;
        activeProfile.fireExpenses = fireExpenses;
        activeProfile.fireExpensesFrequency = fireExpensesFrequency;
        activeProfile.fireWithdrawalRate = fireWithdrawalRate;
        activeProfile.fireProjectionYears = fireProjectionYears;
        activeProfile.fireForecastCosts = fireForecastCosts;
        activeProfile.fireForecastFrequency = fireForecastFrequency;
        activeProfile.fireForecastInflation = fireForecastInflation;
        activeProfile.fireForecastRetireDate = fireForecastRetireDate;
      }
      function persist() {
        saveCurrentProfile();
        save(LS.profiles, profiles);
        if (activeProfile)
          localStorage.setItem(LS.activeProfile, activeProfile.id);
      }

      function updateGoalButton() {
        const btn = $("goalBtn");
        if (btn) btn.textContent = goalValue > 0 && goalTargetDate ? "Update" : "Set";
      }

      const perYear = { none: 0, monthly: 12, quarterly: 4, yearly: 1 };
      const monthlyFrom = (freq, amount) =>
        ({
          none: 0,
          monthly: amount,
          quarterly: amount / 3,
          yearly: amount / 12,
        })[freq] || 0;

      const startOfToday = () => {
        const d = new Date();
        d.setHours(0, 0, 0, 0);
        return d.getTime();
      };

      const toTimestamp = (value) => {
        if (typeof value === "number" && Number.isFinite(value)) return value;
        if (!value) return null;
        const parsed = new Date(value);
        const time = parsed.getTime();
        return Number.isFinite(time) ? time : null;
      };

      const parseDateInput = (value, fallback) => {
        const defaultTime = Number.isFinite(fallback) ? fallback : startOfToday();
        if (!value) return defaultTime;
        const parsed = new Date(value);
        const time = parsed.getTime();
        if (!Number.isFinite(time)) return defaultTime;
        parsed.setHours(0, 0, 0, 0);
        return parsed.getTime();
      };

      const toDateInputValue = (timestamp) => {
        const time = toTimestamp(timestamp);
        if (time == null) return "";
        const date = new Date(time);
        if (!Number.isFinite(date.getTime())) return "";
        return date.toISOString().slice(0, 10);
      };

      const getStartDate = (item) => {
        if (!item) return startOfToday();
        const start = toTimestamp(item.startDate);
        if (start != null) return start;
        const added = toTimestamp(item.dateAdded);
        if (added != null) return added;
        return startOfToday();
      };

      // Seed a simple demo profile (creates/uses a profile named "Demo")
      function loadDemoData() {
        const seedIntoActive = () => {
          const now = Date.now();
          // Assets
          assets = [
            {
              name: "Cash",
              value: 3000,
              originalDeposit: 0,
              frequency: "none",
              dateAdded: now - 1000 * 60 * 60 * 24 * 60,
              startDate: now - 1000 * 60 * 60 * 24 * 60,
              return: 0,
              lowGrowth: 0,
              highGrowth: 0,
              monthlyDeposit: monthlyFrom("none", 0),
              includeInPassive: true,
            },
            {
              name: "Index Fund",
              value: 20000,
              originalDeposit: 500,
              frequency: "monthly",
              dateAdded: now - 1000 * 60 * 60 * 24 * 45,
              startDate: now - 1000 * 60 * 60 * 24 * 45,
              return: 5,
              lowGrowth: 2,
              highGrowth: 8,
              monthlyDeposit: monthlyFrom("monthly", 500),
              includeInPassive: true,
            },
            {
              name: "Bond Fund",
              value: 10000,
              originalDeposit: 200,
              frequency: "monthly",
              dateAdded: now - 1000 * 60 * 60 * 24 * 30,
              startDate: now - 1000 * 60 * 60 * 24 * 30,
              return: 3,
              lowGrowth: 1,
              highGrowth: 5,
              monthlyDeposit: monthlyFrom("monthly", 200),
              includeInPassive: true,
            },
          ];

          // Optional liability example
          liabilities = [
            {
              name: "Student Loan",
              value: 5000,
              interest: 3,
              originalPayment: 120,
              frequency: "monthly",
              dateAdded: now - 1000 * 60 * 60 * 24 * 20,
              startDate: now - 1000 * 60 * 60 * 24 * 20,
              monthlyPayment: monthlyFrom("monthly", 120),
            },
          ];

          // A couple of what-if events
          const nextYear = new Date(new Date().getFullYear() + 1, 0, 15).getTime();
          const twoYears = new Date(new Date().getFullYear() + 2, 5, 1).getTime();
          simEvents = [
            { name: "Bonus", amount: 2000, isPercent: false, date: nextYear },
            { name: "Car Purchase", amount: -10000, isPercent: false, date: twoYears },
          ];

          // Goal in ~10 years; calibrate so only High hits the goal
          const targetYr = new Date().getFullYear() + 10;
          goalTargetDate = new Date(targetYr, 11, 31).getTime();
          // Build scenarios and pick a goal between Base and High (above Base, below High)
          const scenarios = buildForecastScenarios();
          const lastIdx = scenarios.base.length - 1;
          const baseEnd = scenarios.base[lastIdx];
          const highEnd = scenarios.high[lastIdx];
          // Choose a goal 10% above Base but 5% below High (fallback to midpoint)
          let proposed = Math.min(highEnd * 0.95, Math.max(baseEnd * 1.1, (baseEnd + highEnd) / 2));
          if (!(proposed > baseEnd && proposed < highEnd)) proposed = (baseEnd + highEnd) * 0.6;
          // Round to nearest 1,000 for a clean number
          goalValue = Math.max(1000, Math.round(proposed / 1000) * 1000);

          fireExpenses = 30000;
          fireExpensesFrequency = "annual";
          fireWithdrawalRate = 4;
          fireLastInputs = {
            annualExpenses: fireExpenses,
            withdrawalRate: fireWithdrawalRate,
          };
          fireForecastCosts = fireExpenses;
          fireForecastFrequency = "annual";
          fireForecastInflation = inflationRate;
          fireForecastRetireDate = goalTargetDate;

          updateFireFormInputs();
          updateFireForecastInputs();

          // Push to UI and storage
          $("goalValue").value = goalValue || "";
          $("goalYear").value = targetYr;
          renderAssets();
          renderLiabilities();
          renderEvents();
          updateGoalButton();
          updateWealthChart();
          updateEmptyStates();
          refreshFireProjection();
          persist();

          showAlert("Demo data loaded into the Demo profile. Only High growth meets the goal by your target year.", () => {
            navigateTo("forecasts");
          });
        };

        const demo = (profiles || []).find(
          (p) => (p.name || "").toLowerCase() === "demo",
        );

        if (demo) {
          showConfirm('Replace data in the "Demo" profile?', () => {
            switchProfile(demo.id);
            seedIntoActive();
          });
        } else {
          // Create a fresh Demo profile and seed it
          addProfile("Demo");
          // addProfile switches to the new profile
          seedIntoActive();
        }
      }

      function normalizeData() {
        assets.forEach((a) => {
          if (!a || typeof a !== "object") return;
          const added = toTimestamp(a.dateAdded) ?? Date.now();
          a.dateAdded = added;
          const existingExplicit = toTimestamp(a.explicitStartDate);
          const start = toTimestamp(a.startDate);
          const inferredExplicit = existingExplicit != null
            ? existingExplicit
            : start != null && start !== added
              ? start
              : null;
          a.explicitStartDate = inferredExplicit;
          a.startDate = start ?? added;
          if (a.originalDeposit == null) a.originalDeposit = 0;
          if (!a.frequency) a.frequency = "none";
          if (a.monthlyDeposit == null)
            a.monthlyDeposit = monthlyFrom(a.frequency, a.originalDeposit);
          const ret = parseFloat(a.return) || 0;
          if (a.lowGrowth == null) a.lowGrowth = ret;
          if (a.highGrowth == null) a.highGrowth = ret;
          if (a.includeInPassive === undefined) a.includeInPassive = true;
        });
        liabilities.forEach((l) => {
          if (!l || typeof l !== "object") return;
          const added = toTimestamp(l.dateAdded) ?? Date.now();
          l.dateAdded = added;
          const existingExplicit = toTimestamp(l.explicitStartDate);
          const start = toTimestamp(l.startDate);
          const inferredExplicit = existingExplicit != null
            ? existingExplicit
            : start != null && start !== added
              ? start
              : null;
          l.explicitStartDate = inferredExplicit;
          l.startDate = start ?? added;
          if (l.originalPayment == null) l.originalPayment = 0;
          if (!l.frequency) l.frequency = "none";
          if (l.monthlyPayment == null)
            l.monthlyPayment = monthlyFrom(l.frequency, l.originalPayment);
          if (l.value == null) l.value = 0;
          if (l.interest == null) l.interest = 0;
        });
        simEvents.forEach((ev) => {
          if (!ev) return;
          if (ev.assetId != null) ev.assetId = Number(ev.assetId);
          ev.isPercent = !!ev.isPercent;
        });
        simEvents.sort((a, b) => a.date - b.date);
      }

      function initProfiles() {
        profiles = load(LS.profiles, null);
        let id = localStorage.getItem(LS.activeProfile);
        if (!profiles) {
          const def = {
            id: Date.now(),
            name: "Default",
            assets: load(LS.assets, []),
            liabilities: load(LS.liabs, []),
            snapshots: load(LS.snaps, []),
            simEvents: load(LS.events, []),
            goalValue: +localStorage.getItem(LS.goal) || 0,
            goalTargetDate: +localStorage.getItem(LS.goalDate) || null,
            fireExpenses: 0,
            fireExpensesFrequency: "annual",
            fireWithdrawalRate: 4,
            fireProjectionYears: 30,
            fireForecastCosts: 0,
            fireForecastFrequency: "annual",
            fireForecastInflation: 2.5,
            fireForecastRetireDate: null,
          };
          profiles = [def];
          id = def.id;
          save(LS.profiles, profiles);
        }
        if (profiles) {
          profiles.forEach((p) => {
            if (p.fireExpenses == null) p.fireExpenses = 0;
            p.fireExpensesFrequency =
              p.fireExpensesFrequency === "monthly" ? "monthly" : "annual";
            if (!(p.fireWithdrawalRate > 0)) p.fireWithdrawalRate = 4;
            if (!(p.fireProjectionYears > 0)) p.fireProjectionYears = 30;
            if (p.fireForecastCosts == null) p.fireForecastCosts = 0;
            p.fireForecastFrequency =
              p.fireForecastFrequency === "monthly" ? "monthly" : "annual";
            if (!(p.fireForecastInflation >= 0)) p.fireForecastInflation = 2.5;
            if (
              p.fireForecastRetireDate != null &&
              !isFinite(p.fireForecastRetireDate)
            )
              p.fireForecastRetireDate = null;
          });
        }
        activeProfile = profiles.find((p) => p.id == id) || profiles[0];
        assets = activeProfile.assets || [];
        liabilities = activeProfile.liabilities || [];
        snapshots = activeProfile.snapshots || [];
        simEvents = activeProfile.simEvents || [];
        goalValue = activeProfile.goalValue || 0;
        goalTargetDate = activeProfile.goalTargetDate || null;
        inflationRate =
          activeProfile.inflationRate != null ? activeProfile.inflationRate : 2.5;
        fireExpenses =
          activeProfile.fireExpenses != null ? activeProfile.fireExpenses : 0;
        fireExpensesFrequency =
          activeProfile.fireExpensesFrequency === "monthly"
            ? "monthly"
            : "annual";
        fireWithdrawalRate =
          activeProfile.fireWithdrawalRate > 0
            ? activeProfile.fireWithdrawalRate
            : 4;
        fireProjectionYears =
          activeProfile.fireProjectionYears && activeProfile.fireProjectionYears > 0
            ? activeProfile.fireProjectionYears
            : 30;
        fireForecastCosts =
          activeProfile.fireForecastCosts != null
            ? activeProfile.fireForecastCosts
            : 0;
        fireForecastFrequency =
          activeProfile.fireForecastFrequency === "monthly"
            ? "monthly"
            : "annual";
        fireForecastInflation =
          activeProfile.fireForecastInflation >= 0
            ? activeProfile.fireForecastInflation
            : 2.5;
        fireForecastRetireDate =
          activeProfile.fireForecastRetireDate &&
          isFinite(activeProfile.fireForecastRetireDate)
            ? activeProfile.fireForecastRetireDate
            : null;
        fireLastInputs =
          fireExpenses > 0 && fireWithdrawalRate > 0
            ? { annualExpenses: fireExpenses, withdrawalRate: fireWithdrawalRate }
            : null;
        activeProfile.fireExpenses = fireExpenses;
        activeProfile.fireExpensesFrequency = fireExpensesFrequency;
        activeProfile.fireWithdrawalRate = fireWithdrawalRate;
        activeProfile.fireProjectionYears = fireProjectionYears;
        activeProfile.fireForecastCosts = fireForecastCosts;
        activeProfile.fireForecastFrequency = fireForecastFrequency;
        activeProfile.fireForecastInflation = fireForecastInflation;
        activeProfile.fireForecastRetireDate = fireForecastRetireDate;
        normalizeData();
        localStorage.setItem(LS.activeProfile, activeProfile.id);
      }
      initProfiles();

      const depositsSoFar = (asset, now = Date.now()) => {
        if (!asset) return 0;
        const start = getStartDate(asset);
        if (now <= start) return 0;
        const years = (now - start) / (1000 * 60 * 60 * 24 * 365.25);
        const perYearRate = perYear[asset.frequency] || 0;
        const periods = Math.max(0, Math.floor(years * perYearRate));
        return (asset.originalDeposit || 0) * periods;
      };

      const calculateCurrentValue = (asset, now = Date.now()) => {
        if (!asset) return 0;
        const start = getStartDate(asset);
        if (now < start) return 0;
        return (asset.value || 0) + depositsSoFar(asset, now);
      };

      const liabilityBalanceAfterMonths = (liability, months) => {
        let balance = liability.value;
        const rate = (liability.interest || 0) / 100 / 12;
        const pay = liability.monthlyPayment || 0;
        for (let i = 0; i < months && balance > 0; i++) {
          balance = balance * (1 + rate);
          balance = Math.max(0, balance - Math.min(balance, pay));
        }
        return balance;
      };

      const calculateCurrentLiability = (liability, now = Date.now()) => {
        if (!liability) return 0;
        const start = getStartDate(liability);
        if (now < start) return 0;
        const years = (now - start) / (1000 * 60 * 60 * 24 * 365.25);
        const months = Math.floor(years * 12);
        return liabilityBalanceAfterMonths(liability, months);
      };

      function calculateNetWorth(now = Date.now()) {
        const totalAssets = assets.reduce(
          (sum, asset) => sum + calculateCurrentValue(asset, now),
          0,
        );
        const totalLiabilities = liabilities.reduce(
          (sum, liability) => sum + calculateCurrentLiability(liability, now),
          0,
        );
        return totalAssets - totalLiabilities;
      }
      function calculatePassiveWorth(now = Date.now()) {
        return assets.reduce((sum, asset) => {
          if (!asset || asset.includeInPassive === false) return sum;
          return sum + calculateCurrentValue(asset, now);
        }, 0);
      }

      function calculateFutureValue(P, monthly, annualRate, years) {
        const r = annualRate / 100 / 12;
        const n = Math.round(years * 12);
        if (r === 0) return P + monthly * n;
        return (
          P * Math.pow(1 + r, n) + monthly * ((Math.pow(1 + r, n) - 1) / r)
        );
      }

      // Generic FV with selectable compounding frequency (periods per year)
      function calculateFutureValueFreq(
        P,
        contributionPerPeriod,
        annualRate,
        years,
        periodsPerYear,
      ) {
        const r = annualRate / 100 / (periodsPerYear || 12);
        const n = Math.round(years * (periodsPerYear || 12));
        if (r === 0) return P + contributionPerPeriod * n;
        return (
          P * Math.pow(1 + r, n) +
          contributionPerPeriod * ((Math.pow(1 + r, n) - 1) / r)
        );
      }

      // Forecast labels memo
      const getForecastLabels = (() => {
        const memo = new Map();
        return (years) => {
          if (memo.has(years)) return memo.get(years);
          const totalMonths = years * 12;
          const labels = Array.from({ length: totalMonths + 1 }, (_, i) => {
            const d = new Date();
            d.setMonth(d.getMonth() + i, 1);
            d.setHours(0, 0, 0, 0);
            return d;
          });
          memo.set(years, labels);
          return labels;
        };
      })();

      function buildForecastScenarios(yearsOverride = null, opts = {}) {
        const passiveOnly = !!(opts && opts.passiveOnly);
        const includeBreakdown = !!(opts && opts.includeBreakdown);
        const years = yearsOverride && yearsOverride > 0 ? yearsOverride : getGoalHorizonYears();
        const labels = getForecastLabels(years);
        const totalMonths = years * 12;

        const base = Array(labels.length).fill(0);
        const low = Array(labels.length).fill(0);
        const high = Array(labels.length).fill(0);

        const nextAssetForecasts = new Map();
        const assetDetails = includeBreakdown ? [] : null;
        const globalEvents = [];
        const eventsByAsset = new Map();
        const consideredAssets = passiveOnly
          ? assets.filter((a) => a && a.includeInPassive !== false)
          : assets;
        const assetIds = new Set(consideredAssets.map((a) => a.dateAdded));

        simEvents.forEach((ev) => {
          if (ev.assetId && assetIds.has(ev.assetId)) {
            if (!eventsByAsset.has(ev.assetId)) eventsByAsset.set(ev.assetId, []);
            eventsByAsset.get(ev.assetId).push(ev);
          } else {
            globalEvents.push(ev);
          }
        });

        assets.forEach((asset) => {
          if (passiveOnly && asset?.includeInPassive === false) return;
          const startTimestamp = getStartDate(asset);
          const startDateObj = new Date(startTimestamp);
          const nowTs = Date.now();
          const initialValue = asset.value || 0;
          const principal = calculateCurrentValue(asset);
          const monthlyContribution = asset.monthlyDeposit || 0;
          const assetEvents = (eventsByAsset.get(asset.dateAdded) || []).sort(
            (a, b) => a.date - b.date,
          );
          let eventIndex = 0;
          let active = nowTs >= startTimestamp;
          let valueBase = active ? principal : initialValue;
          let valueLow = valueBase;
          let valueHigh = valueBase;
          const rateBase = (asset.return || 0) / 100 / 12;
          const rateLow = (asset.lowGrowth || asset.return || 0) / 100 / 12;
          const rateHigh = (asset.highGrowth || asset.return || 0) / 100 / 12;
          const annualBase = parseFloat(asset.return) || 0;
          const annualLow =
            asset.lowGrowth != null ? parseFloat(asset.lowGrowth) || 0 : annualBase;
          const annualHigh =
            asset.highGrowth != null ? parseFloat(asset.highGrowth) || 0 : annualBase;
          const arrBase = [];
          const arrLow = [];
          const arrHigh = [];
          for (let i = 0; i <= totalMonths; i++) {
            const currentDate = labels[i];
            if (!active && currentDate >= startDateObj) {
              active = true;
              valueBase = initialValue;
              valueLow = initialValue;
              valueHigh = initialValue;
            }
            while (eventIndex < assetEvents.length) {
              const evt = assetEvents[eventIndex];
              const evtDate = new Date(evt.date);
              if (currentDate < evtDate) break;
              if (evt.date < startTimestamp) {
                eventIndex++;
                continue;
              }
              if (!active) {
                active = true;
                valueBase = initialValue;
                valueLow = initialValue;
                valueHigh = initialValue;
              }
              if (evt.isPercent) {
                const factor = 1 + evt.amount / 100;
                valueBase *= factor;
                valueLow *= factor;
                valueHigh *= factor;
              } else {
                valueBase += evt.amount;
                valueLow += evt.amount;
                valueHigh += evt.amount;
              }
              eventIndex++;
            }
            const baseVal = active ? valueBase : 0;
            const lowVal = active ? valueLow : 0;
            const highVal = active ? valueHigh : 0;
            arrBase[i] = baseVal;
            arrLow[i] = lowVal;
            arrHigh[i] = highVal;
            base[i] += baseVal;
            low[i] += lowVal;
            high[i] += highVal;
            if (active) {
              valueBase = valueBase * (1 + rateBase) + monthlyContribution;
              valueLow = valueLow * (1 + rateLow) + monthlyContribution;
              valueHigh = valueHigh * (1 + rateHigh) + monthlyContribution;
            }
          }
          nextAssetForecasts.set(asset.dateAdded, {
            base: arrBase,
            low: arrLow,
            high: arrHigh,
          });
          if (includeBreakdown)
            assetDetails.push({
              id: asset.dateAdded,
              name: asset.name,
              base: arrBase,
              low: arrLow,
              high: arrHigh,
              annualRates: {
                base: annualBase,
                low: annualLow,
                high: annualHigh,
              },
            });
        });

        globalEvents.forEach((event) => {
          const eventDate = new Date(event.date);
          const idx = labels.findIndex((label) => label >= eventDate);
          if (idx < 0) return;
          if (event.isPercent) {
            const factor = 1 + event.amount / 100;
            for (let i = idx; i <= totalMonths; i++) {
              base[i] *= factor;
              low[i] *= factor;
              high[i] *= factor;
            }
          } else {
            for (let i = idx; i <= totalMonths; i++) {
              base[i] += event.amount;
              low[i] += event.amount;
              high[i] += event.amount;
            }
          }
        });

        const nextLiabilityForecasts = new Map();
        if (!passiveOnly) {
          liabilities.forEach((liability) => {
            const startTimestamp = getStartDate(liability);
            const startDateObj = new Date(startTimestamp);
            const nowTs = Date.now();
            let active = nowTs >= startTimestamp;
            let outstanding = active
              ? calculateCurrentLiability(liability)
              : liability.value || 0;
            const rate = (liability.interest || 0) / 100 / 12;
            const payment = liability.monthlyPayment || 0;
            const arr = [];
            for (let i = 0; i <= totalMonths; i++) {
              const currentDate = labels[i];
              if (!active && currentDate >= startDateObj) {
                active = true;
                outstanding = liability.value || 0;
              }
              const currentOutstanding = active ? outstanding : 0;
              arr[i] = -currentOutstanding;
              base[i] += arr[i];
              low[i] += arr[i];
              high[i] += arr[i];
              if (active && outstanding > 0) {
                outstanding = outstanding * (1 + rate);
                outstanding = Math.max(
                  0,
                  outstanding - Math.min(outstanding, payment),
                );
              }
            }
            nextLiabilityForecasts.set(liability.dateAdded, arr);
          });
        }

        if (!passiveOnly) {
          assetForecasts = nextAssetForecasts;
          liabilityForecasts = nextLiabilityForecasts;
        }

        const scenarios = {
          labels,
          base,
          low,
          high,
          minSeriesValue: Math.min(...base, ...low, ...high),
          currentBaseline: passiveOnly ? calculatePassiveWorth() : calculateNetWorth(),
        };
        if (includeBreakdown) scenarios.assetDetails = assetDetails;
        if (!passiveOnly) lastForecastScenarios = scenarios;
        return scenarios;
      }

      function getSnapshotForecastSeries() {
        const scenarios = lastForecastScenarios || buildForecastScenarios();
        if (!scenarios) return [];
        return scenarios.labels.map((label, index) => ({
          date: label.toISOString(),
          value: scenarios.base[index],
        }));
      }

      function getGoalTargetYear() {
        return goalTargetDate ? new Date(goalTargetDate).getFullYear() : null;
      }
      function getGoalHorizonYears() {
        if (!goalTargetDate) return 30;
        const now = new Date();
        const target = new Date(goalTargetDate);
        const diff = (target - now) / (1000 * 60 * 60 * 24 * 365.25);
        return diff > 1 ? Math.ceil(diff) : 1;
      }

      // Modal helpers (single shell)
      const modalEl = $("modal"),
        modalBody = $("modal-body");
      const closeModal = () => modalEl.classList.add("modal-hidden");
      const openModalNode = (node) => {
        modalBody.replaceChildren(node);
        modalEl.classList.remove("modal-hidden");
      };

      function showAlert(message, onClose = null) {
        const tpl = document.importNode($("tpl-alert").content, true);
        tpl.querySelector("[data-text]").textContent = message;
        tpl.querySelector("[data-ok]").onclick = () => {
          closeModal();
          if (onClose) onClose();
        };
        openModalNode(tpl);
      }

      function showConfirm(message, onConfirm) {
        const tpl = document.importNode($("tpl-confirm").content, true);
        tpl.querySelector("[data-text]").textContent = message;
        tpl.querySelector("[data-confirm]").onclick = () => {
          onConfirm();
          closeModal();
        };
        tpl.querySelector("[data-cancel]").onclick = closeModal;
        openModalNode(tpl);
      }

      function showPrompt(message, defaultValue, onConfirm) {
        const tpl = document.importNode($("tpl-prompt").content, true);
        tpl.querySelector("[data-text]").textContent = message;
        const input = tpl.querySelector("[data-input]");
        input.value = defaultValue || "";
        tpl.querySelector("[data-ok]").onclick = () => {
          onConfirm(input.value.trim());
          closeModal();
        };
        tpl.querySelector("[data-cancel]").onclick = closeModal;
        openModalNode(tpl);
        input.focus();
      }

      function showSnapshotDetails(snapshot) {
        const tpl = document.importNode(
          $("tpl-snapshot-details").content,
          true,
        );
        tpl.querySelector("[data-date]").textContent =
          `Snapshot taken on: ${new Date(snapshot.date).toLocaleString()}`;
        const list = tpl.querySelector("[data-list]");
        list.innerHTML = `<table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-200 dark:bg-gray-700">
          <tr><th class="table-header">Asset Name</th><th class="table-header">Value</th></tr>
        </thead>
        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
          ${[...snapshot.assets]
            .sort((a, b) => (a?.name || "").localeCompare(b?.name || ""))
            .map(
              (a) => `<tr class="text-sm text-gray-700 dark:text-gray-300">
            <td class="px-6 py-4 whitespace-nowrap">${a.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${fmtGBP(a.value)}</td>
          </tr>`,
            )
            .join("")}
        </tbody>
      </table>`;
        tpl.querySelector("[data-close]").onclick = closeModal;
        openModalNode(tpl);
      }

      function showEditAsset(index) {
        const asset = assets[index];
        if (!asset) return;
        const tpl = document.importNode($("tpl-edit-asset").content, true);
        tpl.querySelector("#editAssetIndex").value = index;
        tpl.querySelector("#editAssetName").value = asset.name;
        tpl.querySelector("#editAssetValue").value = asset.value;
        tpl.querySelector("#editDepositAmount").value = asset.originalDeposit;
        tpl.querySelector("#editDepositFrequency").value = asset.frequency;
        const editAssetStart = tpl.querySelector("#editAssetStartDate");
        if (editAssetStart)
          editAssetStart.value = toDateInputValue(asset.explicitStartDate);
        tpl.querySelector("#editAssetReturn").value = asset.return;
        tpl.querySelector("#editLowGrowth").value = asset.lowGrowth;
        tpl.querySelector("#editHighGrowth").value = asset.highGrowth;
        const inc = asset.includeInPassive !== false;
        const incEl = tpl.querySelector("#editIncludePassive");
        if (incEl) incEl.checked = inc;

        tpl.querySelector("[data-close]").onclick = closeModal;
        tpl.querySelector("#editAssetFormModal").onsubmit = (e) => {
          e.preventDefault();
          const f = e.target;
          const i = +f.querySelector("#editAssetIndex").value;
          const a = assets[i];
          if (!a) return;
          a.name = f.querySelector("#editAssetName").value;
          a.value = parseFloat(f.querySelector("#editAssetValue").value);
          a.originalDeposit =
            parseFloat(f.querySelector("#editDepositAmount").value) || 0;
          a.frequency = f.querySelector("#editDepositFrequency").value;
          const explicitInput = f.querySelector("#editAssetStartDate")?.value;
          a.explicitStartDate = toTimestamp(explicitInput);
          a.startDate = a.explicitStartDate ?? getStartDate(a);
          const ret =
            parseFloat(f.querySelector("#editAssetReturn").value) || 0;
          a.return = ret;
          a.lowGrowth =
            parseFloat(f.querySelector("#editLowGrowth").value) || ret;
          a.highGrowth =
            parseFloat(f.querySelector("#editHighGrowth").value) || ret;
          a.monthlyDeposit = monthlyFrom(a.frequency, a.originalDeposit);
          const incCbx = f.querySelector("#editIncludePassive");
          a.includeInPassive = incCbx ? !!incCbx.checked : true;
          closeModal();
          renderAssets();
          renderEvents();
        };
        openModalNode(tpl);
      }

      function showEditLiability(index) {
        const liab = liabilities[index];
        if (!liab) return;
        const tpl = document.importNode($("tpl-edit-liability").content, true);
        tpl.querySelector("#editLiabilityIndex").value = index;
        tpl.querySelector("#editLiabilityName").value = liab.name;
        tpl.querySelector("#editLiabilityValue").value = liab.value;
        tpl.querySelector("#editLiabilityInterest").value = liab.interest || 0;
        tpl.querySelector("#editLiabilityPaymentAmount").value =
          liab.originalPayment;
        tpl.querySelector("#editLiabilityPaymentFrequency").value =
          liab.frequency;
        const editLiabilityStart = tpl.querySelector("#editLiabilityStartDate");
        if (editLiabilityStart)
          editLiabilityStart.value = toDateInputValue(liab.explicitStartDate);
        tpl.querySelector("[data-close]").onclick = closeModal;
        tpl.querySelector("#editLiabilityFormModal").onsubmit = (e) => {
          e.preventDefault();
          const f = e.target;
          const i = +f.querySelector("#editLiabilityIndex").value;
          const l = liabilities[i];
          if (!l) return;
          l.name = f.querySelector("#editLiabilityName").value;
          l.value =
            parseFloat(f.querySelector("#editLiabilityValue").value) || 0;
          l.interest =
            parseFloat(f.querySelector("#editLiabilityInterest").value) || 0;
          l.originalPayment =
            parseFloat(f.querySelector("#editLiabilityPaymentAmount").value) ||
            0;
          l.frequency = f.querySelector("#editLiabilityPaymentFrequency").value;
          l.monthlyPayment = monthlyFrom(l.frequency, l.originalPayment);
          const explicitInput = f.querySelector("#editLiabilityStartDate")?.value;
          l.explicitStartDate = toTimestamp(explicitInput);
          l.startDate = l.explicitStartDate ?? getStartDate(l);
          closeModal();
          renderLiabilities();
        };
        openModalNode(tpl);
      }

      function showEditEvent(index) {
        const ev = simEvents[index];
        if (!ev) return;
        const tpl = document.importNode($("tpl-edit-event").content, true);
        tpl.querySelector("#editEventIndex").value = index;
        tpl.querySelector("#editEventName").value = ev.name;
        tpl.querySelector("#editEventAmount").value = ev.amount;
        tpl.querySelector("#editEventType").value = ev.isPercent
          ? "percent"
          : "absolute";
        tpl.querySelector("#editEventDate").value = new Date(ev.date)
          .toISOString()
          .split("T")[0];
        const sel = tpl.querySelector("#editEventAsset");
        renderEventAssetOptions(sel);
        sel.value = ev.assetId || "";
        tpl.querySelector("[data-close]").onclick = closeModal;
        tpl.querySelector("#editEventForm").onsubmit = (e) => {
          e.preventDefault();
          const f = e.target;
          const i = +f.querySelector("#editEventIndex").value;
          const evt = simEvents[i];
          if (!evt) return;
          evt.name = f.querySelector("#editEventName").value;
          evt.amount = parseFloat(f.querySelector("#editEventAmount").value);
          evt.isPercent = f.querySelector("#editEventType").value === "percent";
          evt.date = new Date(
            f.querySelector("#editEventDate").value,
          ).getTime();
          const assetVal = f.querySelector("#editEventAsset").value;
          if (assetVal) {
            evt.assetId = Number(assetVal);
          } else {
            delete evt.assetId;
          }
          simEvents.sort((a, b) => a.date - b.date);
          closeModal();
          renderEvents();
          updateEmptyStates();
        };
        openModalNode(tpl);
      }

      // Table header generator + sorting (condensed columns)
      const ASSET_COLS = [
        "Asset Name",
        "Start Date",
        "Value",
        "Deposit",
        "Growth Rates",
      ];
      const ASSET_KEYS = ["name", "start", "value", "deposit", "return"];
      let assetSort = { key: "name", dir: "asc" };

      function buildAssetHeader() {
        const headHtml = ASSET_COLS.map((h, idx) => {
          const key = ASSET_KEYS[idx];
          const isActive = assetSort.key === key;
          const arrow = isActive ? (assetSort.dir === "asc" ? "▲" : "▼") : "";
          const inner = `<div class="flex items-center gap-1 whitespace-nowrap"><span>${h}</span><span class="sort-arrow">${arrow}</span></div>`;
          return `<th scope="col" class="table-header cursor-pointer select-none align-middle" data-sort="${key}">${inner}</th>`;
        }).join("");
        $("assetTableHeader").innerHTML =
          `<tr>${headHtml}<th class="relative px-6 py-3"><span class="sr-only">Actions</span></th></tr>`;
      }

      function sortAssetsForView(list) {
        const dir = assetSort.dir === "desc" ? -1 : 1;
        const cmp = (a, b) => {
          switch (assetSort.key) {
            case "name":
              return (
                (a.name || "").localeCompare(b.name || "", undefined, {
                  sensitivity: "base",
                }) * dir
              );
            case "start": {
              const aStart = getStartDate(a);
              const bStart = getStartDate(b);
              return (aStart - bStart) * dir;
            }
            case "value":
              return ((a.value || 0) - (b.value || 0)) * dir;
            case "deposit":
              return (
                ((a.originalDeposit || 0) - (b.originalDeposit || 0)) * dir
              );
            case "return": {
              const al = a.lowGrowth ?? a.return ?? 0;
              const bl = b.lowGrowth ?? b.return ?? 0;
              if (al !== bl) return (al - bl) * dir; // primary: low growth

              const ae = a.return ?? 0;
              const be = b.return ?? 0;
              if (ae !== be) return (ae - be) * dir; // secondary: expected

              const ah = a.highGrowth ?? a.return ?? 0;
              const bh = b.highGrowth ?? b.return ?? 0;
              return (ah - bh) * dir; // tertiary: high growth
            }
            case "current":
              return (
                (calculateCurrentValue(a) - calculateCurrentValue(b)) * dir
              ); // fallback
            default:
              return 0;
          }
        };
        return list.sort(cmp);
      }

      const STRESS_COLS = ["Asset", "Date", "Change"];
      const STRESS_KEYS = ["name", "date", "amount"];
      let stressSort = { key: "date", dir: "asc" };
      let stressSampleEvents = [];

      function buildStressHeader() {
        if (!$("stressEventsTableHeader")) return;
        const headHtml = STRESS_COLS.map((h, idx) => {
          const key = STRESS_KEYS[idx];
          const isActive = stressSort.key === key;
          const arrow = isActive ? (stressSort.dir === "asc" ? "▲" : "▼") : "";
          const inner = `<div class="flex items-center gap-1 whitespace-nowrap"><span>${h}</span><span class="sort-arrow">${arrow}</span></div>`;
          return `<th class="table-header cursor-pointer select-none" data-sort="${key}">${inner}</th>`;
        }).join("");
        $("stressEventsTableHeader").innerHTML = `<tr>${headHtml}</tr>`;
      }

      function sortStressEventsForView(list) {
        const dir = stressSort.dir === "desc" ? -1 : 1;
        const cmp = (a, b) => {
          switch (stressSort.key) {
            case "name":
              return (
                (a.name || "").localeCompare(b.name || "", undefined, {
                  sensitivity: "base",
                }) * dir
              );
            case "date":
              return ((a.date || 0) - (b.date || 0)) * dir;
            case "amount":
              return ((a.amount || 0) - (b.amount || 0)) * dir;
            default:
              return 0;
          }
        };
        return list.sort(cmp);
      }

      function renderStressEvents() {
        const body = $("stressEventsTableBody");
        if (!body) return;
        const sorted = sortStressEventsForView([...stressSampleEvents]);
        const rows =
          sorted
            .map(
              (ev) => `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">${ev.name}</td>
              <td class="px-6 py-4 whitespace-nowrap">${fmtDate(new Date(ev.date))}</td>
              <td class="px-6 py-4 whitespace-nowrap">${ev.amount.toFixed(1)}%</td>
            </tr>`,
            )
            .join("") ||
          `<tr><td colspan="3" class="px-6 py-4 text-sm text-gray-500 dark:text-gray-300">No random events</td></tr>`;
        body.innerHTML = rows;
      }

      // Charts: helpers
      const CHART_COLOURS = {
        blue: "rgba(59,130,246,1)",
        blueFill: "rgba(59,130,246,.2)",
        red: "rgba(239,68,68,.5)",
        green: "rgba(16,185,129,.5)",
      };

      // Opaque point colours for strong visibility (match line hues)
      const POINT_COLOURS = {
        blue: "rgba(59,130,246,1)",
        red: "rgba(239,68,68,1)",
        green: "rgba(16,185,129,1)",
      };

      // Plugin to add extra spacing beneath the legend (push chart down)
      const LegendPad = {
        id: "legendPad",
        beforeInit(chart, _args, opts) {
          const lg = chart?.legend;
          if (!lg || !lg.fit) return;
          const extra =
            opts && typeof opts.extra === "number" ? opts.extra : 24;
          const originalFit = lg.fit;
          lg.fit = function fit() {
            originalFit.bind(lg)();
            this.height += extra;
          };
        },
      };

      const baseLineOpts = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { bottom: 24 } },
        scales: {
          y: { ticks: { callback: (v) => fmtGBP(v) } },
          x: {
            type: "time",
            time: { unit: "year", tooltipFormat: "MMM yyyy" },
          },
        },
        elements: { point: { radius: 1, hoverRadius: 5, hitRadius: 6 } },
        plugins: {
          legend: {
            padding: 40,
            labels: { padding: 20 },
            onHover: (e) => {
              try {
                if (e?.native?.target) e.native.target.style.cursor = "pointer";
              } catch (_) {}
            },
            onLeave: (e) => {
              try {
                if (e?.native?.target) e.native.target.style.cursor = "default";
              } catch (_) {}
            },
          },
          legendPad: { extra: 28 },
          zoom: {
            pan: { enabled: true, mode: "x" },
            zoom: {
              wheel: { enabled: true },
              pinch: { enabled: true },
              mode: "x",
            },
          },
          tooltip: {
            callbacks: {
              label: (c) => `${c.dataset.label}: ${fmtGBP(c.raw.y)}`,
            },
          },
        },
      };

      const ensureChart = (ref, ctx, cfg) => {
        if (ref?.ctx?.canvas === ctx.canvas) {
          ref.config.data = cfg.data;
          ref.config.options = cfg.options;
          ref.update();
          return ref;
        }
        ref?.destroy();
        return new Chart(ctx, cfg);
      };
      const gbpTick = (v) => fmtGBP(v);
      const pieTooltip = (context) => {
        const total = context.chart.data.datasets[0].data.reduce(
          (a, b) => a + b,
          0,
        );
        const pct = ((context.raw / total) * 100).toFixed(2);
        return `${context.label}: ${fmtGBP(context.raw)} (${pct}%)`;
      };

      function adaptChartToZoom(chart) {
        // Derive range from current x-scale; prefer options min/max which the
        // zoom plugin updates, then fall back to computed scale bounds.
        const sx = chart.scales.x;
        let min = chart.options?.scales?.x?.min ?? sx.min;
        let max = chart.options?.scales?.x?.max ?? sx.max;
        const range = max - min;
        const twoYears = 2 * 365.25 * 24 * 60 * 60 * 1000,
          fiveYears = 5 * 365.25 * 24 * 60 * 60 * 1000,
          tenYears = 10 * 365.25 * 24 * 60 * 60 * 1000;
        chart.options.scales.x.time.unit =
          range <= twoYears ? "month" : range <= fiveYears ? "quarter" : "year";
        // Clearer sizing: decide by widest range first
        let radius, hover, hit;
        if (range > tenYears) {
          // very zoomed out (>10y)
          radius = 1;
          hover = 3;
          hit = 5;
        } else if (range > fiveYears) {
          // 5–10y
          radius = 2;
          hover = 3;
          hit = 5;
        } else if (range > twoYears) {
          // 2–5y
          radius = 3;
          hover = 5;
          hit = 7;
        } else {
          // <2y (close zoom)
          radius = 4;
          hover = 8;
          hit = 16;
        }

        chart.data.datasets.forEach((d, di) => {
          const isGoal = d.label && d.label.includes("Goal");
          const isBaseline = d.label && d.label.includes("Baseline");
          if (isGoal || isBaseline) return; // keep those as lines only
          d.pointRadius = radius;
          d.pointHoverRadius = hover;
          d.pointHitRadius = hit;
          // Also push sizes down to rendered elements to avoid stale cached options
          const meta = chart.getDatasetMeta(di);
          if (meta && Array.isArray(meta.data)) {
            meta.data.forEach((pt) => {
              if (!pt || !pt.options) return;
              pt.options.radius = radius;
              pt.options.hoverRadius = hover;
              pt.options.hitRadius = hit;
            });
          }
        });
        // Schedule a microtask update so we run outside the current plugin tick
        // and ensure the new point sizes render immediately without animation.
        (typeof requestAnimationFrame === "function"
          ? requestAnimationFrame
          : (fn) => setTimeout(fn, 0))(() => {
          try {
            chart.update("none");
          } catch (e) {}
        });
      }

      function updateChartTheme() {
        const isDark = document.documentElement.classList.contains("dark");
        const grid = isDark ? "#374151" : "#e5e7eb";
        const tick = isDark ? "#ffffff" : "#374151";
        const isMobile = window.innerWidth < 768;
        // Set global default text colour for tooltips/labels
        if (typeof Chart !== "undefined") {
          Chart.defaults.color = tick;
        }
        [wealthChart, snapshotChart, assetBreakdownChart].forEach((c) => {
          if (!c) return;
          const { scales, plugins } = c.options;
          if (scales?.x) {
            scales.x.grid.color = grid;
            scales.x.ticks.color = tick;
          }
          if (scales?.y) {
            scales.y.grid.color = grid;
            scales.y.ticks.color = tick;
          }
          if (plugins?.legend) {
            plugins.legend.padding = isMobile
              ? 8
              : (plugins.legend.padding ?? 40);
            if (plugins.legend.labels) {
              plugins.legend.labels.color = tick;
              plugins.legend.labels.padding = isMobile
                ? 6
                : (plugins.legend.labels.padding ?? 30);
            }
          }
          if (c.options?.layout?.padding) {
            c.options.layout.padding.top = isMobile
              ? 16
              : (c.options.layout.padding.top ?? 56);
          }
          // Ensure point outlines match series colour in both themes
          if (c.data?.datasets) {
            c.data.datasets.forEach((d) => {
              if (!d?.label) return;
              if (d.label.includes("Goal") || d.label.includes("Baseline"))
                return;
              if (d.borderColor) d.pointBorderColor = d.borderColor;
              d.pointBorderWidth = 2;
            });
          }
          c.update();
        });
      }

      function applyThemeChoice(val) {
        const root = document.documentElement;
        ["theme-inverted", "theme-glass"].forEach((cls) =>
          root.classList.remove(cls),
        );
        if (val === "inverted") root.classList.add("theme-inverted");
        if (val === "glass") root.classList.add("theme-glass");
        try {
          localStorage.setItem(LS.themeChoice, val || "default");
        } catch (_) {}
        // Refresh charts for any spacing/colour changes
        try {
          updateChartTheme();
        } catch (_) {}
      }

      // Passive income summary (based on expected returns)
      function updatePassiveIncome() {
        const card = $("passiveIncomeCard");
        if (!card) return;
        const hasAssets = assets.length > 0;
        card.hidden = !hasAssets;
        if (!hasAssets) {
          updateFireForecastCard();
          return;
        }

        let annualIncome = 0;
        assets.forEach((a) => {
          if (a.includeInPassive === false) return;
          const currentValue = calculateCurrentValue(a);
          const r = (a.return || 0) / 100;
          annualIncome += currentValue * r;
        });

        const daily = annualIncome / 365.25;
        const weekly = annualIncome / 52;
        const monthly = annualIncome / 12;

        const set = (id, val) => {
          const el = $(id);
          if (el) el.textContent = fmtGBP(val);
        };
        set("passiveDaily", daily || 0);
        set("passiveWeekly", weekly || 0);
        set("passiveMonthly", monthly || 0);
        updateFireForecastCard();
      }

      function updateFireFormInputs() {
        const amountInput = $("fireLivingExpenses");
        const freqSelect = $("fireExpensesFrequency");
        const rateInput = $("fireWithdrawalRate");
        const frequency =
          fireExpensesFrequency === "monthly" ? "monthly" : "annual";
        if (freqSelect) freqSelect.value = frequency;
        if (rateInput) {
          const rateVal = fireWithdrawalRate > 0 ? fireWithdrawalRate : 4;
          rateInput.value = Number((rateVal).toFixed(2)).toString();
          rateInput.disabled = false;
        }
        if (amountInput) {
          if (fireExpenses > 0) {
            const display =
              frequency === "monthly" ? fireExpenses / 12 : fireExpenses;
            amountInput.value = Number(display.toFixed(2)).toString();
          } else {
            amountInput.value = "";
          }
        }
      }

      function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }

      function updateFireForecastInputs() {
        const amountInput = $("fireForecastLivingCosts");
        const freqSelect = $("fireForecastFrequency");
        const inflationInput = $("fireForecastInflation");
        const retireInput = $("fireForecastRetireDate");
        const frequency =
          fireForecastFrequency === "monthly" ? "monthly" : "annual";
        if (freqSelect) freqSelect.value = frequency;
        if (amountInput) {
          if (fireForecastCosts > 0) {
            const display =
              frequency === "monthly"
                ? fireForecastCosts / 12
                : fireForecastCosts;
            amountInput.value = Number(display.toFixed(2)).toString();
          } else {
            amountInput.value = "";
          }
        }
        if (inflationInput) {
          const inflSource =
            fireForecastInflation != null ? fireForecastInflation : 0;
          const infl = Number(inflSource.toFixed(2));
          inflationInput.value = infl.toString();
        }
        if (retireInput) {
          if (fireForecastRetireDate && isFinite(fireForecastRetireDate)) {
            const d = new Date(fireForecastRetireDate);
            if (!Number.isNaN(d.getTime())) {
              retireInput.value = formatDateForInput(d);
            } else {
              retireInput.value = "";
            }
          } else {
            retireInput.value = "";
          }
        }
      }

      function updateFireForecastCard() {
        const card = $("fireForecastCard");
        if (!card) return;
        updateFireForecastInputs();
        const summaryEl = $("fireForecastSummary");
        const resultsEl = $("fireForecastResults");
        if (resultsEl) resultsEl.innerHTML = "";
        if (summaryEl) summaryEl.textContent = "";

        const passiveAssets = assets.filter(
          (a) => a && a.includeInPassive !== false,
        );
        if (passiveAssets.length === 0) {
          if (summaryEl)
            summaryEl.innerHTML =
              '<p class="text-sm text-gray-600 dark:text-gray-300">Mark at least one asset as providing passive income to project FIRE readiness.</p>';
          return;
        }
        if (!(fireForecastCosts > 0)) {
          if (summaryEl)
            summaryEl.innerHTML =
              '<p class="text-sm text-gray-600 dark:text-gray-300">Enter your living costs above and update the forecast to see when passive income could cover them.</p>';
          return;
        }

        const scenarios = buildForecastScenarios(null, {
          passiveOnly: true,
          includeBreakdown: true,
        });
        const labels = (scenarios && scenarios.labels) || [];
        const assetDetails = (scenarios && scenarios.assetDetails) || [];
        if (!labels.length || !assetDetails.length) {
          if (summaryEl)
            summaryEl.innerHTML =
              '<p class="text-sm text-gray-600 dark:text-gray-300">Add growth inputs for your passive income assets to model FIRE readiness.</p>';
          return;
        }

        const annualCost = fireForecastCosts;
        const inflationPct = Number(fireForecastInflation) || 0;
        const msPerYear = 1000 * 60 * 60 * 24 * 365.25;
        const now = new Date();
        const retireDate =
          fireForecastRetireDate && isFinite(fireForecastRetireDate)
            ? new Date(fireForecastRetireDate)
            : null;
        if (retireDate) retireDate.setHours(0, 0, 0, 0);
        let startIndex = 0;
        if (retireDate) {
          startIndex = labels.findIndex((d) => d >= retireDate);
        }
        if (startIndex < 0) startIndex = labels.length;
        if (startIndex >= labels.length) {
          if (summaryEl)
            summaryEl.innerHTML =
              '<p class="text-sm text-gray-600 dark:text-gray-300">Your retirement start date is beyond the current forecast horizon. Extend your goal target year to project further.</p>';
          return;
        }

        const formatMonthYear = (date) =>
          date
            ? date.toLocaleString("default", { month: "short", year: "numeric" })
            : "";
        const costDescriptor =
          fireForecastFrequency === "monthly"
            ? `${fmtGBP(annualCost / 12)} per month (${fmtGBP(annualCost)} per year)`
            : `${fmtGBP(annualCost)} per year`;
        const inflLabel = inflationPct.toLocaleString(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2,
        });
        const inflationText =
          inflationPct > 0
            ? `Inflation is applied at ${inflLabel}% per year (compounded monthly).`
            : `Inflation is set to 0%, so inflation-adjusted and no-inflation dates may match.`;
        const retireText = retireDate
          ? `Calculations begin from ${formatMonthYear(retireDate)}.`
          : `Calculations begin immediately.`;
        if (summaryEl)
          summaryEl.innerHTML = `<p>We project ${passiveAssets.length} passive income asset${
            passiveAssets.length === 1 ? "" : "s"
          } using your growth assumptions and compare their annual passive income to ${costDescriptor}. ${inflationText} ${retireText} Each scenario shows when income first covers your costs, plus the same calculation without inflation.</p>`;

        const inflationFactorText = (factor) => {
          if (!(factor > 0)) return "unchanged from today";
          const delta = (factor - 1) * 100;
          if (Math.abs(delta) < 0.1) return "unchanged from today";
          const sign = delta >= 0 ? "+" : "";
          return `${sign}${delta.toFixed(1)}% vs today`;
        };

        const computeCoverage = (scenarioKey, rateKey) => {
          const result = { withInflation: null, withoutInflation: null };
          for (let i = startIndex; i < labels.length; i++) {
            const date = labels[i];
            const yearsAhead = Math.max(0, (date - now) / msPerYear);
            const inflationFactor = Math.pow(1 + inflationPct / 100, yearsAhead);
            let annualPassive = 0;
            assetDetails.forEach((detail) => {
              const values = detail[scenarioKey] || [];
              const rate = detail.annualRates?.[rateKey] ?? 0;
              const value = values[i] ?? 0;
              annualPassive += value * (rate / 100);
            });
            if (!result.withoutInflation && annualPassive >= annualCost) {
              result.withoutInflation = {
                date,
                passive: annualPassive,
                living: annualCost,
                inflationFactor: 1,
              };
            }
            const adjustedCost = annualCost * inflationFactor;
            if (!result.withInflation && annualPassive >= adjustedCost) {
              result.withInflation = {
                date,
                passive: annualPassive,
                living: adjustedCost,
                inflationFactor,
              };
            }
            if (result.withInflation && result.withoutInflation) break;
          }
          return result;
        };

        const tooltips = {
          low: "Uses each asset's low growth rate.",
          base: "Uses each asset's expected growth rate.",
          high: "Uses each asset's high growth rate.",
        };
        const scenarioConfigs = [
          { key: "low", rate: "low", label: "Low Growth" },
          { key: "base", rate: "base", label: "Expected Growth" },
          { key: "high", rate: "high", label: "High Growth" },
        ];
        const cards = scenarioConfigs.map((cfg) => {
          const coverage = computeCoverage(cfg.key, cfg.rate);
          const withInfl = coverage.withInflation;
          const noInfl = coverage.withoutInflation;
          const withHit = withInfl
            ? `<span class="text-green-500">${formatMonthYear(withInfl.date)}</span>`
            : '<span class="text-red-600">Not reached</span>';
          const withoutHit = noInfl
            ? `<span class="text-green-500">${formatMonthYear(noInfl.date)}</span>`
            : '<span class="text-red-600">Not reached</span>';
          const withDetail = withInfl
            ? `Inflation-adjusted living costs: ${fmtGBP(
                withInfl.living,
              )} (${inflationFactorText(withInfl.inflationFactor)}). Passive income: ${fmtGBP(
                withInfl.passive,
              )} per year (~${fmtGBP(withInfl.passive / 12)} per month).`
            : "Passive income stays below your inflation-adjusted living costs within this forecast horizon.";
          const withoutDetail = noInfl
            ? `Living costs today: ${fmtGBP(noInfl.living)}. Passive income: ${fmtGBP(
                noInfl.passive,
              )} per year (~${fmtGBP(noInfl.passive / 12)} per month).`
            : "Passive income also stays below today's living costs within this horizon.";
          let deltaLine = "";
          if (withInfl && noInfl && withInfl.date && noInfl.date) {
            const deltaMonths = Math.round(
              (withInfl.date - noInfl.date) / (1000 * 60 * 60 * 24 * 30.4375),
            );
            if (deltaMonths > 0) {
              deltaLine = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Inflation delays coverage by about ${deltaMonths} month${
                deltaMonths === 1 ? "" : "s"
              }.</p>`;
            } else if (deltaMonths < 0) {
              const adv = Math.abs(deltaMonths);
              deltaLine = `<p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Inflation brings coverage forward by about ${adv} month${
                adv === 1 ? "" : "s"
              }.</p>`;
            }
          }
          return `
            <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-left stat-box relative z-0 hover:z-50">
              <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-between">
                ${cfg.label}
                <span class="relative group inline-block align-middle cursor-help ml-2">
                  <span class="text-gray-400">?</span>
                  <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">${
                    tooltips[cfg.key]
                  }</span>
                </span>
              </h5>
              <p class="text-sm mt-2">Inflation-adjusted: ${withHit}</p>
              <p class="text-xs text-gray-600 dark:text-gray-300 mt-1">${withDetail}</p>
              <p class="text-sm mt-3">No inflation: ${withoutHit}</p>
              <p class="text-xs text-gray-600 dark:text-gray-300 mt-1">${withoutDetail}</p>
              ${deltaLine}
            </div>
          `;
        });
        if (resultsEl) resultsEl.innerHTML = cards.join("\n");
      }

      // no-op: auto-SWR removed; user enters expected real return directly

      function refreshFireProjection() {
        const resultEl = $("fireResult");
        if (!resultEl) return;
        if (!fireLastInputs) {
          resultEl.innerHTML =
            '<p class="text-sm text-gray-600 dark:text-gray-300">Enter your living costs to see your FIRE target.</p>';
          return;
        }
        const { annualExpenses, withdrawalRate } = fireLastInputs;
        if (!(annualExpenses > 0) || !(withdrawalRate > 0)) {
          resultEl.innerHTML =
            '<p class="text-sm text-gray-600 dark:text-gray-300">Enter your living costs to see your FIRE target.</p>';
          return;
        }
        // Simple FIRE number using a safe withdrawal rate (SWR)
        const r = Math.max(0.001, (withdrawalRate || 0) / 100);
        const fireNumber = annualExpenses / r;
        const netWorth = calculateNetWorth();
        const progressPct =
          fireNumber > 0 ? (netWorth / fireNumber) * 100 : 0;
        const clampedProgress = Math.min(
          100,
          Math.max(0, progressPct),
        );
        const rateLabel = withdrawalRate.toLocaleString(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: 2,
        });
        let rateFootnote = `Safe withdrawal rate: ${rateLabel}%`;
        const frequencyLabel =
          fireExpensesFrequency === "monthly" ? "monthly" : "annual";
        const progressLabel =
          netWorth >= fireNumber
            ? "You're already at or above your FIRE number."
            : `Progress: ${clampedProgress.toFixed(1)}% of your FIRE number.`;
        // Build a simple green progress bar
        const progressBar = `
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
            <div class="bg-green-500 h-3" style="width: ${clampedProgress}%;"></div>
          </div>
        `;
        resultEl.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-lg bg-gray-100 dark:bg-gray-700 p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Annual Living Costs</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">${fmtGBP(
                annualExpenses,
              )}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Entered as ${frequencyLabel} spending.</p>
            </div>
            <div class="rounded-lg bg-gray-100 dark:bg-gray-700 p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">FIRE Number</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">${fmtGBP(
                fireNumber,
              )}</p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${rateFootnote}</p>
            </div>
            <div class="rounded-lg bg-gray-100 dark:bg-gray-700 p-3">
              <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Progress</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">${clampedProgress.toFixed(1)}%</p>
              <div class="mt-2">${progressBar}</div>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">${progressLabel}</p>
            </div>
          </div>
        `;
      }

      function renderProfileOptions() {
        const sel = $("profileSelect");
        if (!sel) return;
        sel.innerHTML = profiles
          .map((p) => `<option value="${p.id}">${p.name}</option>`)
          .join("");
        if (activeProfile) sel.value = activeProfile.id;
      }

      function switchProfile(id) {
        saveCurrentProfile();
        activeProfile = profiles.find((p) => p.id == id);
        if (!activeProfile) return;
        assets = activeProfile.assets || [];
        liabilities = activeProfile.liabilities || [];
        snapshots = activeProfile.snapshots || [];
        simEvents = activeProfile.simEvents || [];
        goalValue = activeProfile.goalValue || 0;
        goalTargetDate = activeProfile.goalTargetDate || null;
        inflationRate =
          activeProfile.inflationRate != null ? activeProfile.inflationRate : 2.5;
        fireExpenses =
          activeProfile.fireExpenses != null ? activeProfile.fireExpenses : 0;
        fireExpensesFrequency =
          activeProfile.fireExpensesFrequency === "monthly"
            ? "monthly"
            : "annual";
        fireWithdrawalRate =
          activeProfile.fireWithdrawalRate > 0
            ? activeProfile.fireWithdrawalRate
            : 4;
        fireProjectionYears =
          activeProfile.fireProjectionYears && activeProfile.fireProjectionYears > 0
            ? activeProfile.fireProjectionYears
            : 30;
        fireForecastCosts =
          activeProfile.fireForecastCosts != null
            ? activeProfile.fireForecastCosts
            : 0;
        fireForecastFrequency =
          activeProfile.fireForecastFrequency === "monthly"
            ? "monthly"
            : "annual";
        fireForecastInflation =
          activeProfile.fireForecastInflation >= 0
            ? activeProfile.fireForecastInflation
            : 2.5;
        fireForecastRetireDate =
          activeProfile.fireForecastRetireDate &&
          isFinite(activeProfile.fireForecastRetireDate)
            ? activeProfile.fireForecastRetireDate
            : null;
        // removed: fireUsePortfolioSWR
        fireLastInputs =
          fireExpenses > 0 && fireWithdrawalRate > 0
            ? { annualExpenses: fireExpenses, withdrawalRate: fireWithdrawalRate }
            : null;
        $("goalValue").value = goalValue || "";
        $("goalYear").value = goalTargetDate
          ? new Date(goalTargetDate).getFullYear()
          : "";
        const inflEl = $("inflationRate");
        if (inflEl) inflEl.value = inflationRate;
        updateFireFormInputs();
        updateFireForecastInputs();
        updateGoalButton();
        normalizeData();
        renderAssets();
        renderLiabilities();
        renderEvents();
        renderSnapshots();
        updateWealthChart();
        updateInflationImpactCard();
        updateSnapshotChart();
        renderAssetBreakdownChart();
        updatePassiveIncome();
        updateFireForecastCard();
        updateEmptyStates();
        refreshFireProjection();
        persist();
        renderProfileOptions();
      }

      function addProfile(name) {
        const id = Date.now();
        profiles.push({
          id,
          name: name || `Profile ${profiles.length + 1}`,
          assets: [],
          liabilities: [],
          snapshots: [],
          simEvents: [],
          goalValue: 0,
          goalTargetDate: null,
          fireExpenses: 0,
          fireExpensesFrequency: "annual",
          fireWithdrawalRate: 4,
          fireProjectionYears: 30,
          // removed: fireUsePortfolioSWR
          fireForecastCosts: 0,
          fireForecastFrequency: "annual",
          fireForecastInflation: 2.5,
          fireForecastRetireDate: null,
        });
        if (
          profiles.length === 2 &&
          profiles[0].name === "Default" &&
          !profiles[0].assets.length &&
          !profiles[0].liabilities.length &&
          !profiles[0].snapshots.length &&
          !profiles[0].simEvents.length &&
          !profiles[0].goalValue &&
          !profiles[0].goalTargetDate
        ) {
          profiles.splice(0, 1);
        }
        switchProfile(id);
      }

      function renameActiveProfile(name) {
        if (!activeProfile) return;
        activeProfile.name = name || activeProfile.name;
        persist();
        renderProfileOptions();
      }

      function deleteActiveProfile() {
        if (!activeProfile) return;
        const id = activeProfile.id;
        profiles = profiles.filter((p) => p.id !== id);
        activeProfile = null;
        if (profiles.length) {
          switchProfile(profiles[0].id);
        } else {
          assets = [];
          liabilities = [];
          snapshots = [];
          simEvents = [];
          goalValue = 0;
          goalTargetDate = null;
          fireExpenses = 0;
          fireExpensesFrequency = "annual";
          fireWithdrawalRate = 4;
          fireLastInputs = null;
          fireForecastCosts = 0;
          fireForecastFrequency = "annual";
          fireForecastInflation = 2.5;
          fireForecastRetireDate = null;
          $("goalYear").value = "";
          $("goalValue").value = "";
          updateFireFormInputs();
          updateFireForecastInputs();
          updateGoalButton();
          renderAssets();
          renderLiabilities();
          renderEvents();
          renderSnapshots();
          updateWealthChart();
          updateSnapshotChart();
          renderAssetBreakdownChart();
          updatePassiveIncome();
          updateFireForecastCard();
          refreshFireProjection();
          updateEmptyStates();
          persist();
          renderProfileOptions();
        }
      }

      // Empty states and gating UX for new users
      function updateEmptyStates() {
        const hasAssets = assets.length > 0;
        const hasLiabs = liabilities.length > 0;
        const hasAnyData =
          hasAssets ||
          hasLiabs ||
          snapshots.length > 0 ||
          simEvents.length > 0 ||
          goalValue > 0 ||
          goalTargetDate;
        const isFresh = !hasAnyData;
        const canForecast = hasAssets && goalValue > 0 && goalTargetDate;

        // Save Snapshot gating
        const snapBtn = $("snapshotBtn");
        const snapHint = $("snapshotEmptyHint");
        if (snapBtn) snapBtn.disabled = !(hasAssets || hasLiabs);
        if (snapHint)
          snapHint.classList.toggle("hidden", hasAssets || hasLiabs);

        // Export gating
        const expBtn = $("exportBtn");
        const expHint = $("exportEmptyHint");
        if (expBtn) expBtn.disabled = !hasAnyData;
        if (expHint) expHint.classList.toggle("hidden", hasAnyData);

        // Events hint
        const evHint = $("eventsHint");
        if (evHint) evHint.classList.toggle("hidden", hasAssets || hasLiabs);

        // Hide full cards for brand-new users
        const ForecastCard = $("ForecastCard");
        const forecastGoalsCard = $("forecastGoalsCard");
        if (ForecastCard) ForecastCard.hidden = !canForecast;
        if (forecastGoalsCard) forecastGoalsCard.hidden = !canForecast;
        const saveSnapCard = $("saveSnapshotCard");
        if (saveSnapCard) saveSnapCard.hidden = isFresh;
        const snapHistCard = $("snapshotHistoryCard");
        if (snapHistCard) snapHistCard.hidden = snapshots.length === 0;
        const progressCard = $("progressCheckCard");
        if (progressCard)
          progressCard.hidden = snapshots.length === 0 || !canForecast;
        const exportCard = $("exportCard");
        if (exportCard) exportCard.hidden = isFresh;
        const futureCard = $("futureValueCard");
        if (futureCard) futureCard.hidden = !hasAssets;
        const snapshotSection = $("snapshots");
        if (snapshotSection)
          snapshotSection.classList.toggle("hidden", isFresh);

        // Forecast navigation visibility
        const forecastBtn = document.querySelector('nav button[data-target="forecasts"]');
        if (forecastBtn) {
          const wasHidden = forecastBtn.classList.contains("hidden");
          forecastBtn.classList.toggle("hidden", !canForecast);
          if (canForecast && wasHidden) {
            forecastBtn.classList.add("fade-in");
            setTimeout(() => forecastBtn.classList.remove("fade-in"), 500);
          }
        }
        if (!canForecast && $("forecasts").classList.contains("active")) {
          navigateTo("data-entry");
        }

        // Portfolio navigation visibility
        const portfolioBtn = document.querySelector('nav button[data-target="portfolio-analysis"]');
        if (portfolioBtn) {
          const wasHidden = portfolioBtn.classList.contains("hidden");
          portfolioBtn.classList.toggle("hidden", !hasAssets);
          if (hasAssets && wasHidden) {
            portfolioBtn.classList.add("fade-in");
            setTimeout(() => portfolioBtn.classList.remove("fade-in"), 500);
          }
        }
        if (!hasAssets && $("portfolio-analysis").classList.contains("active")) {
          navigateTo("data-entry");
        }

        const snapshotsBtn = document.querySelector('nav button[data-target="snapshots"]');
        const hasSnapshotAccess = !isFresh;
        if (snapshotsBtn) {
          const wasHidden = snapshotsBtn.classList.contains("hidden");
          snapshotsBtn.classList.toggle("hidden", !hasSnapshotAccess);
          if (hasSnapshotAccess && wasHidden) {
            snapshotsBtn.classList.add("fade-in");
            setTimeout(() => snapshotsBtn.classList.remove("fade-in"), 500);
          }
        }
        if (!hasSnapshotAccess && $("snapshots").classList.contains("active")) {
          navigateTo("data-entry");
        }
      }

      // Rendering
      function renderAssets() {
        const tableBody = $("assetTableBody");
        const tableContainer = tableBody.closest(".overflow-x-auto");
        tableContainer.hidden = assets.length === 0;

        const sorted =
          typeof sortAssetsForView === "function"
            ? sortAssetsForView([...assets])
            : [...assets].sort((a, b) => a.name.localeCompare(b.name));

        tableBody.innerHTML = sorted
          .map((asset) => {
            const originalIndex = assets.findIndex((a) => a === asset);
            const currentValue = calculateCurrentValue(asset);
            const hasDeposit =
              asset.originalDeposit > 0 && asset.frequency !== "none";
            const depositText = hasDeposit
              ? `${fmtGBP(asset.originalDeposit)} (${asset.frequency})`
              : "-";
            const explicitStart = toTimestamp(asset.explicitStartDate);
            let startCell = "-";
            if (explicitStart != null) {
              const startLabel = fmtDate(new Date(explicitStart));
              const isUpcoming = explicitStart > Date.now();
              startCell = isUpcoming
                ? `${startLabel}<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100">Upcoming</span>`
                : startLabel;
            }
            const passiveBadge =
              asset.includeInPassive !== false
                ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100" title="Included in Current Passive Income Estimates">Passive Income</span>'
                : "";
            return `<tr class="text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
          <td class="px-6 py-4 whitespace-nowrap">${asset.name}${passiveBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap">${startCell}</td>
          <td class="px-6 py-4 whitespace-nowrap font-semibold">${fmtGBP(currentValue)}</td>
          <td class="px-6 py-4 whitespace-nowrap">${depositText}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="text-xs text-gray-500 dark:text-gray-400">Low:</span> ${asset.lowGrowth || 0}%
            <span class="ml-3 text-xs text-gray-500 dark:text-gray-400">Exp:</span> ${asset.return || 0}%
            <span class="ml-3 text-xs text-gray-500 dark:text-gray-400">High:</span> ${asset.highGrowth || 0}%
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center gap-2">
            <button data-action="edit-asset" data-index="${originalIndex}" class="btn-icon" title="Edit Asset">
              <svg class="h-5 w-5" fill="currentColor"><use href="#i-edit"/></svg>
            </button>
            <button data-action="delete-asset" data-index="${originalIndex}" class="btn-icon text-red-600 hover:text-red-900 dark:text-red-500 dark:hover:text-red-400" title="Delete Asset">
              <svg class="h-5 w-5" fill="currentColor"><use href="#i-bin"/></svg>
            </button>
          </td>
        </tr>`;
          })
          .join("");

        updateTotals();
        renderEventAssetOptions();
        renderFutureValueAssetOptions();
        renderStressAssetOptions();
        persist();
        updateWealthChart();
        renderAssetBreakdownChart();
        updatePassiveIncome();
      }

      function renderEventAssetOptions(sel = $("eventAsset")) {
        if (!sel) return;
        const current = sel.value;
        const opts = [...assets].sort((a, b) =>
          (a.name || "").localeCompare(b.name || "", undefined, {
            sensitivity: "base",
          }),
        );
        sel.innerHTML =
          '<option value="">None</option>' +
          opts
            .map((a) => `<option value="${a.dateAdded}">${a.name}</option>`)
            .join("");
        if (current) sel.value = current;
      }

      function renderFutureValueAssetOptions() {
        const sel = $("fvAsset");
        if (!sel) return;
        const opts = [...assets].sort((a, b) =>
          (a.name || "").localeCompare(b.name || "", undefined, {
            sensitivity: "base",
          }),
        );
        sel.innerHTML = opts
          .map((a) => `<option value="${a.dateAdded}">${a.name}</option>`)
          .join("");
      }

      function updateStressAssetsButtonLabel() {
        const btn = $("stressAssetsToggle");
        if (!btn) return;
        const total = assets.length;
        const selected = stressAssetIds.size;
        btn.textContent = selected === total ? "All Assets" : `${selected}/${total} Selected`;
      }

      function renderStressAssetOptions() {
        const menu = $("stressAssetsMenu");
        if (!menu) return;
        const currentIds = new Set(assets.map((a) => a.dateAdded));
        stressAssetIds.forEach((id) => {
          if (!currentIds.has(id)) stressAssetIds.delete(id);
        });
        assets.forEach((a) => stressAssetIds.add(a.dateAdded));
        const opts = [...assets].sort((a, b) =>
          (a.name || "").localeCompare(b.name || "", undefined, {
            sensitivity: "base",
          }),
        );
        menu.innerHTML = opts
          .map(
            (a) =>
              `<label class="flex items-center px-3 py-2"><input type="checkbox" data-id="${a.dateAdded}" class="mr-2" ${stressAssetIds.has(a.dateAdded) ? "checked" : ""}/><span>${a.name}</span></label>`
          )
          .join("");
        updateStressAssetsButtonLabel();
      }

      function renderLiabilities() {
        const tableBody = $("liabilityTableBody");
        if (!tableBody) return;
        const tableContainer = tableBody.closest(".overflow-x-auto");
        tableContainer.hidden = liabilities.length === 0;

        tableBody.innerHTML = liabilities
          .map((l, i) => {
            const hasPay = l.originalPayment > 0 && l.frequency !== "none";
            const payText = hasPay
              ? `${fmtGBP(l.originalPayment)} (${l.frequency})`
              : "-";
            const currentValue = calculateCurrentLiability(l);
            const explicitStart = toTimestamp(l.explicitStartDate);
            let startCell = "-";
            if (explicitStart != null) {
              const startLabel = fmtDate(new Date(explicitStart));
              const isUpcoming = explicitStart > Date.now();
              startCell = isUpcoming
                ? `${startLabel}<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100">Upcoming</span>`
                : startLabel;
            }
            return `<tr class="text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
          <td class="px-6 py-4 whitespace-nowrap">${l.name}</td>
          <td class="px-6 py-4 whitespace-nowrap">${startCell}</td>
          <td class="px-6 py-4 whitespace-nowrap font-semibold">${fmtGBP(currentValue)}</td>
          <td class="px-6 py-4 whitespace-nowrap">${payText}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center gap-2">
            <button data-action="edit-liability" data-index="${i}" class="btn-icon" title="Edit Liability">
              <svg class="h-5 w-5" fill="currentColor"><use href="#i-edit"/></svg>
            </button>
            <button data-action="delete-liability" data-index="${i}" class="btn-icon text-red-600 hover:text-red-900 dark:text-red-500 dark:hover:text-red-400" title="Delete Liability">
              <svg class="h-5 w-5" fill="currentColor"><use href="#i-bin"/></svg>
            </button>
          </td>
        </tr>`;
          })
          .join("");
        updateTotals();
        persist();
        updateWealthChart();
      }

      function updateTotals() {
        const totalAssets = assets.reduce(
          (sum, a) => sum + calculateCurrentValue(a),
          0,
        );
        const totalLiabs = liabilities.reduce(
          (sum, l) => sum + calculateCurrentLiability(l),
          0,
        );
        const current = fmtGBP(totalAssets - totalLiabs);
        const elWealthOld = $("totalWealth");
        const elWealthForecast = $("totalWealthForecast");
        if (elWealthOld) elWealthOld.textContent = current;
        if (elWealthForecast) elWealthForecast.textContent = current;
      }

      function renderEvents() {
        const body = $("eventTableBody");
        const container = body.closest(".overflow-x-auto");
        container.hidden = simEvents.length === 0;
        body.innerHTML = simEvents
          .map((ev, i) => {
            const assetName =
              assets.find((a) => a.dateAdded === ev.assetId)?.name || "-";
            const amt = ev.isPercent ? `${ev.amount}%` : fmtGBP(ev.amount);
            return `
          <tr class="text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
            <td class="px-6 py-4 whitespace-nowrap">${ev.name}</td>
            <td class="px-6 py-4 whitespace-nowrap">${fmtDate(new Date(ev.date))}</td>
            <td class="px-6 py-4 whitespace-nowrap">${ev.assetId ? assetName : "-"}</td>
            <td class="px-6 py-4 whitespace-nowrap font-semibold">${amt}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex items-center gap-2">
              <button data-action="edit-event" data-index="${i}" class="btn-icon" title="Edit Event">
                <svg class="h-5 w-5" fill="currentColor"><use href="#i-edit"/></svg>
              </button>
              <button data-action="delete-event" data-index="${i}" class="btn-icon text-red-600 hover:text-red-900 dark:text-red-500 dark:hover:text-red-400" title="Delete Event">
                <svg class="h-5 w-5" fill="currentColor"><use href="#i-bin"/></svg>
              </button>
            </td>
          </tr>`;
          })
          .join("");
        persist();
        updateWealthChart();
      }

      function renderSnapshots() {
        $("snapshotsHeader").style.display =
          snapshots.length > 0 ? "block" : "none";
        $("snapshotUl").innerHTML = snapshots
          .map(
            (s, i) => `
        <li class="py-3 border-b border-gray-200 last:border-b-0 dark:border-gray-700">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <span class="font-medium text-gray-900 dark:text-gray-100">${s.name}</span>
              <span class="text-gray-500 dark:text-gray-400 text-sm ml-2">(${fmtDate(new Date(s.date))})</span>
            </div>
            <div class="flex items-center justify-between gap-3 sm:justify-end">
              <span class="font-semibold text-gray-900 dark:text-gray-100">${fmtGBP(s.value)}</span>
              <button data-action="view-snapshot" data-index="${i}" class="hidden text-blue-500 hover:text-blue-700 sm:inline-block">View Details</button>
              <button data-action="rename-snapshot" data-index="${i}" class="hidden sm:inline-flex btn-icon text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200" title="Rename Snapshot">
                <svg class="h-5 w-5" fill="currentColor"><use href="#i-edit"/></svg>
              </button>
              <button data-action="delete-snapshot" data-index="${i}" class="hidden sm:inline-flex btn-icon text-red-600 hover:text-red-900 dark:text-red-500 dark:hover:text-red-400" title="Delete Snapshot">
                <svg class="h-5 w-5" fill="currentColor"><use href="#i-bin"/></svg>
              </button>
              <div class="relative sm:hidden">
                <button
                  type="button"
                  class="btn btn-gray px-3 py-1.5 text-sm font-medium flex items-center gap-2"
                  data-action="toggle-snapshot-actions"
                  data-index="${i}"
                  data-snapshot-toggle="${i}"
                  aria-expanded="false"
                >
                  Actions
                  <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" />
                  </svg>
                </button>
                <div
                  class="hidden absolute right-0 mt-2 w-44 rounded-lg border border-gray-200 bg-white py-1 shadow-lg z-20 dark:border-gray-600 dark:bg-gray-700"
                  data-snapshot-menu="${i}"
                >
                  <button type="button" data-action="view-snapshot" data-index="${i}" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-600">View Details</button>
                  <button type="button" data-action="rename-snapshot" data-index="${i}" class="block w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-600">Rename</button>
                  <button type="button" data-action="delete-snapshot" data-index="${i}" class="block w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 dark:text-red-400 dark:hover:bg-gray-600">Delete</button>
                </div>
              </div>
            </div>
          </div>
        </li>`,
          )
          .join("");
        closeSnapshotActionMenus();
        updateSnapshotChart();
        renderProgressCheck();
      }

      function closeSnapshotActionMenus() {
        document
          .querySelectorAll("[data-snapshot-menu]")
          .forEach((menu) => menu.classList.add("hidden"));
        document
          .querySelectorAll("[data-snapshot-toggle]")
          .forEach((btn) => btn.setAttribute("aria-expanded", "false"));
      }

      function renderProgressCheck() {
        const card = $("progressCheckCard");
        const empty = $("progressCheckEmpty");
        const controls = $("progressCheckControls");
        const select = $("progressCheckSelect");
        const result = $("progressCheckResult");
        if (!card || !select || !result) return;

        if (snapshots.length === 0) {
          if (empty) empty.classList.remove("hidden");
          if (controls) controls.classList.add("hidden");
          select.innerHTML = "";
          progressCheckSelection = null;
          result.innerHTML =
            '<p class="text-sm text-gray-500 dark:text-gray-400">Take a snapshot to unlock progress comparisons.</p>';
          return;
        }

        if (empty) empty.classList.add("hidden");
        if (controls) controls.classList.remove("hidden");

        const previousSelection = progressCheckSelection;
        const options = snapshots
          .map(
            (s) =>
              `<option value="${s.date}">${s.name} (${fmtDate(new Date(s.date))})</option>`,
          )
          .join("");
        select.innerHTML = options;

        const hasPrev = previousSelection
          ? snapshots.some((s) => s.date === previousSelection)
          : false;
        const selectedValue = hasPrev
          ? previousSelection
          : snapshots[snapshots.length - 1].date;
        select.value = selectedValue;
        progressCheckSelection = selectedValue;

        select.onchange = (ev) => {
          progressCheckSelection = ev.target.value;
          updateProgressCheckResult();
        };

        updateProgressCheckResult();
      }

      function updateProgressCheckResult() {
        const select = $("progressCheckSelect");
        const result = $("progressCheckResult");
        if (!select || !result) return;

        if (snapshots.length === 0) {
          result.innerHTML =
            '<p class="text-sm text-gray-500 dark:text-gray-400">Take a snapshot to unlock progress comparisons.</p>';
          return;
        }

        const selectedDate = select.value;
        const snapshot = snapshots.find((s) => s.date === selectedDate);
        if (!snapshot) {
          result.innerHTML =
            '<p class="text-sm text-gray-500 dark:text-gray-400">Select a snapshot to see its saved forecast comparison.</p>';
          return;
        }

        const forecastSeries = snapshot.forecast || snapshot.expectedForecast;
        if (!Array.isArray(forecastSeries) || forecastSeries.length === 0) {
          result.innerHTML =
            '<p class="text-sm text-gray-500 dark:text-gray-400">This snapshot does not include saved forecast data. Capture a new snapshot to compare forecasts.</p>';
          return;
        }

        const now = new Date();
        now.setHours(0, 0, 0, 0);
        // Ensure data is sorted and valid
        const series = forecastSeries
          .map((e) => ({ date: new Date(e.date), value: Number(e.value) }))
          .filter((e) => !Number.isNaN(e.date.getTime()) && Number.isFinite(e.value))
          .sort((a, b) => a.date - b.date);

        if (series.length === 0) {
          result.innerHTML =
            '<p class="text-sm text-gray-500 dark:text-gray-400">Saved forecast data for this snapshot could not be read.</p>';
          return;
        }

        // Find bounding points around "now"
        let prev = null;
        let next = null;
        for (const pt of series) {
          if (pt.date <= now) prev = pt;
          if (pt.date >= now) {
            next = pt;
            break;
          }
        }

        let forecastValue;
        let comparisonDate = now;
        if (prev && next && prev.date.getTime() !== next.date.getTime()) {
          // Linear interpolation between prev and next
          const span = next.date - prev.date;
          const alpha = Math.min(1, Math.max(0, (now - prev.date) / span));
          forecastValue = prev.value + alpha * (next.value - prev.value);
        } else if (prev) {
          // After last known point; use last value
          forecastValue = prev.value;
        } else if (next) {
          // Before first known point; use first value
          forecastValue = next.value;
        } else {
          result.innerHTML =
            '<p class="text-sm text-gray-500 dark:text-gray-400">Saved forecast data for this snapshot could not be read.</p>';
          return;
        }

        const currentNetWorth = calculateNetWorth();
        const diff = currentNetWorth - forecastValue;
        const tolerance = 1;
        const diffAbs = fmtGBP(Math.abs(diff));
        const diffSigned =
          diff > tolerance ? `+${diffAbs}` : diff < -tolerance ? `-${diffAbs}` : diffAbs;
        const statusClass =
          diff > tolerance
            ? "text-green-600 dark:text-green-400"
            : diff < -tolerance
              ? "text-red-600 dark:text-red-400"
              : "text-blue-600 dark:text-blue-400";
        const statusText =
          diff > tolerance
            ? `You're ahead of this saved forecast by ${diffAbs}.`
            : diff < -tolerance
              ? `You're behind this saved forecast by ${diffAbs}.`
              : `You're tracking this saved forecast closely (within ${diffAbs}).`;

        result.innerHTML = `
          <div class="space-y-3">
            <p class="text-sm text-gray-600 dark:text-gray-300">
              Saved forecast from <strong>${snapshot.name}</strong> expected <span class="whitespace-nowrap">${fmtGBP(
                forecastValue,
              )}</span> by ${fmtDate(comparisonDate)}.
            </p>
            <div class="grid grid-cols-1 gap-3 md:grid-cols-3">
              <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-700">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Current Net Worth</p>
                <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">${fmtGBP(
                  currentNetWorth,
                )}</p>
              </div>
              <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-700">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Projected by Now</p>
                <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">${fmtGBP(
                  forecastValue,
                )}</p>
              </div>
              <div class="rounded-lg bg-gray-100 p-3 dark:bg-gray-700">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">Difference</p>
                <p class="text-lg font-semibold ${statusClass}">${diffSigned}</p>
                <p class="text-xs mt-1 ${statusClass}">${statusText}</p>
              </div>
            </div>
          </div>
        `;
      }

      function updateWealthChart() {
        const hasData =
          assets.length > 0 ||
          liabilities.length > 0 ||
          goalValue > 0 ||
          goalTargetDate;
        $("wealthChart").hidden = !hasData;
        $("wealthChartMessage").hidden = hasData;
        if (!hasData) {
          wealthChart?.destroy();
          wealthChart = null;
          lastForecastScenarios = null;
          assetForecasts = new Map();
          liabilityForecasts = new Map();
          refreshFireProjection();
          return;
        }

        const {
          labels,
          base,
          low,
          high,
          minSeriesValue,
          currentBaseline,
        } = buildForecastScenarios();

        const datasets = [
          {
            label: "Low Growth",
            data: low.map((y, i) => ({ x: labels[i], y })),
            borderColor: CHART_COLOURS.red,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 1,
            pointHoverRadius: 6,
            pointHitRadius: 8,
            pointStyle: "circle",
            pointBackgroundColor: CHART_COLOURS.red,
            pointBorderColor: CHART_COLOURS.red,
            pointBorderWidth: 1.5,
          },
          {
            label: "Expected Growth",
            data: base.map((y, i) => ({ x: labels[i], y })),
            borderColor: CHART_COLOURS.blue,
            borderDash: [5, 5],
            backgroundColor: CHART_COLOURS.blueFill,
            tension: 0.4,
            fill: false,
            pointRadius: 1,
            pointHoverRadius: 6,
            pointHitRadius: 8,
            pointStyle: "circle",
            pointBackgroundColor: CHART_COLOURS.blue,
            pointBorderColor: CHART_COLOURS.blue,
            pointBorderWidth: 1.5,
          },
          {
            label: "High Growth",
            data: high.map((y, i) => ({ x: labels[i], y })),
            borderColor: CHART_COLOURS.green,
            borderDash: [5, 5],
            fill: false,
            pointRadius: 1,
            pointHoverRadius: 6,
            pointHitRadius: 8,
            pointStyle: "circle",
            pointBackgroundColor: CHART_COLOURS.green,
            pointBorderColor: CHART_COLOURS.green,
            pointBorderWidth: 1.5,
          },
        ];

        if (currentBaseline > 0) {
          datasets.push({
            label: "Current (Baseline)",
            data: labels.map((d) => ({ x: d, y: currentBaseline })),
            borderColor: "#6b7280",
            pointRadius: 0,
            borderDash: [2, 2],
            fill: false,
          });
        }

        if (goalValue > 0) {
          datasets.push({
            label: "Wealth Goal",
            data: labels.map((d) => ({ x: d, y: goalValue })),
            borderColor: "#ef4444",
            pointRadius: 0,
            fill: false,
          });
        }

        // Anchor the y-axis to current total wealth for a stable baseline
        const minStart = Math.min(currentBaseline, minSeriesValue);
        let yOpts = {
          max: goalValue > 0 ? goalValue * 1.1 : undefined,
          ticks: { callback: gbpTick },
        };

        if (minStart > 0) {
          const suggested = minStart * 0.9;
          const magnitude = Math.pow(10, Math.floor(Math.log10(suggested)));
          let unit = magnitude / 2;
          if (unit < 1) unit = 1;
          yOpts.min = Math.floor(suggested / unit) * unit;
        } else if (minStart < 0) {
          const abs = Math.abs(minStart);
          const magnitude = Math.pow(10, Math.floor(Math.log10(abs)));
          let unit = magnitude / 2;
          if (unit < 1) unit = 1;
          yOpts.min = -Math.ceil(abs / unit) * unit;
        } else {
          yOpts.beginAtZero = true;
        }

        // Determine initial x-axis window. If goal is set and the Low Forecast
        // reaches it earlier than the full horizon, default the view to that
        // point so the data is better distributed horizontally.
        let xMin = labels[0];
        let xMax = labels[labels.length - 1];

        if (goalValue > 0) {
          const hitIdx = low.findIndex((v) => v >= goalValue);
          if (hitIdx >= 0) {
            // Add a small buffer (6 months) beyond the hit point so the
            // marker isn't flush against the right edge and is easier to select.
            const bufferMonths = 6;
            const paddedIdx = Math.min(
              hitIdx + bufferMonths,
              labels.length - 1,
            );
            xMax = labels[paddedIdx];
          }
        }

        const config = {
          type: "line",
          data: { datasets },
          options: {
            ...baseLineOpts,
            scales: {
              ...baseLineOpts.scales,
              x: { ...baseLineOpts.scales.x, min: xMin, max: xMax },
              y: { ...baseLineOpts.scales.y, ...yOpts },
            },
            plugins: {
              ...baseLineOpts.plugins,
              zoom: {
                ...baseLineOpts.plugins.zoom,
                // Prevent zooming/panning outside data bounds and beyond full range
                limits: {
                  x: {
                    min: labels[0].getTime(),
                    max: labels[labels.length - 1].getTime(),
                    maxRange:
                      labels[labels.length - 1].getTime() - labels[0].getTime(),
                  },
                },
                pan: {
                  ...baseLineOpts.plugins.zoom.pan,
                  onPan: ({ chart }) => adaptChartToZoom(chart),
                  onPanComplete: ({ chart }) => adaptChartToZoom(chart),
                },
                zoom: {
                  ...baseLineOpts.plugins.zoom.zoom,
                  onZoom: ({ chart }) => adaptChartToZoom(chart),
                  onZoomComplete: ({ chart }) => adaptChartToZoom(chart),
                },
              },

              tooltip: {
                callbacks: {
                  label: (c) => `${c.dataset.label}: ${fmtGBP(c.raw.y)}`,
                  footer: (items) => {
                    const [item] = items;
                    const { dataIndex, dataset } = item;
                    if (
                      dataset.label.includes("Goal") ||
                      dataset.label.includes("Baseline")
                    )
                      return "";
                    const scenario = dataset.label.includes("Low")
                      ? "low"
                      : dataset.label.includes("High")
                        ? "high"
                        : "base";
                    const assetLines = [...assets]
                      .sort((a, b) =>
                        (a.name || "").localeCompare(b.name || "", undefined, {
                          sensitivity: "base",
                        }),
                      )
                      .map((a) => {
                        const forecast =
                          assetForecasts.get(a.dateAdded)?.[scenario]?.[
                            dataIndex
                          ] ?? 0;
                        return `  ${a.name}: ${fmtGBP(forecast)}`;
                      });
                    const liabLines = [...liabilities]
                      .sort((a, b) =>
                        (a.name || "").localeCompare(b.name || "", undefined, {
                          sensitivity: "base",
                        }),
                      )
                      .map((l) => {
                        const forecast =
                          liabilityForecasts.get(l.dateAdded)?.[dataIndex] ?? 0;
                        return `  ${l.name}: ${fmtGBP(forecast)}`;
                      });
                    const lines = [...assetLines, ...liabLines];
                    return lines.length
                      ? ["\nForecast breakdown:", ...lines]
                      : [];
                  },
                },
              },
            },
          },
        };

        wealthChart = ensureChart(
          wealthChart,
          $("wealthChart").getContext("2d"),
          config,
        );
        adaptChartToZoom(wealthChart);
        updateChartTheme();

        const wrap = $("forecastGoalsDates");
        wrap.innerHTML = "";
        if (goalValue > 0 && assets.length > 0) {
          const getHit = (arr) => {
            for (let i = 1; i < arr.length; i++) {
              if (arr[i].y >= goalValue) return arr[i].x;
            }
            return null;
          };
          // Datasets are ordered: 0=Low, 1=Expected, 2=High
          const lowHit = getHit(config.data.datasets[0].data);
          const expHit = getHit(config.data.datasets[1].data);
          const highHit = getHit(config.data.datasets[2].data);

          const fmt = (d) => {
            if (d)
              return d.toLocaleString("default", { month: "short", year: "numeric" });
            const y = getGoalTargetYear();
            return y ? `Not met by ${y}` : "Not met in 30 years";
          };
          const cls = (d) => (d ? "text-green-500 " : "text-red-600");
          wrap.innerHTML = `
          <div class="md:col-span-3 text-left text-sm text-gray-600 dark:text-gray-300">
            <strong>Goal achieved by</strong> (estimates based on your inputs):
          </div>
          <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box">
            <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-center gap-1">Low Growth
              <span class="relative group inline-block align-middle cursor-help">
                <span class="text-gray-400">?</span>
                <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">Estimated date your goal will be achieved using low growth.</span>
              </span>
            </h5>
            <p class="${cls(lowHit)}">${fmt(lowHit)}</p>
          </div>
          <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box">
            <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-center gap-1">Expected Growth
              <span class="relative group inline-block align-middle cursor-help">
                <span class="text-gray-400">?</span>
                <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">Estimated date your goal will be achieved using expected growth.</span>
              </span>
            </h5>
            <p class="${cls(expHit)}">${fmt(expHit)}</p>
          </div>
          <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box">
            <h5 class="font-bold text-gray-900 dark:text-gray-100 flex items-center justify-center gap-1">High Growth
              <span class="relative group inline-block align-middle cursor-help">
                <span class="text-gray-400">?</span>
                <span class="hidden group-hover:block absolute z-50 mt-2 w-64 p-3 rounded-lg shadow bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 text-xs">Estimated date your goal will be achieved using high growth.</span>
              </span>
            </h5>
            <p class="${cls(highHit)}">${fmt(highHit)}</p>
          </div>`;
        }

        updateInflationImpactCard();
        updateProgressCheckResult();
        refreshFireProjection();
        updateFireForecastCard();
      }

      function getGoalHitsFromChart() {
        if (!wealthChart || !goalValue) return null;
        const ds = wealthChart.data?.datasets || [];
        const getHit = (arr) => {
          if (!arr) return null;
          for (let i = 1; i < arr.length; i++) if (arr[i].y >= goalValue) return arr[i].x;
          return null;
        };
        return {
          low: getHit(ds[0]?.data),
          base: getHit(ds[1]?.data),
          high: getHit(ds[2]?.data),
        };
      }

      function updateInflationImpactCard() {
        const lowEl = $("inflLow"), expEl = $("inflExpected"), highEl = $("inflHigh");
        const lowYearEl = $("inflLowYear"), expYearEl = $("inflExpectedYear"), highYearEl = $("inflHighYear");
        const lowEqEl = $("inflLowEq"), expEqEl = $("inflExpectedEq"), highEqEl = $("inflHighEq");
        const rateInput = $("inflationRate");
        const container = $("inflationImpactCard");
        if (!lowEl || !expEl || !highEl || !container) return;
        const hasPrereq = goalValue > 0 && (assets.length > 0 || liabilities.length > 0);
        const rate = Math.max(0, parseFloat(rateInput?.value ?? inflationRate) || 0) / 100;
        const hits = getGoalHitsFromChart();
        const now = new Date();
        const yearsTo = (date) => {
          if (!date) return null;
          return Math.max(0, (date - now) / (1000 * 60 * 60 * 24 * 365.25));
        };
        const pv = (date) => {
          const years = yearsTo(date);
          if (years == null) return null;
          return goalValue / Math.pow(1 + rate, years);
        };
        const fv = (date) => {
          const years = yearsTo(date);
          if (years == null) return null;
          return goalValue * Math.pow(1 + rate, years);
        };
        const missText = () => {
          const y = getGoalTargetYear();
          return y ? `Not met by ${y}` : "Not met in 30 years";
        };
        const setVal = (el, yearEl, date, val) => {
          if (!el) return;
          if (!date) {
            el.textContent = missText();
            el.className = "mt-1 text-red-600";
            if (yearEl) yearEl.textContent = "";
          } else {
            el.textContent = fmtGBP(val || 0);
            el.className = "mt-1 text-green-500";
            if (yearEl) {
              yearEl.textContent = `Year: ${new Date(date).getFullYear()}`;
              yearEl.className = "text-xs text-gray-500 dark:text-gray-400";
            }
          }
        };
        if (!hasPrereq) {
          if (lowEl) { lowEl.textContent = "N/A"; lowEl.className = "mt-1"; }
          if (expEl) { expEl.textContent = "N/A"; expEl.className = "mt-1"; }
          if (highEl) { highEl.textContent = "N/A"; highEl.className = "mt-1"; }
          if (lowYearEl) lowYearEl.textContent = "";
          if (expYearEl) expYearEl.textContent = "";
          if (highYearEl) highYearEl.textContent = "";
          if (lowEqEl) lowEqEl.textContent = "";
          if (expEqEl) expEqEl.textContent = "";
          if (highEqEl) highEqEl.textContent = "";
          return;
        }
        const lowV = pv(hits?.low);
        const baseV = pv(hits?.base);
        const highV = pv(hits?.high);
        const lowF = fv(hits?.low);
        const baseF = fv(hits?.base);
        const highF = fv(hits?.high);
        setVal(lowEl, lowYearEl, hits?.low, lowV);
        setVal(expEl, expYearEl, hits?.base, baseV);
        setVal(highEl, highYearEl, hits?.high, highV);
        if (lowEqEl) lowEqEl.textContent = hits?.low ? `Equivalent that year: ${fmtGBP(lowF || 0)}` : "";
        if (expEqEl) expEqEl.textContent = hits?.base ? `Equivalent that year: ${fmtGBP(baseF || 0)}` : "";
        if (highEqEl) highEqEl.textContent = hits?.high ? `Equivalent that year: ${fmtGBP(highF || 0)}` : "";
      }

      function renderAssetBreakdownChart() {
        const has = assets.length > 0;
        $("assetBreakdownChart").hidden = !has;
        $("noAssetMessage").hidden = has;
        if (!has) {
          assetBreakdownChart?.destroy();
          assetBreakdownChart = null;
          return;
        }

        const colorFor = (i) => `hsl(${(i * 57) % 360},70%,60%)`;
        const data = {
          labels: assets.map((a) => a.name),
          datasets: [
            {
              data: assets.map((asset) => calculateCurrentValue(asset)),
              backgroundColor: assets.map((_, i) => colorFor(i)),
            },
          ],
        };
        const cfg = {
          type: "pie",
          data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "top" },
              tooltip: { callbacks: { label: pieTooltip } },
            },
          },
        };
        assetBreakdownChart = ensureChart(
          assetBreakdownChart,
          $("assetBreakdownChart").getContext("2d"),
          cfg,
        );
        updateChartTheme();
      }

      function updateSnapshotChart() {
        const has = snapshots.length > 0;
        $("snapshotChart").hidden = !has;
        $("noSnapshotMessage").hidden = has;
        if (!has) {
          snapshotChart?.destroy();
          snapshotChart = null;
          return;
        }

        const labels = snapshots.map((s) => fmtDate(new Date(s.date)));
        const totals = {};
        snapshots.forEach((s) =>
          s.assets.forEach((a) => {
            totals[a.name] = (totals[a.name] || 0) + a.value;
          }),
        );
        const names = Object.keys(totals).sort((a, b) => totals[b] - totals[a]);

        const colorFor = (i) => `hsl(${(i * 57) % 360},70%,60%)`;
        const datasets = names.map((name, i) => ({
          label: name,
          data: snapshots.map(
            (s) => s.assets.find((a) => a.name === name)?.value || 0,
          ),
          backgroundColor: colorFor(i),
        }));

        const data = { labels, datasets };
        const cfg = {
          type: "bar",
          data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                stacked: true,
                ticks: { callback: gbpTick },
              },
              x: { stacked: true },
            },
            plugins: {
              tooltip: {
                callbacks: {
                  label: (c) => `${c.dataset.label}: ${fmtGBP(c.raw)}`,
                },
              },
            },
          },
        };
        snapshotChart = ensureChart(
          snapshotChart,
          $("snapshotChart").getContext("2d"),
          cfg,
        );
        updateChartTheme();
      }

      function randomNormal(mean = 0, std = 1) {
        const u1 = Math.random();
        const u2 = Math.random();
        const randStdNormal =
          Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
        return mean + std * randStdNormal;
      }

      function generateRandomEvents(labels, assetIdSet = null) {
        if (!assets.length) return [];
        const years = Array.from(new Set(labels.map((d) => d.getFullYear())));
        const events = [];
        const assetList = assetIdSet
          ? assets.filter((a) => assetIdSet.has(a.dateAdded))
          : assets;
        years.forEach((y) => {
          assetList.forEach((a) => {
            if (Math.random() < 0.3) {
              const m = Math.floor(Math.random() * 12);
              const amt = Math.max(-15, Math.min(15, randomNormal(0, 5)));
              events.push({
                name: a.name,
                assetId: a.dateAdded,
                amount: amt,
                isPercent: true,
                date: new Date(y, m, 1).getTime(),
              });
            }
          });
        });
        return events;
      }

      function forecastGoalDate(
        extraEvents = [],
        scenario = "base",
        assetIdSet = null,
      ) {
        const years = getGoalHorizonYears();
        const labels = getForecastLabels(years);
        const totalMonths = years * 12;
        let base = Array(labels.length).fill(0);

        const globalEvents = [];
        const eventsByAsset = new Map();
        const assetList = assetIdSet
          ? assets.filter((a) => assetIdSet.has(a.dateAdded))
          : assets;
        const assetIds = new Set(assetList.map((a) => a.dateAdded));
        [...simEvents, ...extraEvents].forEach((ev) => {
          if (ev.assetId) {
            if (assetIds.has(ev.assetId)) {
              if (!eventsByAsset.has(ev.assetId))
                eventsByAsset.set(ev.assetId, []);
              eventsByAsset.get(ev.assetId).push(ev);
            }
          } else {
            globalEvents.push(ev);
          }
        });

        assetList.forEach((a) => {
          const principal = calculateCurrentValue(a);
          const assetEvents = (eventsByAsset.get(a.dateAdded) || []).sort(
            (x, y) => x.date - y.date,
          );
          let evIdx = 0;
          let v = principal;
          const r =
            (scenario === "low"
              ? a.lowGrowth || a.return || 0
              : scenario === "high"
                ? a.highGrowth || a.return || 0
                : a.return || 0) /
            100 /
            12;
          for (let i = 0; i <= totalMonths; i++) {
            const currentDate = labels[i];
            while (
              evIdx < assetEvents.length &&
              currentDate >= new Date(assetEvents[evIdx].date)
            ) {
              const evt = assetEvents[evIdx];
              v = evt.isPercent ? v * (1 + evt.amount / 100) : v + evt.amount;
              evIdx++;
            }
            base[i] += v;
            v = v * (1 + r) + a.monthlyDeposit;
          }
        });

        globalEvents.forEach((ev) => {
          const d = new Date(ev.date);
          const idx = labels.findIndex((label) => label >= d);
          if (idx >= 0) {
            if (ev.isPercent) {
              const factor = 1 + ev.amount / 100;
              for (let i = idx; i <= totalMonths; i++) base[i] *= factor;
            } else {
              for (let i = idx; i <= totalMonths; i++) base[i] += ev.amount;
            }
          }
        });

        const hitIdx = base.findIndex((v) => v >= goalValue);
        return { hitDate: hitIdx >= 0 ? labels[hitIdx] : null };
      }

      function runStressTest(iterations, scenario, assetIds) {
        const years = getGoalHorizonYears();
        const labels = getForecastLabels(years);
        const idSet = new Set(assetIds);
        const baseline = forecastGoalDate([], scenario, idSet).hitDate;
        const results = [];
        let sample = null;
        for (let i = 0; i < iterations; i++) {
          const randomEvents = generateRandomEvents(labels, idSet);
          const { hitDate } = forecastGoalDate(randomEvents, scenario, idSet);
          results.push(hitDate);
          if (!sample) sample = { events: randomEvents, hitDate };
        }
        const reached = results.filter((d) => !!d).sort((a, b) => a - b);
        const pct = results.length
          ? (reached.length / results.length) * 100
          : 0;
        const median = reached.length
          ? reached[Math.floor(reached.length / 2)]
          : null;
        return {
          baseline,
          pct,
          earliest: reached[0] || null,
          median,
          latest: reached[reached.length - 1] || null,
          sample,
        };
      }

      function navigateTo(viewId) {
        if (viewId === "forecasts" && !(assets.length > 0 && goalValue > 0 && goalTargetDate)) {
          showAlert(
            "Add at least one asset and set a wealth goal and target year to unlock Forecasts."
          );
          viewId = "data-entry";
        }
        if (viewId === "portfolio-analysis" && assets.length === 0) {
          showAlert("Add at least one asset to view Portfolio Insights.");
          viewId = "data-entry";
        }
        if (
          viewId === "snapshots" &&
          !(assets.length || liabilities.length || snapshots.length)
        ) {
          showAlert("Add some financial data before using Snapshots.");
          viewId = "data-entry";
        }
        document
          .querySelectorAll("nav button")
          .forEach((b) => b.classList.remove("active-nav-button"));
        document
          .querySelector(`nav button[data-target="${viewId}"]`)
          .classList.add("active-nav-button");
        document
          .querySelectorAll(".content-section")
          .forEach((s) => s.classList.remove("active"));
        $(viewId).classList.add("active");
        if (viewId === "portfolio-analysis") {
          renderAssetBreakdownChart();
        }
        if (viewId === "snapshots") {
          updateSnapshotChart();
        }

        // One-off onboarding when arriving to Assets & Goals after "Start Now"
        if (viewId === "data-entry") {
          try {
            const pending = localStorage.getItem(LS.onboardPending) === "1";
            const seen = localStorage.getItem(LS.onboardSeen) === "1";
            // Show onboarding if user explicitly asked (pending) OR hasn't seen it before
            if (pending || !seen) {
              const tpl = document.importNode(
                $("tpl-onboard-data").content,
                true,
              );
              openModalNode(tpl);
              localStorage.setItem(LS.onboardPending, "0");
              localStorage.setItem(LS.onboardSeen, "1");
            }
          } catch (_) {}
          // Keep empty states fresh when navigating back to Assets & Goals
          updateEmptyStates();
        } else if (viewId === "forecasts") {
          updateEmptyStates();
          try {
            const seen = localStorage.getItem(LS.forecastTip) === "1";
            if (!seen) {
              const tpl = document.importNode(
                $("tpl-onboard-forecast").content,
                true,
              );
              openModalNode(tpl);
              localStorage.setItem(LS.forecastTip, "1");
            }
          } catch (_) {}
        }

        // Hide Start Now on welcome if user already has assets
        if (viewId === "welcome") {
          const hasAssets = assets && assets.length > 0;
          const btn = $("startNowBtn");
          if (btn) btn.classList.toggle("hidden", !!hasAssets);
        }

        if (viewId === "settings") {
          const val = localStorage.getItem(LS.themeChoice) || "default";
          const sel = document.getElementById("themeSelect");
          if (sel)
            sel.value = ["inverted", "glass"].includes(val) ? val : "default";
        }

        // Ensure Inflation Impact card only shows on Portfolio Insights
        const inflCard = $("inflationImpactCard");
        if (inflCard)
          inflCard.style.display = viewId === "portfolio-analysis" ? "" : "none";
      }

      // Collapse/expand cards by clicking their headers
      function setupCardCollapsing() {
        const sanitize = (s) =>
          (s || "")
            .toLowerCase()
            .trim()
            .replace(/[^a-z0-9]+/g, "-")
            .replace(/(^-|-$)/g, "");
        document
          .querySelectorAll(
            "#data-entry .card, #forecasts .card, #portfolio-analysis .card, #snapshots .card",
          )
          .forEach((card, idx) => {
            card.classList.add("is-collapsible");
            const header = card.querySelector("h3, h4");
            if (!header) return;
            if (card.dataset.collapseInit === "1") return;
            card.dataset.collapseInit = "1";

            // Wrap body content to enable height animation
            let body = card.querySelector(".card-body");
            if (!body) {
              body = document.createElement("div");
              body.className = "card-body";
              const frag = document.createDocumentFragment();
              let node = header.nextSibling;
              while (node) {
                const next = node.nextSibling;
                frag.appendChild(node);
                node = next;
              }
              body.appendChild(frag);
              card.appendChild(body);
            }

            // Ensure a stable id to persist collapse state
            const title = header.textContent || `card-${idx + 1}`;
            const baseId = card.id
              ? `id:${card.id}`
              : `title:${sanitize(title)}`;
            const key = `cardCollapsed:${baseId}`;
            card.dataset.collapseKey = key;

            // Inject chevron if not present
            if (!header.querySelector(".chev")) {
              const chev = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "svg",
              );
              chev.setAttribute("viewBox", "0 0 24 24");
              chev.setAttribute("width", "20");
              chev.setAttribute("height", "20");
              chev.classList.add("chev");
              const path = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "path",
              );
              path.setAttribute("d", "M8 10l4 4 4-4");
              path.setAttribute("fill", "none");
              path.setAttribute("stroke", "currentColor");
              path.setAttribute("stroke-width", "2");
              path.setAttribute("stroke-linecap", "round");
              path.setAttribute("stroke-linejoin", "round");
              chev.appendChild(path);
              header.appendChild(chev);
            }

            header.setAttribute("role", "button");
            header.setAttribute("tabindex", "0");

            const setInitialState = () => {
              const collapsed = localStorage.getItem(key) === "1";
              header.setAttribute(
                "aria-expanded",
                collapsed ? "false" : "true",
              );
              if (collapsed) {
                card.classList.add("collapsed");
                body.style.height = "0px";
                body.style.opacity = "0";
              } else {
                card.classList.remove("collapsed");
                body.style.height = "auto";
                body.style.opacity = "1";
              }
            };
            setInitialState();

            const expand = () => {
              card.classList.remove("collapsed");
              // measure target height
              body.style.height = "auto";
              const target = body.scrollHeight;
              body.style.height = "0px";
              body.style.opacity = "0";
              // reflow
              void body.offsetHeight;
              body.style.height = `${target}px`;
              body.style.opacity = "1";
              const onEnd = (e) => {
                if (e.propertyName === "height") {
                  body.style.height = "auto";
                  body.removeEventListener("transitionend", onEnd);
                }
              };
              body.addEventListener("transitionend", onEnd);
            };

            const collapse = () => {
              // from current natural height to 0
              if (
                getComputedStyle(body).height === "auto" ||
                body.style.height === "" ||
                body.style.height === "auto"
              ) {
                body.style.height = `${body.scrollHeight}px`;
                void body.offsetHeight;
              }
              body.style.height = "0px";
              body.style.opacity = "0";
              card.classList.add("collapsed");
            };

            const toggle = () => {
              const nowCollapsed = !card.classList.contains("collapsed");
              if (nowCollapsed) {
                collapse();
                localStorage.setItem(key, "1");
                header.setAttribute("aria-expanded", "false");
              } else {
                expand();
                localStorage.setItem(key, "0");
                header.setAttribute("aria-expanded", "true");
              }
            };

            header.addEventListener("click", toggle);
            header.addEventListener("keydown", (e) => {
              if (e.key === "Enter" || e.key === " ") {
                e.preventDefault();
                toggle();
              }
            });
          });
      }

      // Resize sidebar brand logo to match title width (desktop)
      function sizeBrandLogo() {
        const logo = $("brandLogo");
        const title = $("brandTitle");
        if (!logo || !title) return;
        try {
          const w = title.offsetWidth || 0;
          logo.style.height = "auto";
          if (w > 0) {
            logo.style.width = w + "px";
          }
          logo.style.marginBottom = "4px";
        } catch (_) {}
      }

      // --- Events and init ---
      function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        switch (form.id) {
          case "assetForm": {
            const newAsset = {
              name: form.assetName.value,
              value: parseFloat(form.assetValue.value),
              originalDeposit: parseFloat(form.depositAmount.value) || 0,
              frequency: form.depositFrequency.value,
              dateAdded: Date.now(),
            };
            const ret = parseFloat(form.assetReturn.value) || 0;
            newAsset.return = ret;
            newAsset.lowGrowth = parseFloat(form.lowGrowth.value) || ret;
            newAsset.highGrowth = parseFloat(form.highGrowth.value) || ret;
            newAsset.monthlyDeposit = monthlyFrom(
              newAsset.frequency,
              newAsset.originalDeposit,
            );
            const explicitAssetStart = toTimestamp(form.assetStartDate?.value);
            newAsset.explicitStartDate = explicitAssetStart;
            newAsset.startDate = explicitAssetStart ?? startOfToday();
            newAsset.includeInPassive = form.includePassive
              ? !!form.includePassive.checked
              : true;
            assets.push(newAsset);
            renderAssets();
            updateWealthChart();
            updateEmptyStates();
            form.reset();
            break;
          }
          case "liabilityForm": {
            const newLiab = {
              name: form.liabilityName.value,
              value: parseFloat(form.liabilityValue.value) || 0,
              interest: parseFloat(form.liabilityInterest.value) || 0,
              originalPayment:
                parseFloat(form.liabilityPaymentAmount.value) || 0,
              frequency: form.liabilityPaymentFrequency.value,
              dateAdded: Date.now(),
            };
            newLiab.monthlyPayment = monthlyFrom(
              newLiab.frequency,
              newLiab.originalPayment,
            );
            const explicitLiabStart = toTimestamp(form.liabilityStartDate?.value);
            newLiab.explicitStartDate = explicitLiabStart;
            newLiab.startDate = explicitLiabStart ?? startOfToday();
            liabilities.push(newLiab);
            renderLiabilities();
            updateWealthChart();
            updateEmptyStates();
            form.reset();
            break;
          }
          case "eventForm": {
            const ev = {
              name: form.eventName.value,
              amount: parseFloat(form.eventAmount.value),
              isPercent: form.eventType.value === "percent",
              date: new Date(form.eventDate.value).getTime(),
            };
            const assetId = form.eventAsset.value;
            if (assetId) ev.assetId = Number(assetId);
            if (!ev.name || isNaN(ev.amount) || !ev.date) return;
            simEvents.push(ev);
            simEvents.sort((a, b) => a.date - b.date);
            renderEvents();
            updateEmptyStates();
            form.reset();
            break;
          }
          case "fireForm": {
            const amount = parseFloat(form.fireLivingExpenses.value);
            const frequency =
              form.fireExpensesFrequency.value === "monthly"
                ? "monthly"
                : "annual";
            const rate = parseFloat(form.fireWithdrawalRate.value);
            if (!(amount > 0)) {
              showAlert(
                "Enter your living costs to calculate your FIRE target.",
              );
              break;
            }
            if (!(rate > 0)) {
              showAlert("Safe withdrawal rate must be greater than zero.");
              break;
            }
            const annualExpenses =
              frequency === "monthly" ? amount * 12 : amount;
            fireExpenses = annualExpenses;
            fireExpensesFrequency = frequency;
            fireWithdrawalRate = rate;
            fireLastInputs = {
              annualExpenses,
              withdrawalRate: fireWithdrawalRate,
            };
            updateFireFormInputs();
            persist();
            refreshFireProjection();
            break;
          }
          case "fireForecastForm": {
            const amount = parseFloat(form.fireForecastLivingCosts.value);
            const frequency =
              form.fireForecastFrequency.value === "monthly"
                ? "monthly"
                : "annual";
            if (!(amount > 0)) {
              showAlert(
                "Enter your living costs to project your FIRE readiness.",
              );
              break;
            }
            const annual = frequency === "monthly" ? amount * 12 : amount;
            const inflationVal = parseFloat(form.fireForecastInflation.value);
            const inflation = isFinite(inflationVal)
              ? Math.max(0, inflationVal)
              : fireForecastInflation;
            const retireInput = form.fireForecastRetireDate.value;
            let retireTs = null;
            if (retireInput) {
              const parts = retireInput.split("-");
              if (parts.length === 3) {
                const [year, month, day] = parts.map(Number);
                if (Number.isFinite(year) && Number.isFinite(month) && Number.isFinite(day)) {
                  const retireDate = new Date(year, month - 1, day);
                  retireDate.setHours(0, 0, 0, 0);
                  if (!Number.isNaN(retireDate.getTime())) {
                    retireTs = retireDate.getTime();
                  }
                }
              }
            }
            fireForecastCosts = annual;
            fireForecastFrequency = frequency;
            fireForecastInflation = inflation;
            fireForecastRetireDate = retireTs;
            updateFireForecastInputs();
            persist();
            updateFireForecastCard();
            break;
          }
          case "stressTestForm": {
            const runs = parseInt(form.stressRuns.value) || 100;
            const scenario = form.stressScenario.value;
            if (goalValue <= 0 || !goalTargetDate || assets.length === 0) {
              $("stressTestResult").innerHTML =
                '<p class="text-red-600">Add assets, set a goal, and choose a target year before running the stress test.</p>';
              break;
            }
            const selected = [...stressAssetIds];
            if (selected.length === 0) {
              $("stressTestResult").innerHTML =
                '<p class="text-red-600">Select at least one asset for the stress test.</p>';
              break;
            }
            const res = runStressTest(runs, scenario, selected);
            const fmt = (d) => {
              if (d)
                return d.toLocaleString("default", {
                  month: "short",
                  year: "numeric",
                });
              const y = getGoalTargetYear();
              return y ? `Not met by ${y}` : "Not met in 30 years";
            };
            const scenarioLabel =
              {
                low: "Low Growth",
                base: "Expected Growth",
                high: "High Growth",
              }[scenario] || "Expected Growth";
            const cls = (d) => (d ? "text-green-500" : "text-red-600");
            const horizonText = (() => {
              const y = getGoalTargetYear();
              return y ? `by ${y}` : "within 30 years";
            })();
            let html = `<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-3 text-left text-sm text-gray-600 dark:text-gray-300">
              <strong>${res.pct.toFixed(0)}% of simulations reached the goal ${horizonText}</strong>
            </div>
            <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box">
              <h5 class="font-bold text-gray-900 dark:text-gray-100">Earliest</h5>
              <p class="${cls(res.earliest)}">${fmt(res.earliest)}</p>
            </div>
            <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box">
              <h5 class="font-bold text-gray-900 dark:text-gray-100">Median</h5>
              <p class="${cls(res.median)}">${fmt(res.median)}</p>
            </div>
            <div class="p-3 rounded-lg bg-gray-100 dark:bg-gray-700 text-center stat-box">
              <h5 class="font-bold text-gray-900 dark:text-gray-100">Latest</h5>
              <p class="${cls(res.latest)}">${fmt(res.latest)}</p>
            </div>
          </div>`;
            stressSampleEvents = res.sample.events;
            stressSort = { key: "date", dir: "asc" };
            html += `<div id="stressEventsCard" class="card is-collapsible collapsed mt-4">
            <h4 class="text-md font-medium text-gray-900 dark:text-gray-100">Sample events</h4>
            <div class="card-body">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-left">
                  <thead id="stressEventsTableHeader" class="bg-gray-200 dark:bg-gray-700"></thead>
                  <tbody id="stressEventsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
              </div>
            </div>
          </div>`;
            const resEl = $("stressTestResult");
            resEl.className = "mt-4 text-sm";
            resEl.innerHTML = html;
            buildStressHeader();
            renderStressEvents();
            setupCardCollapsing();
            break;
          }
          case "futureValueForm": {
            const assetId = form.fvAsset.value;
            const dateStr = form.fvDate.value;
            const asset = assets.find((a) => a.dateAdded == assetId);
            if (!asset || !dateStr) {
              showAlert("Please select an asset and future date.");
              break;
            }
            const target = new Date(dateStr);
            const now = new Date();
            if (target <= now) {
              showAlert("Please pick a future date.");
              break;
            }
            const years = (target - now) / (1000 * 60 * 60 * 24 * 365.25);
            const principal = calculateCurrentValue(asset);
            const monthly = asset.monthlyDeposit || 0;
            const low = calculateFutureValue(
              principal,
              monthly,
              asset.lowGrowth || 0,
              years,
            );
            const exp = calculateFutureValue(
              principal,
              monthly,
              asset.return || 0,
              years,
            );
            const high = calculateFutureValue(
              principal,
              monthly,
              asset.highGrowth || 0,
              years,
            );
            $("fvLow").textContent = fmtGBP(low);
            $("fvExpected").textContent = fmtGBP(exp);
            $("fvHigh").textContent = fmtGBP(high);
            const res = $("fvResult");
            if (res) res.classList.remove("hidden");
            break;
          }
          case "simpleInterestForm": {
            const P = +$("si-principal").value,
              R = +$("si-rate").value,
              T = +$("si-years").value;
            const annual = P * (R / 100);
            const totalInterest = annual * T;
            const total = P + totalInterest;
            const daily = annual / 365.25;
            const weekly = annual / 52;
            const monthly = annual / 12;
            $("simpleInterestResult").innerHTML = `
            <div class="mt-4">
              <p class="text-lg font-semibold mb-2">Future Value: ${fmtGBP(total)}</p>
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-left">
              <thead class="bg-gray-200 dark:bg-gray-700">
                <tr>
                  <th class="table-header">Period</th>
                  <th class="table-header">Interest Accrued</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700 text-sm text-left">
                <tr><td class="px-6 py-3">Daily</td><td class="px-6 py-3">${fmtGBP(daily)}</td></tr>
                <tr><td class="px-6 py-3">Weekly</td><td class="px-6 py-3">${fmtGBP(weekly)}</td></tr>
                <tr><td class="px-6 py-3">Monthly</td><td class="px-6 py-3">${fmtGBP(monthly)}</td></tr>
                <tr><td class="px-6 py-3">Yearly</td><td class="px-6 py-3">${fmtGBP(annual)}</td></tr>
              </tbody>
            </table>
          </div>
        </div>`;
            break;
          }

          case "stockProfitForm": {
            const price = +$("stock-price").value,
              tax = +$("sdrt-tax").value,
              target = +$("target-return").value;
            const salePrice = price * (1 + tax / 100) * (1 + target / 100);
            $("stockProfitResult").innerHTML =
              `<p class="text-xl font-bold mt-2">Required Sale Price: ${salePrice.toFixed(2)}p</p>`;
            break;
          }

          case "stockProfitAmountForm": {
            const price = +$("stock-price-profit").value,
              tax = +$("sdrt-tax-profit").value,
              shares = +$("stock-shares-profit").value,
              profit = +$("target-profit").value;
            const costPerShare = (price / 100) * (1 + tax / 100);
            const totalCost = costPerShare * shares;
            const salePrice = ((totalCost + profit) / shares) * 100;
            const returnPct = (profit / totalCost) * 100;
            $("stockProfitAmountResult").innerHTML = `
            <p class="text-xl font-bold mt-2">Required Sale Price: ${salePrice.toFixed(2)}p</p>
            <p class="text-lg mt-1">Return: ${returnPct.toFixed(2)}%</p>`;
            break;
          }

          case "compoundForm": {
            const p = +$("ci-principal").value,
              r = +$("ci-rate").value,
              t = +$("ci-years").value,
              c = +$("ci-contribution").value;
            const freq =
              ($("ci-frequency") && $("ci-frequency").value) || "monthly";
            const perYearMap = {
              daily: 365,
              weekly: 52,
              monthly: 12,
              yearly: 1,
            };
            const m = perYearMap[freq] || 12;
            const fv = calculateFutureValueFreq(p, c, r, t, m);
            const totalContrib = p + c * (t * m);
            const totalInterest = fv - totalContrib;
            const yearly = totalInterest / (t || 1);
            const monthly = totalInterest / ((t || 1) * 12);
            const weekly = totalInterest / ((t || 1) * 52);
            const daily = totalInterest / ((t || 1) * 365.25);
            $("compoundResult").innerHTML = `
            <div class="mt-4">
              <p class="text-lg font-semibold mb-2">Future Value: ${fmtGBP(fv)}</p>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-left">
              <thead class="bg-gray-200 dark:bg-gray-700">
                <tr>
                  <th class="table-header">Period</th>
                  <th class="table-header">Interest Accrued (avg)</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700 text-sm text-left">
                <tr><td class="px-6 py-3">Daily</td><td class="px-6 py-3">${fmtGBP(daily)}</td></tr>
                <tr><td class="px-6 py-3">Weekly</td><td class="px-6 py-3">${fmtGBP(weekly)}</td></tr>
                <tr><td class="px-6 py-3">Monthly</td><td class="px-6 py-3">${fmtGBP(monthly)}</td></tr>
                <tr><td class="px-6 py-3">Yearly</td><td class="px-6 py-3">${fmtGBP(yearly)}</td></tr>
              </tbody>
            </table>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">Compound calculator shows average interest per period over the full term.</p>
        </div>`;
            break;
          }
        }
      }

      window.addEventListener("load", () => {
        // Generate light/dark favicons from the inline #app-logo symbol
        (function generateFavicons() {
          const sym = document.getElementById("app-logo");
          if (!sym) return;
          const vb = sym.getAttribute("viewBox") || "0 0 1024 1024";
          const content = sym.innerHTML;
          const makeSvg = (fill) =>
            `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${vb}" fill="${fill}">${content}</svg>`;
          const makeLink = (media, svgStr) => {
            const blob = new Blob([svgStr], { type: "image/svg+xml" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("link");
            link.rel = "icon";
            link.type = "image/svg+xml";
            if (media) link.media = media;
            link.href = url;
            document.head.appendChild(link);
          };
          // Dark mode: white icon; Light mode: near-black icon
          makeLink("(prefers-color-scheme: dark)", makeSvg("#ffffff"));
          makeLink("(prefers-color-scheme: light)", makeSvg("#111827"));
        })();

        $("goalValue").value = goalValue || "";
        $("goalYear").value = goalTargetDate
          ? new Date(goalTargetDate).getFullYear()
          : "";
        updateGoalButton();

        Chart.register(ChartZoom);
        Chart.register(LegendPad);
        Chart.defaults.font.family = "Inter";
        const isDark = document.documentElement.classList.contains("dark");
        $("themeToggle").checked = isDark;
        Chart.defaults.color = isDark ? "#ffffff" : "#374151";

        // Apply saved theme choice
        (function () {
          const choice = localStorage.getItem(LS.themeChoice) || "default";
          applyThemeChoice(choice);
        })();

        buildAssetHeader();
        renderAssets();
        renderLiabilities();
        renderEvents();
        renderSnapshots();
        updateEmptyStates();
        renderProfileOptions();
        updateFireFormInputs();
        refreshFireProjection();
        on($("profileSelect"), "change", (e) => switchProfile(e.target.value));
        const inflEl = $("inflationRate");
        if (inflEl) inflEl.value = inflationRate;
        const inflForm = $("inflationForm");
        if (inflForm)
          on(inflForm, "submit", (e) => {
            e.preventDefault();
            const val = parseFloat($("inflationRate").value);
            inflationRate = isFinite(val) ? val : 2.5;
            saveCurrentProfile();
            persist();
            updateInflationImpactCard();
          });
        const addProfileHandler = () => {
          showPrompt("New profile name", "", (name) =>
            addProfile(name || `Profile ${profiles.length + 1}`),
          );
        };
        const renameProfileHandler = () => {
          showPrompt("Edit profile name", activeProfile?.name || "", (name) =>
            renameActiveProfile(name),
          );
        };
        const deleteProfileHandler = () => {
          if (profiles.length <= 1) {
            showAlert("At least one profile is required.");
            return;
          }
          showConfirm(
            `Delete profile "${activeProfile?.name || ""}"?`,
            () => deleteActiveProfile(),
          );
        };
        ["addProfileBtn", "addProfileBtnMobile"].forEach((id) => {
          const el = $(id);
          if (el) on(el, "click", addProfileHandler);
        });
        ["renameProfileBtn", "renameProfileBtnMobile"].forEach((id) => {
          const el = $(id);
          if (el) on(el, "click", renameProfileHandler);
        });
        ["deleteProfileBtn", "deleteProfileBtnMobile"].forEach((id) => {
          const el = $(id);
          if (el) on(el, "click", deleteProfileHandler);
        });

        // Hide Start Now if returning user (has at least one asset)
        const startBtn = $("startNowBtn");
        if (startBtn)
          startBtn.classList.toggle(
            "hidden",
            assets.length > 0 || liabilities.length > 0,
          );
        updatePassiveIncome();

        // Mobile menu
        const sidebar = $("sidebar"),
          overlay = $("overlay");
        const toggleMenu = () => {
          sidebar.classList.toggle("-translate-x-full");
          overlay.classList.toggle("hidden");
        };
        on($("menu-toggle"), "click", toggleMenu);
        on(overlay, "click", toggleMenu);

        const brandHome = $("brandHome");
        if (brandHome)
          on(brandHome, "click", () => {
            const seen = localStorage.getItem(LS.welcome) === "1";
            const disabled = localStorage.getItem(LS.welcomeDisabled) === "1";
            if (!seen && !disabled) {
              navigateTo("welcome");
              try {
                localStorage.setItem(LS.welcome, "1");
              } catch (_) {}
            } else {
              navigateTo("data-entry");
            }
            if (window.innerWidth < 768) toggleMenu();
          });

        // Global click handlers (nav, tabs, actions, modal close)
        on(document, "click", (e) => {
          // Sortable asset table headers
          const sortTh = e.target.closest("#assetTableHeader th[data-sort]");
          if (sortTh) {
            const key = sortTh.dataset.sort;
            if (assetSort.key === key)
              assetSort.dir = assetSort.dir === "asc" ? "desc" : "asc";
            else {
              assetSort.key = key;
              assetSort.dir = "asc";
            }
            buildAssetHeader();
            renderAssets();
            return;
          }
          const stressTh = e.target.closest(
            "#stressEventsTableHeader th[data-sort]",
          );
          if (stressTh) {
            const key = stressTh.dataset.sort;
            if (stressSort.key === key)
              stressSort.dir = stressSort.dir === "asc" ? "desc" : "asc";
            else {
              stressSort.key = key;
              stressSort.dir = "asc";
            }
            buildStressHeader();
            renderStressEvents();
            return;
          }
          const navBtn = e.target.closest("nav button[data-target]");
          if (navBtn) {
            navigateTo(navBtn.dataset.target);
            if (window.innerWidth < 768) toggleMenu();
          }

          const tabBtn = e.target.closest(".tab-btn[data-tab-target]");
          if (tabBtn) {
            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("tab-btn-active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((c) => c.classList.add("hidden"));
            tabBtn.classList.add("tab-btn-active");
            $(tabBtn.dataset.tabTarget).classList.remove("hidden");
          }

          if (e.target.closest('[data-action="close-modal"]')) closeModal();

          if (
            !e.target.closest("[data-snapshot-menu]") &&
            !e.target.closest('[data-action="toggle-snapshot-actions"]')
          ) {
            closeSnapshotActionMenus();
          }

          const action = e.target.closest("[data-action]");
          if (action) {
            const { action: act, index } = action.dataset;

            switch (act) {
              case "create-profile":
                {
                  showPrompt("New profile name", "", (name) =>
                    addProfile(name || `Profile ${profiles.length + 1}`),
                  );
                }
                break;
              case "edit-asset":
                showEditAsset(+index);
                break;
              case "edit-liability":
                showEditLiability(+index);
                break;
              case "delete-asset":
                showConfirm(
                  "Are you sure you want to delete this asset?",
                  () => {
                    assets.splice(+index, 1);
                    renderAssets();
                    renderEvents();
                    updateWealthChart();
                    updateEmptyStates();
                  },
                );
                break;
              case "delete-liability":
                showConfirm(
                  "Are you sure you want to delete this liability?",
                  () => {
                    liabilities.splice(+index, 1);
                    renderLiabilities();
                    updateWealthChart();
                    updateEmptyStates();
                  },
                );
                break;
              case "view-snapshot":
                {
                  closeSnapshotActionMenus();
                  const s = snapshots[+index];
                  if (s) showSnapshotDetails(s);
                }
                break;
              case "rename-snapshot":
                {
                  closeSnapshotActionMenus();
                  const snap = snapshots[+index];
                  if (!snap) break;
                  showPrompt("Rename snapshot", snap.name, (name) => {
                    const newName = name || snap.name;
                    if (!newName) return;
                    snap.name = newName;
                    persist();
                    renderSnapshots();
                  });
                }
                break;
              case "delete-snapshot":
                closeSnapshotActionMenus();
                showConfirm(
                  "Are you sure you want to delete this snapshot?",
                  () => {
                    snapshots.splice(+index, 1);
                    persist();
                    renderSnapshots();
                    updateEmptyStates();
                  },
                );
                break;
              case "toggle-snapshot-actions":
                {
                  const menu = document.querySelector(
                    `[data-snapshot-menu="${index}"]`,
                  );
                  if (!menu) break;
                  const shouldOpen = menu.classList.contains("hidden");
                  closeSnapshotActionMenus();
                  if (shouldOpen) {
                    menu.classList.remove("hidden");
                    action.setAttribute("aria-expanded", "true");
                  }
                }
                break;
              case "edit-event":
                showEditEvent(+index);
                break;
              case "delete-event":
                showConfirm(
                  "Are you sure you want to delete this event?",
                  () => {
                    simEvents.splice(+index, 1);
                    renderEvents();
                    updateEmptyStates();
                  },
                );
                break;
              case "take-snapshot":
                {
                  const input = $("snapshotName");
                  if (!input.checkValidity()) {
                    input.reportValidity();
                    return;
                  }
                  if (assets.length === 0) {
                    showAlert(
                      "Add at least one asset before saving a snapshot.",
                    );
                    return;
                  }
                  const name = input.value.trim();
                  const detailed = assets.map((a) => ({
                    name: a.name,
                    value: calculateCurrentValue(a),
                  }));
                  const total = detailed.reduce((sum, a) => sum + a.value, 0);
                  snapshots.push({
                    name,
                    date: new Date().toISOString(),
                    value: total,
                    assets: detailed,
                    forecast: getSnapshotForecastSeries(),
                  });
                  persist();
                  renderSnapshots();
                  updateEmptyStates();
                  input.value = "";
                  showAlert("Snapshot taken successfully");
                }
                break;

              case "export-data":
                {
                  persist();
                  const hasAny = profiles.some(
                    (p) =>
                      p.assets.length > 0 ||
                      p.liabilities?.length > 0 ||
                      p.snapshots.length > 0 ||
                      p.simEvents.length > 0,
                  );
                  if (!hasAny) {
                    showAlert(
                      "No data to export yet. Add assets, liabilities, events, or snapshots first.",
                    );
                    return;
                  }
                  const password = $("exportPassword").value;
                  const dataToExport = {
                    profiles,
                    activeProfileId: activeProfile?.id,
                  };
                  let payload = JSON.stringify(dataToExport);
                  if (password)
                    payload = CryptoJS.AES.encrypt(
                      payload,
                      password,
                    ).toString();
                  const blob = new Blob([payload], {
                    type: "application/json",
                  });
                  const url = URL.createObjectURL(blob);
                  const now = new Date();
                  const pad = (n) => String(n).padStart(2, "0");
                  const dateStr = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = `wealthtrack-data-${dateStr}.json`;
                  a.click();
                  URL.revokeObjectURL(url);
                  showAlert("Data exported successfully");
                }
                break;

              case "import-data":
                {
                  const fi = $("importFile");
                  if (fi.files.length === 0) {
                    showAlert("Please select a file to import first.");
                    return;
                  }
                  const file = fi.files[0];
                  const reader = new FileReader();
                  reader.onload = (ev) => {
                    try {
                      const password = $("importPassword").value;
                      let json = ev.target.result;
                      if (password) {
                        const bytes = CryptoJS.AES.decrypt(json, password);
                        json = bytes.toString(CryptoJS.enc.Utf8);
                      }
                      if (!json)
                        throw new Error("Decryption failed or file is empty.");
                      const data = JSON.parse(json);
                      if (data.profiles) {
                        profiles = data.profiles;
                        profiles.forEach((p) => {
                          if (p.goalTargetDate == null) p.goalTargetDate = null;
                          if (p.fireExpenses == null) p.fireExpenses = 0;
                          p.fireExpensesFrequency =
                            p.fireExpensesFrequency === "monthly"
                              ? "monthly"
                              : "annual";
                          if (!(p.fireWithdrawalRate > 0)) p.fireWithdrawalRate = 4;
                          if (!(p.fireProjectionYears > 0)) p.fireProjectionYears = 30;
                          if (p.fireForecastCosts == null)
                            p.fireForecastCosts = 0;
                          p.fireForecastFrequency =
                            p.fireForecastFrequency === "monthly"
                              ? "monthly"
                              : "annual";
                          if (!(p.fireForecastInflation >= 0))
                            p.fireForecastInflation = 2.5;
                          if (
                            p.fireForecastRetireDate != null &&
                            !isFinite(p.fireForecastRetireDate)
                          )
                            p.fireForecastRetireDate = null;
                        });
                        activeProfile =
                          profiles.find((p) => p.id == data.activeProfileId) ||
                          profiles[0];
                      } else {
                        const id = Date.now();
                        profiles = [
                          {
                            id,
                            name: "Imported",
                            assets: data.assets || [],
                            liabilities: data.liabilities || [],
                            snapshots: data.snapshots || [],
                            simEvents: data.simEvents || [],
                            goalValue: data.goalValue || 0,
                            goalTargetDate: data.goalTargetDate || null,
                            fireExpenses: data.fireExpenses || 0,
                            fireExpensesFrequency:
                              data.fireExpensesFrequency === "monthly"
                                ? "monthly"
                                : "annual",
                            fireWithdrawalRate:
                              data.fireWithdrawalRate > 0
                                ? data.fireWithdrawalRate
                                : 4,
                            fireProjectionYears:
                              data.fireProjectionYears > 0
                                ? data.fireProjectionYears
                                : 30,
                            fireForecastCosts:
                              data.fireForecastCosts != null
                                ? data.fireForecastCosts
                                : 0,
                            fireForecastFrequency:
                              data.fireForecastFrequency === "monthly"
                                ? "monthly"
                                : "annual",
                            fireForecastInflation:
                              data.fireForecastInflation >= 0
                                ? data.fireForecastInflation
                                : 2.5,
                            fireForecastRetireDate:
                              data.fireForecastRetireDate &&
                              isFinite(data.fireForecastRetireDate)
                                ? data.fireForecastRetireDate
                                : null,
                          },
                        ];
                        activeProfile = profiles[0];
                      }
                      assets = activeProfile.assets || [];
                      liabilities = activeProfile.liabilities || [];
                      snapshots = activeProfile.snapshots || [];
                      simEvents = activeProfile.simEvents || [];
                      goalValue = activeProfile.goalValue || 0;
                      goalTargetDate = activeProfile.goalTargetDate || null;
                      fireExpenses =
                        activeProfile.fireExpenses != null
                          ? activeProfile.fireExpenses
                          : 0;
                      fireExpensesFrequency =
                        activeProfile.fireExpensesFrequency === "monthly"
                          ? "monthly"
                          : "annual";
                      fireWithdrawalRate =
                        activeProfile.fireWithdrawalRate > 0
                          ? activeProfile.fireWithdrawalRate
                          : 4;
                      fireProjectionYears =
                        activeProfile.fireProjectionYears && activeProfile.fireProjectionYears > 0
                          ? activeProfile.fireProjectionYears
                          : 30;
                      fireLastInputs =
                        fireExpenses > 0 && fireWithdrawalRate > 0
                          ? {
                              annualExpenses: fireExpenses,
                              withdrawalRate: fireWithdrawalRate,
                            }
                          : null;
                      fireForecastCosts =
                        activeProfile.fireForecastCosts != null
                          ? activeProfile.fireForecastCosts
                          : 0;
                      fireForecastFrequency =
                        activeProfile.fireForecastFrequency === "monthly"
                          ? "monthly"
                          : "annual";
                      fireForecastInflation =
                        activeProfile.fireForecastInflation >= 0
                          ? activeProfile.fireForecastInflation
                          : 2.5;
                      fireForecastRetireDate =
                        activeProfile.fireForecastRetireDate &&
                        isFinite(activeProfile.fireForecastRetireDate)
                          ? activeProfile.fireForecastRetireDate
                          : null;
                      activeProfile.fireForecastCosts = fireForecastCosts;
                      activeProfile.fireForecastFrequency = fireForecastFrequency;
                      activeProfile.fireForecastInflation = fireForecastInflation;
                      activeProfile.fireForecastRetireDate = fireForecastRetireDate;
                      $("goalValue").value = goalValue || "";
                      $("goalYear").value = goalTargetDate
                        ? new Date(goalTargetDate).getFullYear()
                        : "";
                      updateFireFormInputs();
                      updateFireForecastInputs();
                      updateGoalButton();
                      normalizeData();
                      renderAssets();
                      renderLiabilities();
                      renderEvents();
                      renderSnapshots();
                      updateWealthChart();
                      updateSnapshotChart();
                      renderAssetBreakdownChart();
                      updatePassiveIncome();
                      updateEmptyStates();
                      refreshFireProjection();
                      updateFireForecastCard();
                      persist();
                      renderProfileOptions();
                      showAlert("Data imported successfully", () => {
                        navigateTo("data-entry");
                        updateEmptyStates();
                      });
                    } catch (err) {
                      console.error(err);
                      showAlert(
                        "Error importing file. Check password or file format.",
                      );
                    }
                  };
                  reader.readAsText(file);
                }
                break;
              case "clear-data":
                showConfirm(
                  "This will erase all locally stored data. Continue?",
                  () => {
                    localStorage.clear();
                    location.reload();
                  }
                );
                break;
            }
          }
        });

        // Apply saved theme on load (default to light)
        try {
          const saved = localStorage.getItem(LS.theme);
          const initialDark = saved === "1";
          document.documentElement.classList.toggle("dark", initialDark);
          if ($("themeToggle")) $("themeToggle").checked = initialDark;
          if (typeof Chart !== "undefined") {
            Chart.defaults.color = initialDark ? "#ffffff" : "#374151";
          }
          // Ensure any already-initialized charts pick up the correct theme
          try {
            updateChartTheme();
          } catch (_) {}
        } catch (_) {}

        on($("themeToggle"), "change", (e) => {
          const isDark = !!e.target.checked;
          document.documentElement.classList.add("theme-transition");
          document.documentElement.classList.toggle("dark", isDark);
          setTimeout(
            () => document.documentElement.classList.remove("theme-transition"),
            500
          );
          try {
            localStorage.setItem(LS.theme, isDark ? "1" : "0");
          } catch (_) {}
          updateChartTheme();
        });
        on($("goalBtn"), "click", () => {
          goalValue = parseFloat($("goalValue").value) || 0;
          const yr = parseInt($("goalYear").value);
          goalTargetDate = yr ? new Date(yr, 11, 31).getTime() : null;
          persist();
          updateWealthChart();
          updateEmptyStates();
          updateGoalButton();
        });
        const importInput = $("importFile");
        if (importInput)
          on(importInput, "change", (e) => {
            const name = e.target.files[0]?.name || "No file chosen";
            document
              .querySelectorAll("[data-import-filename]")
              .forEach((el) => (el.textContent = name));
          });
        // Theme choice handlers
        const themeSel = document.getElementById("themeSelect");
        if (themeSel)
          on(themeSel, "change", (e) => applyThemeChoice(e.target.value));

        // Welcome page toggle
        const welcomeToggle = $("welcomeToggle");
        const welcomeDisabled =
          localStorage.getItem(LS.welcomeDisabled) === "1";
        const welcomeBtn = document.querySelector(
          'nav button[data-target="welcome"]',
        );
        if (welcomeBtn) welcomeBtn.classList.toggle("hidden", welcomeDisabled);
        if (welcomeToggle) {
          welcomeToggle.checked = !welcomeDisabled;
          on(welcomeToggle, "change", (e) => {
            const hide = !e.target.checked;
            try {
              localStorage.setItem(LS.welcomeDisabled, hide ? "1" : "0");
            } catch (_) {}
            if (welcomeBtn) welcomeBtn.classList.toggle("hidden", hide);
            if (hide && $("welcome").classList.contains("active"))
              navigateTo("data-entry");
          });
        }

        // Enable collapsible cards
        setupCardCollapsing();

        // Brand logo sizing
        sizeBrandLogo();
        on(window, "resize", sizeBrandLogo);

        // Form submissions
        document
          .querySelectorAll("form")
          .forEach((f) => on(f, "submit", handleFormSubmit));
        const stressToggle = $("stressAssetsToggle");
        const stressMenu = $("stressAssetsMenu");
        if (stressToggle && stressMenu) {
          on(stressToggle, "click", () => stressMenu.classList.toggle("hidden"));
          on(stressMenu, "change", (e) => {
            const cb = e.target;
            if (cb && cb.type === "checkbox") {
              const id = Number(cb.dataset.id);
              if (cb.checked) stressAssetIds.add(id);
              else stressAssetIds.delete(id);
              updateStressAssetsButtonLabel();
            }
          });
          on(document, "click", (e) => {
            if (
              !stressMenu.contains(e.target) &&
              e.target !== stressToggle &&
              !stressToggle.contains(e.target)
            ) {
              stressMenu.classList.add("hidden");
            }
          });
        }
        const fvDate = $("fvDate");
        if (fvDate) fvDate.min = new Date().toISOString().split("T")[0];
        // First-run welcome routing
        const seen = localStorage.getItem(LS.welcome) === "1";
        if (!seen && !welcomeDisabled) {
          navigateTo("welcome");
          localStorage.setItem(LS.welcome, "1");
        } else {
          navigateTo("data-entry");
        }

        // Welcome buttons
        document.addEventListener("click", (e) => {
          const btn = e.target.closest("[data-action]");
          if (!btn) return;
          switch (btn.dataset.action) {
            case "start-now":
              localStorage.setItem(LS.onboardPending, "1");
              navigateTo("data-entry");
              break;
            case "focus-asset-form":
              {
                closeModal();
                navigateTo("data-entry");
                const el = $("assetName");
                if (el) {
                  try {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                    el.focus({ preventScroll: true });
                  } catch (_) {
                    el.focus();
                  }
                }
              }
              break;
            case "focus-goal":
              {
                closeModal();
                navigateTo("data-entry");
                const el = $("goalValue");
                if (el) {
                  try {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                    el.focus({ preventScroll: true });
                  } catch (_) {
                    el.focus();
                  }
                }
              }
              break;
            case "go-assets":
              closeModal();
              navigateTo("data-entry");
              break;
            case "go-forecasts":
              closeModal();
              navigateTo("forecasts");
              break;
            case "go-insights":
              closeModal();
              navigateTo("portfolio-analysis");
              break;
            case "go-settings":
              closeModal();
              navigateTo("settings");
              break;
            case "open-tour":
              {
                const tpl = document.importNode($("tpl-quick-tour").content, true);
                openModalNode(tpl);
              }
              break;
            case "load-demo":
              loadDemoData();
              break;
            case "close-modal":
              closeModal();
              break;
          }
        });
      });
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("service-worker.js")
            .catch((error) => {
              console.error("Service worker registration failed:", error);
            });
        });
      }
    </script>
  </body>
</html>
