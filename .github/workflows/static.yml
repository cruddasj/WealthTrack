# Simple workflow for deploying static content to GitHub Pages
name: Deploy static content to Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["main"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Single deploy job since we're just deploying
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Determine Next Version
        id: determine_version
        run: |
          LATEST_TAG=$(git tag -l "v*" --sort=-v:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            NEXT_VERSION="1.0.0"
          else
            VERSION_NUM=${LATEST_TAG#v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
            NEXT_PATCH=$((PATCH + 1))
            NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH"
          fi
          echo "version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEXT_VERSION" >> "$GITHUB_OUTPUT"
      - name: Replace Placeholders
        run: |
          NEXT_VERSION="${{ steps.determine_version.outputs.version }}"
          NEXT_DATE=$(date +'%Y-%m-%d')

          if [ -f "CHANGELOG.md" ]; then
            sed -i "s/\[NEXT_VERSION\]/$NEXT_VERSION/g" CHANGELOG.md
            sed -i "s/\[NEXT_DATE\]/$NEXT_DATE/g" CHANGELOG.md
          fi

          if [ -f "assets/changelog.json" ]; then
            sed -i "s/\[NEXT_VERSION\]/$NEXT_VERSION/g" assets/changelog.json
            sed -i "s/\[NEXT_DATE\]/$NEXT_DATE/g" assets/changelog.json
          fi

          if [ -f "assets/version.json" ]; then
            jq ".version = \"$NEXT_VERSION\"" assets/version.json > tmp.json && mv tmp.json assets/version.json
          fi

          if [ -f "service-worker.js" ]; then
            sed -i "s/const APP_VERSION = .*/const APP_VERSION = \"$NEXT_VERSION\";/" service-worker.js
          fi

          if [ -f "package.json" ]; then
            jq ".version = \"$NEXT_VERSION\"" package.json > tmp_pkg.json && mv tmp_pkg.json package.json
          fi
      - name: Commit and Push Bumped Version
        id: commit_version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md assets/changelog.json assets/version.json service-worker.js package.json
          if git diff --cached --quiet; then
            echo "No version changes detected."
            echo "commitish=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore: bump version to v${{ steps.determine_version.outputs.version }}"
            git push origin HEAD:${{ github.ref }}
            echo "commitish=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          fi
      - name: Check existing tag
        id: tagcheck
        run: |
          tag="${{ steps.determine_version.outputs.tag }}"
          if git rev-parse "$tag" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Create tag and release
        if: |
          github.event_name == 'push' &&
          steps.determine_version.outputs.version != '' &&
          !contains(steps.determine_version.outputs.version, '-dev') &&
          steps.tagcheck.outputs.exists != 'true'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.determine_version.outputs.tag }}
          release_name: ${{ steps.determine_version.outputs.tag }}
          body: "Automated release for ${{ steps.determine_version.outputs.version }}"
          commitish: ${{ steps.commit_version.outputs.commitish }}
      - name: Prune old releases
        if: steps.create_release.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const maxReleases = 5;
            const { owner, repo } = context.repo;
            const releases = await github.paginate(
              github.rest.repos.listReleases,
              { owner, repo, per_page: 100 }
            );
            const toDelete = releases
              .filter((release) => !release.draft && !release.prerelease)
              .slice(maxReleases);
            for (const release of toDelete) {
              await github.rest.repos.deleteRelease({
                owner,
                repo,
                release_id: release.id,
              });
              if (release.tag_name) {
                try {
                  await github.rest.git.deleteRef({
                    owner,
                    repo,
                    ref: `tags/${release.tag_name}`,
                  });
                } catch (error) {
                  if (error.status !== 404) throw error;
                }
              }
            }
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Build icons
        run: npm run build:icons
      - name: Build CSS
        run: npm run build:css
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          # Upload entire repository
          path: '.'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
